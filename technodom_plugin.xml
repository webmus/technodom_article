<?xml version="1.0" encoding="utf-8"?>
<dleplugin>
    <name>technodom_parser</name>
    <description>–ü–∞—Ä—Å–µ—Ä Technodom ‚Üí GPT ‚Üí DLE (–¥–∞—à–±–æ—Ä–¥, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—å–∏, –ø—É–±–ª–∏–∫–∞—Ü–∏—è)</description>
    <icon></icon>
    <version>0.1.0</version>
    <dleversion></dleversion>
    <versioncompare>greater</versioncompare>
    <upgradeurl></upgradeurl>
    <filedelete>0</filedelete>
    <needplugin></needplugin>
    <mnotice>0</mnotice>
    <mysqlinstall><![CDATA[
INSERT INTO {prefix}_admin_sections (`name`, `title`, `descr`, `icon`, `allow_groups`)
VALUES ('technodom_parser', 'Technodom Parser', 'Technodom Parser', '', '1')
ON DUPLICATE KEY UPDATE
    `title` = VALUES(`title`),
    `descr` = VALUES(`descr`),
    `icon` = VALUES(`icon`),
    `allow_groups` = VALUES(`allow_groups`);
]]></mysqlinstall>
    <mysqlupgrade><![CDATA[]]></mysqlupgrade>
    <mysqlenable><![CDATA[]]></mysqlenable>
    <mysqldisable><![CDATA[]]></mysqldisable>
    <mysqldelete><![CDATA[
DELETE FROM {prefix}_admin_sections WHERE name='technodom_parser';
]]></mysqldelete>
    <phpinstall><![CDATA[
if (!defined('DATALIFEENGINE')) {
    return;
}

$cacheDir = ROOT_DIR . '/td_cache';
if (!is_dir($cacheDir)) {
    @mkdir($cacheDir, 0775, true);
}

$logDir = $cacheDir . '/logs';
if (!is_dir($logDir)) {
    @mkdir($logDir, 0775, true);
}
]]></phpinstall>
    <phpupgrade><![CDATA[]]></phpupgrade>
    <phpenable><![CDATA[]]></phpenable>
    <phpdisable><![CDATA[]]></phpdisable>
    <phpdelete><![CDATA[]]></phpdelete>
    <file name="td_config.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
// === –ö–æ–Ω—Ñ–∏–≥ Technodom ‚Üí GPT ‚Üí DLE ===

// 1) –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞ OpenAI
// –í–ê–†–ò–ê–ù–¢ A: —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
$OPENAI_API_KEY = getenv('OPENAI_API_KEY') ?: '';

// –í–ê–†–ò–ê–ù–¢ B: —á–µ—Ä–µ–∑ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–≤–Ω–µ webroot)
//   $OPENAI_API_KEY = trim(@file_get_contents('/var/secure/openai.key') ?: '');

// Fallback: –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –∞–≤–∞—Ä–∏–π–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–º—Å—è
if (!$OPENAI_API_KEY) {
    http_response_code(500);
    die('OpenAI API key not configured. Set OPENAI_API_KEY env or file.');
}

// 2) –ú–æ–¥–µ–ª—å –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const OPENAI_MODEL   = 'gpt-4o-mini';  // –±—ã—Å—Ç—Ä–æ –∏ –ô; –º–æ–∂–Ω–æ 'gpt-4o'
const OPENAI_BASEURL = 'https://api.openai.com/v1/chat/completions';
const OPENAI_TIMEOUT = 25; // —Å–µ–∫.

// 3) DLE DB (–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–¥ —Å–µ–±—è –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –æ–±—â–∏–π –∫–æ–Ω—Ñ–∏–≥)
const DB_HOST = 'localhost';       // –Ω–∞–ø—Ä–∏–º–µ—Ä, 127.0.0.1
const DB_USER = 'dle_user';       // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î
const DB_PASS = 'dle_password';   // –ø–∞—Ä–æ–ª—å –ë–î
const DB_NAME = 'dle_database';   // –∏–º—è –ë–î
const DB_CHARSET = 'utf8mb4';

// 4) –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
const DEFAULT_DLE_CAT_ID = 9;      // –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const DEFAULT_ALLOW_COMM = 0;      // –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: 0=–∑–∞–ø—Ä–µ—â–µ–Ω—ã
const DEFAULT_ALLOW_MAIN = 1;      // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
const DEFAULT_PUBLISH    = 1;      // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
const DEFAULT_AUTHOR     = 'admin';// –ª–æ–≥–∏–Ω –∞–≤—Ç–æ—Ä–∞ (–¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ DLE)

// 5) –°–ª—É–∂–µ–±–Ω—ã–µ –ø—É—Ç–∏
const CACHE_DIR = __DIR__ . '/td_cache';
@mkdir(CACHE_DIR, 0775, true);
]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="td_gpt.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
require_once __DIR__ . '/td_config.php';

/**
 * –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—å—é —á–µ—Ä–µ–∑ GPT (title, short, full, meta).
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å —Ç–µ–º–∏ –∂–µ –∫–ª—é—á–∞–º–∏, —á—Ç–æ –∏ –≤—Ö–æ–¥, –µ—Å–ª–∏ –≤—Å—ë –æ–∫.
 * –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–µ—Ä–Ω—ë—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–æ–ª—è (—Ñ–æ–ª–ª–±—ç–∫), –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç –ø–æ–º–µ—Ç–∫—É –≤ meta_description.
 */
function td_gpt_rewrite(array $article, string $categoryName, string $slug): array {
    $title       = $article['title']            ?? '';
    $short_story = $article['short_story']      ?? '';
    $full_story  = $article['full_story']       ?? '';
    $meta_title  = $article['meta_title']       ?? '';
    $meta_desc   = $article['meta_description'] ?? '';
    $hashtags    = $article['hashtags']         ?? ($slug . ', –ê–∫—Ç–∞—É');

    // –ü—Ä–æ–º–ø—Ç: –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É; –ø—Ä–æ—Å–∏–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π HTML –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –º—É—Å–æ—Ä–∞
    $system = "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ SEO-–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –ª–∞–∫–æ–Ω–∏—á–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è—è —Ñ–∞–∫—Ç—ã (—Ü–µ–Ω—ã/–±—Ä–µ–Ω–¥—ã/—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏). –í—ã–¥–∞–π —á–∏—Å—Ç—ã–π HTML (–∞–±–∑–∞—Ü—ã <p>, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ <h3>, —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∫ –µ—Å—Ç—å), –±–µ–∑ –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª–µ–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã. –ú–µ—Ç–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ ~70 —Å–∏–º–≤–æ–ª–æ–≤, –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ ~160. –¢–æ–Ω ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π, –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂.";
    $user = [
        "category"     => $categoryName,
        "slug"         => $slug,
        "title"        => $title,
        "short_story"  => $short_story,
        "full_story"   => $full_story,
        "meta_title"   => $meta_title,
        "meta_desc"    => $meta_desc,
        "hashtags"     => $hashtags
    ];

    $payload = [
        "model" => OPENAI_MODEL,
        "temperature" => 0.4,
        "messages" => [
            ["role" => "system", "content" => $system],
            ["role" => "user",   "content" => "–í–æ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –≤ JSON. –ü–µ—Ä–µ–ø–∏—à–∏: –≤–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª—è–º–∏ title, short_story, full_story, meta_title, meta_description, hashtags.\n\n" . json_encode($user, JSON_UNESCAPED_UNICODE)]
        ]
    ];

    $resp = openai_chat($payload);
    if (!$resp || empty($resp['choices'][0]['message']['content'])) {
        // –§–æ–ª–ª–±—ç–∫: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫ —Å –ø–æ–º–µ—Ç–∫–æ–π
        $article['meta_description'] = ($article['meta_description'] ?? '') . ' (auto: fallback)';
        return $article;
    }

    // –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
    $txt = trim($resp['choices'][0]['message']['content']);
    $clean = try_json($txt);
    if (!$clean) {
        // –ò–Ω–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –æ—Ç–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç —Å ```json
        $txt = trim(preg_replace('~^```json|```$~m', '', $txt));
        $clean = try_json($txt);
    }
    if (!$clean) {
        $article['meta_description'] = ($article['meta_description'] ?? '') . ' (auto: parse-fallback)';
        return $article;
    }

    // –°–ª–∏–≤–∞–µ–º, –æ—Å—Ç–∞–≤–ª—è—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    $out = [
        'title'            => $clean['title']            ?? $title,
        'short_story'      => $clean['short_story']      ?? $short_story,
        'full_story'       => $clean['full_story']       ?? $full_story,
        'meta_title'       => $clean['meta_title']       ?? $meta_title,
        'meta_description' => $clean['meta_description'] ?? $meta_desc,
        'hashtags'         => $clean['hashtags']         ?? $hashtags,
    ];

    // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: clean HTML –æ—Ç <script> –∏ –º—É—Å–æ—Ä–∞
    $out['full_story'] = preg_replace('~<script\b[^>]*>.*?</script>~is', '', $out['full_story']);
    return $out;
}

/** –í—ã–∑–æ–≤ OpenAI —Å —Ä–µ—Ç—Ä–∞—è–º–∏ */
function openai_chat(array $payload): ?array {
    global $OPENAI_API_KEY;

    $attempts = 3;
    $sleep    = 1;
    for ($i=0; $i<$attempts; $i++) {
        $ch = curl_init(OPENAI_BASEURL);
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT        => OPENAI_TIMEOUT,
            CURLOPT_CONNECTTIMEOUT => 8,
            CURLOPT_HTTPHEADER     => [
                'Authorization: Bearer ' . $OPENAI_API_KEY,
                'Content-Type: application/json'
            ],
            CURLOPT_POST           => true,
            CURLOPT_POSTFIELDS     => json_encode($payload, JSON_UNESCAPED_UNICODE)
        ]);
        $body = curl_exec($ch);
        $code = (int)curl_getinfo($ch, CURLINFO_RESPONSE_CODE);
        $err  = curl_error($ch);
        curl_close($ch);

        if ($code === 200 && $body) {
            $j = json_decode($body, true);
            if (is_array($j)) return $j;
        }
        // 429/5xx ‚Äî –ø–æ–¥–æ–∂–¥—ë–º –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë
        if (in_array($code, [429,500,502,503,504], true)) {
            usleep($sleep * 1000000);
            $sleep *= 2;
            continue;
        }
        // –ü—Ä–æ—á–∏–µ –æ—à–∏–±–∫–∏ ‚Äî –≤—ã—Ö–æ–¥–∏–º
        return null;
    }
    return null;
}

function try_json(string $s): ?array {
    $j = json_decode($s, true);
    return is_array($j) ? $j : null;
}
]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="td_build_article.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
declare(strict_types=1);

/**
 * td_build_article.php  (v3 ‚Äî HTML preview + JSON)
 * –†–µ–∂–∏–º—ã:
 *   ?ping=1                    ‚Äî –ø–∏–Ω–≥
 *   ?json=1                    ‚Äî —Å—ã—Ä–æ–π JSON
 *   (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)             ‚Äî HTML-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (Bootstrap)
 * –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
 *   slug, name (–æ–ø—Ü.), asc, desc, limit (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10), log=1
 *   –∏–ª–∏ —Ç–æ–ª—å–∫–æ slug ‚Äî asc/desc –ø–æ–¥—Ç—è–Ω—É—Ç—Å—è –∏–∑ CSV (—Å–º. CSV_PATH).
 */

ini_set('display_errors', '0');
error_reporting(E_ALL);

// ---------- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ----------
const CITY_LABEL   = '–ê–∫—Ç–∞—É';
const ATTRIB_TXT   = '–ú–∞—Ç–µ—Ä–∏–∞–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö Technodom (technodom.kz). –¶–µ–Ω—ã –∏ –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å—Å—è. –°—Å—ã–ª–∫–∏ –≤–µ–¥—É—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ Technodom.';
const CSV_PATH     = __DIR__ . '/td_cache/technodom_categories_links.csv';
const LOGS_DIR     = __DIR__ . '/td_cache/logs';
const NAME_CACHE   = __DIR__ . '/td_cache/name_cache.json';
const UA           = 'ArtVisionTD/1.0 (+vaktau.kz)';

// ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
function ok(array $data = []): void {
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode(['ok' => true] + $data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
    exit;
}
function fail(string $msg, array $extra = []): void {
    header('Content-Type: application/json; charset=utf-8');
    http_response_code(400);
    echo json_encode(['ok' => false, 'error' => $msg] + $extra, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
    exit;
}
function ensureDir(string $path): void { if (!is_dir($path)) @mkdir($path, 0775, true); }
function logLine(string $line): void {
    static $enabled = null;
    if ($enabled === null) {
        $enabled = (int)($_GET['log'] ?? 0) === 1;
        if ($enabled) ensureDir(LOGS_DIR);
    }
    if (!$enabled) return;
    $file = LOGS_DIR . '/' . date('Y-m-d') . '.log';
    @file_put_contents($file, '[' . date('H:i:s') . "] " . $line . PHP_EOL, FILE_APPEND);
}
function httpJson(string $url, int $timeout = 25): array {
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_TIMEOUT        => $timeout,
        CURLOPT_CONNECTTIMEOUT => 8,
        CURLOPT_ENCODING       => 'gzip,deflate',
        CURLOPT_HTTPHEADER     => [
            'Accept: application/json',
            'User-Agent: ' . UA,
            'Origin: https://www.technodom.kz',
            'Referer: https://www.technodom.kz/'
        ],
    ]);
    $body = curl_exec($ch);
    $code = (int)curl_getinfo($ch, CURLINFO_RESPONSE_CODE);
    $err  = curl_error($ch);
    curl_close($ch);

    if ($code !== 200 || !$body) {
        logLine("HTTP $code $url :: $err");
        return [];
    }
    $j = json_decode($body, true);
    if (!is_array($j)) return [];
    return $j['payload'] ?? $j;
}
function numberKZT(?int $n): string { return $n === null ? '' : number_format($n, 0, '.', ' ') . ' ‚Ç∏'; }

// ---------- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ----------
function normalizeItems(array $payload): array {
    $list = $payload['items'] ?? $payload;
    if (!is_array($list)) return [];
    $out = [];
    foreach ($list as $p) {
        if (!is_array($p)) continue;
        $imgId = $p['images'][0] ?? null;
        $img   = $imgId ? "https://static.technodom.kz/medias/{$imgId}.jpg" : null;

        $specs = [];
        if (!empty($p['short_description']) && is_array($p['short_description'])) {
            foreach ($p['short_description'] as $s) {
                $k = trim((string)($s['title'] ?? ''));
                $v = trim((string)($s['values'][0]['value_ru'] ?? ''));
                if ($k && $v) $specs[$k] = $v;
            }
        }

        $out[] = [
            'sku'        => (string)($p['sku'] ?? ''),
            'title'      => (string)($p['title'] ?? ''),
            'brand'      => (string)($p['brand'] ?? ($p['brand_info']['title'] ?? '')),
            'price'      => isset($p['price']) ? (int)$p['price'] : null,
            'old_price'  => isset($p['old_price']) ? (int)$p['old_price'] : null,
            'discount'   => isset($p['discount']) ? (int)$p['discount'] : 0,
            'rating'     => $p['rating'] ?? null,
            'reviews'    => $p['reviews'] ?? null,
            'uri'        => (string)($p['uri'] ?? ''),
            'image'      => $img,
            'specs'      => $specs,
        ];
    }
    // –¥–µ–¥—É–ø
    $seen = []; $clean = [];
    foreach ($out as $it) {
        $k = $it['sku'] ?: $it['uri'];
        if (!$k || isset($seen[$k])) continue;
        $seen[$k] = true;
        $clean[]  = $it;
    }
    return $clean;
}
function pickTop(array $arr, int $n): array { return array_slice($arr, 0, $n); }

// ---------- –¢–∞–±–ª–∏—Ü–∞ HTML ----------
function tableHtml(array $items, string $caption): string {
    $rows = '';
    foreach ($items as $it) {
        $href    = 'https://www.technodom.kz/aktau/' . ltrim($it['uri'], '/');
        $keySpec = '';
        if (!empty($it['specs'])) {
            foreach ($it['specs'] as $k => $v) { $keySpec = $k . ': ' . $v; break; }
        }
        $rows .= '<tr>'
               . '<td class="text-truncate" style="max-width:420px">' . htmlspecialchars($it['title']) . '</td>'
               . '<td>' . htmlspecialchars($it['brand']) . '</td>'
               . '<td class="text-muted">' . htmlspecialchars($keySpec) . '</td>'
               . '<td><span class="badge bg-dark-subtle text-dark">' . numberKZT($it['price']) . '</span></td>'
               . '<td><a class="btn btn-sm btn-outline-primary" href="' . htmlspecialchars($href) . '" target="_blank" rel="nofollow noopener">–û—Ç–∫—Ä—ã—Ç—å</a></td>'
               . '</tr>';
    }
    return '<h5 class="mt-4">' . htmlspecialchars($caption) . '</h5>'
         . '<div class="table-responsive"><table class="table table-striped table-hover align-middle">'
         . '<thead class="table-light"><tr>'
         . '<th>–ú–æ–¥–µ–ª—å</th><th>–ë—Ä–µ–Ω–¥</th><th>–ö–ª—é—á–µ–≤–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th><th>–¶–µ–Ω–∞</th><th></th>'
         . '</tr></thead><tbody>' . $rows . '</tbody></table></div>';
}

// ---------- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ ----------
function buildArticle(string $catName, string $slug, array $cheap, array $exp): array {
    $all    = array_merge($cheap, $exp);
    $prices = array_values(array_filter(array_column($all, 'price'), 'is_numeric'));
    sort($prices);
    $min = $prices[0] ?? null;
    $max = $prices ? end($prices) : null;
    $avg = $prices ? (int)round(array_sum($prices) / count($prices)) : null;

    $title      = "–õ—É—á—à–∏–µ {$catName} –≤ " . CITY_LABEL . ": –æ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ –ø—Ä–µ–º–∏—É–º-–º–æ–¥–µ–ª–µ–π";
    $meta_title = "{$catName} –≤ " . CITY_LABEL . " ‚Äî —Ü–µ–Ω—ã, –ø–æ–¥–±–æ—Ä–∫–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ";

    $min_meta = $min !== null ? $min : '';
    $max_meta = $max !== null ? $max : '';
    $avg_meta = $avg !== null ? $avg : '';

    $meta_desc  = ($min !== null && $max !== null)
        ? "–ü–æ–¥–±–æ—Ä–∫–∞ {$catName} –≤ " . CITY_LABEL . ": –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏ –ø—Ä–µ–º–∏—É–º-–º–æ–¥–µ–ª–∏. –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω {$min_meta}‚Äì{$max_meta} ‚Ç∏, —Å—Ä–µ–¥–Ω—è—è ~{$avg_meta} ‚Ç∏. –û–±–Ω–æ–≤–ª–µ–Ω–æ: " . date('Y-m-d') . "."
        : "–ü–æ–¥–±–æ—Ä–∫–∞ {$catName} –≤ " . CITY_LABEL . ". –û–±–Ω–æ–≤–ª–µ–Ω–æ: " . date('Y-m-d') . ".";

    $lead  = ($min !== null && $max !== null)
        ? "–°–æ–±—Ä–∞–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ {$catName} –≤ " . CITY_LABEL . " ‚Äî –æ—Ç —Å–∞–º—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ –ø—Ä–µ–º–∏—É–º. –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω: " . number_format($min, 0, '.', ' ') . "‚Äì" . number_format($max, 0, '.', ' ') . " ‚Ç∏."
        : "–°–æ–±—Ä–∞–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ {$catName} –≤ " . CITY_LABEL . " ‚Äî –æ—Ç –±—é–¥–∂–µ—Ç–Ω—ã—Ö –¥–æ –ø—Ä–µ–º–∏—É–º-—Ä–µ—à–µ–Ω–∏–π.";
    $about = "–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ù–∞ —á—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ: –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –±—Ä–µ–Ω–¥, –≥–∞—Ä–∞–Ω—Ç–∏—è –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –ù–∏–∂–µ ‚Äî –¥–≤–µ –ø–æ–¥–±–æ—Ä–∫–∏: –±—é–¥–∂–µ—Ç –∏ –ø—Ä–µ–º–∏—É–º.";

    $tblCheap = tableHtml($cheap, "–¢–û–ü-10 —Å–∞–º—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö");
    $tblExp   = tableHtml($exp,   "–¢–û–ü-10 –ø—Ä–µ–º–∏—É–º-–º–æ–¥–µ–ª–µ–π");

    $host   = $_SERVER['HTTP_HOST'] ?? 'localhost';
    $outro  = "–í—ã–≤–æ–¥. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –±—é–¥–∂–µ—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –±–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–ø—Ü–∏–π. –°—Ä–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç ‚Äî –±–∞–ª–∞–Ω—Å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫. –ü—Ä–µ–º–∏—É–º –±–µ—Ä—É—Ç –∑–∞ –º–∞–∫—Å–∏–º—É–º —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. {$host}";

    $short_story = $lead;
    $full_story  = "<p>{$lead}</p>"
                 . "<p>{$about}</p>"
                 . $tblCheap
                 . $tblExp
                 . "<p>{$outro}</p>"
                 . '<p class="small text-muted">' . ATTRIB_TXT . '</p>';

    return [
        'title'            => $title,
        'short_story'      => $short_story,
        'full_story'       => $full_story,
        'meta_title'       => $meta_title,
        'meta_description' => $meta_desc,
        'hashtags'         => mb_strtolower($slug) . ", " . CITY_LABEL,
    ];
}

// ---------- CSV lookup ----------
function loadCsvMap(string $csvPath): array {
    $map = []; if (!is_file($csvPath)) return $map;
    if (($fh = fopen($csvPath, 'r')) === false) return $map;
    $header = fgetcsv($fh, 0, ';'); // –∑–∞–≥–æ–ª–æ–≤–∫–∏
    while (($r = fgetcsv($fh, 0, ';')) !== false) {
        $name = $r[0] ?? '';
        $slug = $r[1] ?? '';
        $asc  = $r[2] ?? '';
        $desc = $r[3] ?? '';
        if ($slug && $asc && $desc) {
            $map[$slug] = ['name' => $name ?: $slug, 'asc' => $asc, 'desc' => $desc];
        }
    }
    fclose($fh);
    return $map;
}

// ---------- –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è ----------
function humanizeSlug(string $slug): string {
    $t = str_replace(['-', '_'], ' ', $slug);
    $t = preg_replace('~\s+~u', ' ', $t);
    $t = trim($t);
    if ($t === '') return $slug;
    $first = mb_strtoupper(mb_substr($t, 0, 1, 'UTF-8'), 'UTF-8');
    $rest  = mb_substr($t, 1, null, 'UTF-8');
    return $first . $rest;
}
function loadNameCache(): array {
    if (!is_file(NAME_CACHE)) return [];
    $raw = @file_get_contents(NAME_CACHE);
    $j = json_decode((string)$raw, true);
    return is_array($j) ? $j : [];
}
function saveNameCache(array $cache): void {
    ensureDir(dirname(NAME_CACHE));
    @file_put_contents(NAME_CACHE, json_encode($cache, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
}
function resolveCategoryName(string $slug, ?string $preferredName = null): string {
    if (!empty($preferredName) && $preferredName !== $slug) return $preferredName;

    $cache = loadNameCache();
    if (!empty($cache[$slug])) return $cache[$slug];

    $url = "https://api.technodom.kz/menu/api/v1/menu/breadcrumbs/categories/" . rawurlencode($slug);
    $data = httpJson($url);
    $name = null;
    $crumbs = $data['breadcrumbs'] ?? $data;
    if (is_array($crumbs)) {
        $last = end($crumbs);
        if (is_array($last)) $name = $last['title'] ?? $last['label'] ?? $last['name'] ?? null;
        if (!$name) {
            foreach ($crumbs as $c) {
                if (is_array($c) && !empty($c['title'])) $name = $c['title'];
            }
        }
    }
    if (!$name) $name = humanizeSlug($slug);

    $cache[$slug] = $name;
    saveNameCache($cache);
    logLine("Resolved name for {$slug}: {$name}");
    return $name;
}

// ---------- ENTRY ----------
if (isset($_GET['ping'])) {
    ok(['ping' => 'pong', 'now' => date('c')]);
}

$slug    = trim((string)($_GET['slug'] ?? ''));
$name    = trim((string)($_GET['name'] ?? ''));
$asc     = trim((string)($_GET['asc'] ?? ''));
$desc    = trim((string)($_GET['desc'] ?? ''));
$limit   = max(1, (int)($_GET['limit'] ?? 10)); // —Å–∫–æ–ª—å–∫–æ –±—Ä–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—ã
$jsonOut = (int)($_GET['json'] ?? 0) === 1;

if ($slug && (!$asc || !$desc)) {
    $map = loadCsvMap(CSV_PATH);
    if (isset($map[$slug])) {
        $asc  = $asc  ?: $map[$slug]['asc'];
        $desc = $desc ?: $map[$slug]['desc'];
        $name = $name ?: ($map[$slug]['name'] ?? '');
        logLine("CSV matched slug={$slug}");
    }
}

if (!$slug || !$asc || !$desc) {
    fail('–ü–µ—Ä–µ–¥–∞–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: slug, asc, desc (name ‚Äî –æ–ø—Ü.) –∏–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å CSV –¥–ª—è –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏.', [
        'example' => [
            'ping' => '?ping=1',
            'full' => '?slug=vneshnie-akkumuljatory&name=–í–Ω–µ—à–Ω–∏–µ%20–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã'
                    . '&asc=' . rawurlencode('https://api.technodom.kz/katalog/api/v2/products/category/vneshnie-akkumuljatory?city_id=5f5f1e346a600b98a31fddb5&limit=24&sorting=price%3Aasc')
                    . '&desc=' . rawurlencode('https://api.technodom.kz/katalog/api/v2/products/category/vneshnie-akkumuljatory?city_id=5f5f1e346a600b98a31fddb5&limit=24&sorting=price%3Adesc'),
            'slug_only' => '?slug=vneshnie-akkumuljatory&limit=10&log=1 (–µ—Å–ª–∏ –µ—Å—Ç—å CSV)',
        ]
    ]);
}

$catName = resolveCategoryName($slug, $name);

// –°–Ω—è—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö
logLine("Fetch ASC for {$slug}");
$ascPayload = httpJson($asc);
usleep(100000);
logLine("Fetch DESC for {$slug}");
$descPayload = httpJson($desc);

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
$cheap = pickTop(normalizeItems($ascPayload),  $limit);
$exp   = pickTop(normalizeItems($descPayload), $limit);

// –§–æ–ª–ª–±—ç–∫–∏
if (count($cheap) < 3 && count($exp) > 0) { $cheap = array_slice(array_reverse($exp), 0, $limit); }
if (count($exp)   < 3 && count($cheap) > 0) { $exp   = array_slice(array_reverse($cheap), 0, $limit); }
if (count($cheap) === 0 && count($exp) === 0) {
    fail('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –ø–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º —Å—Å—ã–ª–∫–∞–º (–∏–ª–∏ –ø—É—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã). –ü—Ä–æ–≤–µ—Ä—å ASC/DESC URL.');
}

// –°—Ç–∞—Ç—å—è
$article = buildArticle($catName, $slug, $cheap, $exp);

// ---------- JSON —Ä–µ–∂–∏–º ----------
if ($jsonOut) {
    ok([
        'slug'            => $slug,
        'cheap_count'     => count($cheap),
        'expensive_count' => count($exp),
        'data'            => $article,
        'asc_url'         => $asc,
        'desc_url'        => $desc
    ]);
}

// ---------- HTML Preview ----------
$title = htmlspecialchars($article['title']);
$lead  = $article['short_story'];
$full  = $article['full_story'];
$metaTitle = htmlspecialchars($article['meta_title']);
$metaDesc  = htmlspecialchars($article['meta_description']);
$hashtags  = htmlspecialchars($article['hashtags']);

?><!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: <?= $title ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8fafc; }
    .container-narrow { max-width: 1100px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    pre.code { background:#0f172a; color:#e2e8f0; padding:16px; border-radius:12px; }
    .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,.05); }
  </style>
</head>
<body>
<div class="container container-narrow py-4">
  <div class="d-flex align-items-center gap-3 mb-3">
    <h2 class="m-0">üß± –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏</h2>
    <span class="badge text-bg-secondary"><?= htmlspecialchars($slug) ?></span>
  </div>

  <div class="alert alert-success py-2">
    ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <b><?= count($cheap) ?></b> (–¥–µ—à—ë–≤—ã–µ) –∏ <b><?= count($exp) ?></b> (–¥–æ—Ä–æ–≥–∏–µ)
  </div>

  <div class="card card-shadow mb-4">
    <div class="card-body">
      <h3 class="card-title"><?= $title ?></h3>
      <p class="card-text"><?= $lead ?></p>
      <hr>
      <?= $full ?>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card card-shadow h-100">
        <div class="card-header bg-light">üìå Meta-–¥–∞–Ω–Ω—ã–µ</div>
        <div class="card-body">
          <div class="mb-2"><div class="text-muted small">meta_title</div><div class="mono"><?= $metaTitle ?></div></div>
          <div class="mb-2"><div class="text-muted small">meta_description</div><div class="mono"><?= $metaDesc ?></div></div>
          <div class="mb-2"><div class="text-muted small">hashtags</div><div class="mono"><?= $hashtags ?></div></div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card card-shadow h-100">
        <div class="card-header bg-light">üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ API</div>
        <div class="card-body">
          <div class="mb-2"><span class="badge text-bg-dark me-2">ASC</span>
            <a href="<?= htmlspecialchars($asc) ?>" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å</a></div>
          <div class="mb-2"><span class="badge text-bg-dark me-2">DESC</span>
            <a href="<?= htmlspecialchars($desc) ?>" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å</a></div>
          <div class="mt-3">
            <a class="btn btn-sm btn-outline-secondary" href="?<?= http_build_query($_GET + ['json'=>1]) ?>">–ü–æ–∫–∞–∑–∞—Ç—å JSON</a>
            <button id="copyHtml" class="btn btn-sm btn-primary ms-2">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å HTML —Å—Ç–∞—Ç—å–∏</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card card-shadow my-4">
    <div class="card-header bg-light">üìÑ –ß–∏—Å—Ç—ã–π HTML –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ DLE</div>
    <div class="card-body">
      <pre class="code"><code id="articleHtml"><?= htmlspecialchars($full) ?></code></pre>
    </div>
  </div>

  <div class="d-flex gap-2">
    <!-- –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –±—É–¥—É—â–µ–µ: –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é 9 -->
    <a class="btn btn-success"
       href="/td_publish.php?slug=<?= urlencode($slug) ?>&name=<?= urlencode($catName ?? $slug) ?>&asc=<?= urlencode($asc) ?>&desc=<?= urlencode($desc) ?>&dle_category_id=9&publish=0"
       target="_blank" rel="noopener">‚ûï –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ DLE (—á–µ—Ä–Ω–æ–≤–∏–∫, cat=9)</a>
    <a class="btn btn-outline-secondary" href="javascript:history.back()">‚Üê –ù–∞–∑–∞–¥</a>
  </div>

  <footer class="mt-5 text-center text-muted small">v3 preview ‚Ä¢ <?= date('Y-m-d H:i') ?></footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById('copyHtml')?.addEventListener('click', async () => {
    const el = document.getElementById('articleHtml');
    try {
      await navigator.clipboard.writeText(el.textContent);
      alert('HTML —Å—Ç–∞—Ç—å–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    } catch (e) {
      // Fallback
      const range = document.createRange();
      range.selectNode(el);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      document.execCommand('copy');
      sel.removeAllRanges();
      alert('HTML —Å—Ç–∞—Ç—å–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback).');
    }
  });
</script>
</body>
</html>
]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="td_dashboard.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
// td_dashboard.php ‚Äî –µ–¥–∏–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º
declare(strict_types=1);

// ===== mini API: –æ—Ç–¥–∞—ë–º CSV –∫–∞–∫ JSON –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞ =====
if (isset($_GET['action']) && $_GET['action'] === 'csv') {
    $csvPath = __DIR__ . '/td_cache/technodom_categories_links.csv';
    header('Content-Type: application/json; charset=utf-8');
    if (!is_file($csvPath)) {
        echo json_encode(['ok'=>false,'error'=>'CSV not found'], JSON_UNESCAPED_UNICODE);
        exit;
    }
    $out = [];
    if (($fh = fopen($csvPath, 'r')) !== false) {
        $header = fgetcsv($fh, 0, ';'); // "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä—É–±—Ä–∏–∫–∏";Slug;ASC;DESC;"Sitemap URL"
        while (($r = fgetcsv($fh, 0, ';')) !== false) {
            $out[] = [
                'name'  => $r[0] ?? '',
                'slug'  => $r[1] ?? '',
                'asc'   => $r[2] ?? '',
                'desc'  => $r[3] ?? '',
                'smap'  => $r[4] ?? '',
            ];
        }
        fclose($fh);
    }
    echo json_encode(['ok'=>true,'items'=>$out], JSON_UNESCAPED_UNICODE);
    exit;
}

// –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è URL —Å–æ—Å–µ–¥–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
function same_dir_url(string $file): string {
    $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
    $host   = $_SERVER['HTTP_HOST'] ?? 'localhost';
    $dir    = rtrim(str_replace('\\','/', dirname($_SERVER['REQUEST_URI'] ?? '/')), '/');
    if ($dir === '') $dir = '/';
    return rtrim($scheme.'://'.$host.$dir, '/') . '/' . ltrim($file, '/');
}

$buildUrl   = same_dir_url('td_build_article.php');
$publishUrl = same_dir_url('td_publish.php');
?>
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>TD Dashboard ‚Äî —Å–±–æ—Ä ‚Üí GPT ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8fafc; }
    .container-narrow { max-width: 1200px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,.05); }
    .h-40 { height: 40px; }
    #result pre { background:#0f172a; color:#e2e8f0; padding:12px; border-radius:8px; }
    .tableFixHead { overflow-y:auto; max-height: 320px; }
    .tableFixHead thead th { position: sticky; top: 0; z-index: 1; background:#fff; }
  </style>
</head>
<body>
<div class="container container-narrow py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">üß± TD Dashboard ‚Äî Technodom ‚Üí GPT ‚Üí DLE</h2>
    <span class="badge text-bg-secondary">beta</span>
  </div>

  <div class="row g-3">
    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="col-lg-4">
      <div class="card card-shadow">
        <div class="card-header bg-light">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–∏–∑ CSV)</label>
            <div class="d-flex gap-2">
              <select id="selCategory" class="form-select"></select>
              <button id="refreshCsv" class="btn btn-outline-secondary">‚ü≥</button>
            </div>
            <div class="form-text">–ò—Å—Ç–æ—á–Ω–∏–∫: td_cache/technodom_categories_links.csv</div>
          </div>
          <div class="mb-2">
            <label class="form-label">Slug</label>
            <input id="inSlug" type="text" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: vneshnie-akkumuljatory">
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">–õ–∏–º–∏—Ç (–≤ –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É)</label>
              <input id="inLimit" type="number" class="form-control" value="10" min="1" max="50">
            </div>
            <div class="col-6">
              <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è DLE (ID)</label>
              <input id="inCatId" type="number" class="form-control" value="9" min="1">
            </div>
          </div>
          <div class="mt-3 d-flex gap-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cbPublish" checked>
              <label class="form-check-label" for="cbPublish">–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cbGPT" checked>
              <label class="form-check-label" for="cbGPT">GPT-—Ä–µ—Ä–∞–π—Ç</label>
            </div>
          </div>
          <div class="mt-3">
            <button id="btnPreview" class="btn btn-primary w-100">üîé –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏</button>
          </div>
          <div class="mt-2 d-grid gap-2">
            <button id="btnPublish" class="btn btn-success">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (GPT)</button>
            <button id="btnDraft" class="btn btn-outline-success">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫ (GPT)</button>
            <button id="btnNoGpt" class="btn btn-outline-secondary">‚ö° –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –±–µ–∑ GPT</button>
          </div>
          <hr>
          <div class="small text-muted">
            <div>Builder: <span class="mono"><?= htmlspecialchars($buildUrl) ?></span></div>
            <div>Publish: <span class="mono"><?= htmlspecialchars($publishUrl) ?></span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="col-lg-8">
      <div class="card card-shadow mb-3">
        <div class="card-header bg-light">üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
        <div class="card-body" id="preview">
          <div class="text-muted">–ù–∞–∂–º–∏ ¬´–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—å–∏¬ª ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫, –ª–∏–¥, —Ç–∞–±–ª–∏—Ü—ã –∏ –º–µ—Ç–∞.</div>
        </div>
      </div>

      <div class="card card-shadow">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <span>üßæ –ñ—É—Ä–Ω–∞–ª / –û—Ç–≤–µ—Ç—ã API</span>
          <div class="d-flex gap-2">
            <button id="btnPing" class="btn btn-sm btn-outline-secondary">Ping endpoints</button>
            <button id="btnClearLog" class="btn btn-sm btn-outline-secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </div>
        <div class="card-body" id="result">
          <pre class="mb-0" id="log" style="white-space:pre-wrap;">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ‚Ä¶</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–∞–∫–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º -->
  <div class="card card-shadow mt-4">
    <div class="card-header bg-light">üì¶ –ü–∞–∫–µ—Ç–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="tableFixHead border rounded">
            <table class="table table-sm mb-0" id="tblBatch">
              <thead>
                <tr><th style="width:36px;"><input type="checkbox" id="chAll"></th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>Slug</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="form-text">–û—Ç–º–µ—Ç—å –Ω—É–∂–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –Ω–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞¬ª</div>
        </div>
        <div class="col-lg-4">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">–õ–∏–º–∏—Ç</label>
              <input id="inBLimit" type="number" class="form-control" value="10" min="1" max="50">
            </div>
            <div class="col-6">
              <label class="form-label">DLE cat</label>
              <input id="inBCatId" type="number" class="form-control" value="9" min="1">
            </div>
          </div>
          <div class="mt-2 form-check">
            <input class="form-check-input" type="checkbox" id="cbBPublish" checked>
            <label class="form-check-label" for="cbBPublish">–ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å</label>
          </div>
          <div class="mt-2 form-check">
            <input class="form-check-input" type="checkbox" id="cbBGPT" checked>
            <label class="form-check-label" for="cbBGPT">GPT-—Ä–µ—Ä–∞–π—Ç</label>
          </div>
          <div class="mt-3 d-grid gap-2">
            <button id="btnBatch" class="btn btn-dark">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞</button>
            <button id="btnStop" class="btn btn-outline-danger">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div class="mt-3">
            <div class="progress">
              <div id="prog" class="progress-bar" role="progressbar" style="width:0%">0%</div>
            </div>
            <div class="small mt-1" id="batchStat">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-4 text-center text-muted small">TD Dashboard ‚Ä¢ <?= date('Y-m-d H:i') ?></footer>
</div>

<script>
const buildUrl   = <?= json_encode($buildUrl) ?>;
const publishUrl = <?= json_encode($publishUrl) ?>;

const selCategory = document.getElementById('selCategory');
const inSlug      = document.getElementById('inSlug');
const inLimit     = document.getElementById('inLimit');
const inCatId     = document.getElementById('inCatId');
const cbPublish   = document.getElementById('cbPublish');
const cbGPT       = document.getElementById('cbGPT');

const previewBox  = document.getElementById('preview');
const logBox      = document.getElementById('log');

function log(msg) {
  logBox.textContent += '\\n' + msg;
  logBox.scrollTop = logBox.scrollHeight;
}
function clearLog(){ logBox.textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ‚Ä¶'; }
document.getElementById('btnClearLog').onclick = clearLog;

async function loadCsv() {
  const r = await fetch('?action=csv');
  const j = await r.json();
  selCategory.innerHTML = '';
  document.querySelector('#tblBatch tbody').innerHTML = '';
  if (!j.ok) { log('CSV error: ' + (j.error || 'unknown')); return; }
  j.items.forEach((it, idx) => {
    const o = document.createElement('option');
    o.value = it.slug;
    o.textContent = `${it.name || it.slug} ‚Äî ${it.slug}`;
    o.dataset.asc = it.asc; o.dataset.desc = it.desc; o.dataset.name = it.name;
    selCategory.appendChild(o);

    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="checkbox" class="chRow" data-slug="${it.slug}"></td>
                    <td>${escapeHtml(it.name || '')}</td>
                    <td class="mono">${escapeHtml(it.slug || '')}</td>`;
    document.querySelector('#tblBatch tbody').appendChild(tr);
  });
  if (j.items.length) {
    selCategory.selectedIndex = 0;
    inSlug.value = j.items[0].slug || '';
  }
  log('CSV –∑–∞–≥—Ä—É–∂–µ–Ω: ' + j.items.length + ' —Å—Ç—Ä–æ–∫');
}
document.getElementById('refreshCsv').onclick = loadCsv;

selCategory.addEventListener('change', () => {
  const o = selCategory.options[selCategory.selectedIndex];
  inSlug.value = o.value || '';
});

function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

async function previewArticle() {
  const slug  = inSlug.value.trim();
  const limit = parseInt(inLimit.value||'10',10);
  if (!slug) return alert('–£–∫–∞–∂–∏ slug');
  clearLog();
  log('üîé –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: ' + slug);

  const url = buildUrl + '?slug=' + encodeURIComponent(slug) + '&limit=' + limit + '&json=1';
  const r = await fetch(url);
  if (!r.ok) { log('Builder HTTP ' + r.status); return; }
  const j = await r.json();
  if (!j.ok) { log('Builder error'); return; }

  const a = j.data;
  previewBox.innerHTML = `
    <h3 class="mb-2">${escapeHtml(a.title)}</h3>
    <p>${a.short_story}</p>
    <hr>
    ${a.full_story}
    <hr>
    <div class="row g-2 small">
      <div class="col-md-6"><b>meta_title:</b> <span class="mono">${escapeHtml(a.meta_title)}</span></div>
      <div class="col-md-6"><b>meta_description:</b> <span class="mono">${escapeHtml(a.meta_description)}</span></div>
      <div class="col-12"><b>hashtags:</b> <span class="mono">${escapeHtml(a.hashtags)}</span></div>
    </div>`;
  log('OK: cheap='+(j.cheap_count||0)+' / expensive='+(j.expensive_count||0));
}

async function doPublish({publish=true, use_gpt=true}) {
  const slug  = inSlug.value.trim();
  const limit = parseInt(inLimit.value||'10',10);
  const catId = parseInt(inCatId.value||'9',10);
  if (!slug) return alert('–£–∫–∞–∂–∏ slug');

  const url = `${publishUrl}?slug=${encodeURIComponent(slug)}&limit=${limit}&dle_category_id=${catId}&publish=${publish?1:0}&use_gpt=${use_gpt?1:0}`;
  log('‚ñ∂Ô∏è –ü—É–±–ª–∏–∫–∞—Ü–∏—è: ' + url.replace(location.origin,''));
  const r = await fetch(url);
  if (!r.ok) { log('Publish HTTP '+r.status); return; }
  const j = await r.json();
  if (!j.ok) { log('Publish error'); return; }
  log('‚úÖ post_id=' + j.post_id + ', published=' + j.published + ', cat=' + j.category);
}

document.getElementById('btnPreview').onclick = previewArticle;
document.getElementById('btnPublish').onclick = () => doPublish({publish:true, use_gpt:true});
document.getElementById('btnDraft').onclick   = () => doPublish({publish:false, use_gpt:true});
document.getElementById('btnNoGpt').onclick   = () => doPublish({publish:true, use_gpt:false});

document.getElementById('btnPing').onclick = async () => {
  const a = await fetch(publishUrl+'?ping=1').then(r=>r.json()).catch(()=>null);
  const b = await fetch(buildUrl  +'?ping=1').then(r=>r.json()).catch(()=>null);
  log('Ping publish: ' + (a && a.ok ? 'ok' : 'fail'));
  log('Ping build:   ' + (b && b.ok ? 'ok' : 'fail'));
};

// –ü–∞–∫–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º
let stopBatch = false;
document.getElementById('btnStop').onclick = ()=>{ stopBatch = true; };
document.getElementById('chAll').onclick = (e)=>{
  document.querySelectorAll('.chRow').forEach(ch=>ch.checked = e.target.checked);
};
document.getElementById('btnBatch').onclick = async ()=>{
  const limit  = parseInt(document.getElementById('inBLimit').value||'10',10);
  const catId  = parseInt(document.getElementById('inBCatId').value||'9',10);
  const pub    = document.getElementById('cbBPublish').checked;
  const useGpt = document.getElementById('cbBGPT').checked;

  const rows = Array.from(document.querySelectorAll('.chRow')).filter(x=>x.checked);
  if (!rows.length) return alert('–û—Ç–º–µ—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é');

  stopBatch = false;
  let done=0;
  for (let i=0;i<rows.length;i++){
    if (stopBatch){ log('‚èπ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'); break; }
    const slug = rows[i].dataset.slug;
    const url  = `${publishUrl}?slug=${encodeURIComponent(slug)}&limit=${limit}&dle_category_id=${catId}&publish=${pub?1:0}&use_gpt=${useGpt?1:0}`;
    log(`‚ñ∂Ô∏è [${i+1}/${rows.length}] ${slug}`);
    try{
      const r = await fetch(url);
      const j = await r.json();
      if (j && j.ok){
        log(`‚úÖ post_id=${j.post_id}, published=${j.published}`);
      } else {
        log(`‚ùå error on ${slug}`);
      }
    }catch(e){ log(`‚ùå HTTP error on ${slug}`); }
    done++;
    const pct = Math.round(done*100/rows.length);
    document.getElementById('prog').style.width = pct+'%';
    document.getElementById('prog').textContent = pct+'%';
    document.getElementById('batchStat').textContent = `–ì–æ—Ç–æ–≤–æ ${done} –∏–∑ ${rows.length}`;
    await new Promise(r=>setTimeout(r, 300)); // –º–∞–ª–µ–Ω—å–∫–∞—è –ø–∞—É–∑–∞
  }
};

// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadCsv();
</script>
</body>
</html>]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="td_publish.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
declare(strict_types=1);

// ------- –ª—ë–≥–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å: —Ñ–∞–π–ª –≤–æ–æ–±—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è? -------
if (isset($_GET['ping'])) {
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode(['ok'=>true,'pong'=>date('c')], JSON_UNESCAPED_UNICODE);
    exit;
}

require_once __DIR__ . '/td_config.php';
require_once __DIR__ . '/td_gpt.php';

// ====== helpers ======
function debug_enabled(): bool { return (int)($_GET['debug'] ?? 0) === 1; }
function say($msg){ if(debug_enabled()){ echo '<div style="font:12px/1.4 monospace;color:#111;background:#f6f8fa;border-left:4px solid #2f81f7;padding:8px 10px;margin:6px 0;">'.$msg.'</div>'; } }
function json_out($arr){ header('Content-Type: application/json; charset=utf-8'); echo json_encode($arr, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT); exit; }
function http_get_json(string $url): ?array {
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT        => 30,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_ENCODING       => 'gzip,deflate'
    ]);
    $body = curl_exec($ch);
    $code = (int)curl_getinfo($ch, CURLINFO_RESPONSE_CODE);
    $err  = curl_error($ch);
    curl_close($ch);
    if ($code !== 200 || !$body) { return null; }
    $j = json_decode($body, true);
    return is_array($j) ? $j : null;
}
function base_origin(): string {
    $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
    $host   = $_SERVER['HTTP_HOST'] ?? 'localhost';
    return $scheme . '://' . $host;
}
function same_dir_url(string $file): string {
    // URL –∫ —Ñ–∞–π–ª—É –≤ —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: base_origin + dirname(request_uri) + file
    $dir = rtrim(str_replace('\\','/', dirname($_SERVER['REQUEST_URI'] ?? '/')), '/');
    if ($dir === '') $dir = '/';
    return rtrim(base_origin().$dir, '/') . '/' . ltrim($file, '/');
}
function extract_cat_name_from_title(string $title, string $slug): string {
    if (preg_match('~–õ—É—á—à–∏–µ\s+(.+?)\s+–≤\s+~u', $title, $m)) return trim($m[1]);
    $t = str_replace(['-', '_'], ' ', $slug);
    return mb_convert_case($t, MB_CASE_TITLE, 'UTF-8');
}
function translit_to_url(string $s): string {
    $map = ['–∞'=>'a','–±'=>'b','–≤'=>'v','–≥'=>'g','–¥'=>'d','–µ'=>'e','—ë'=>'e','–∂'=>'zh','–∑'=>'z','–∏'=>'i','–π'=>'y','–∫'=>'k','–ª'=>'l','–º'=>'m','–Ω'=>'n','–æ'=>'o','–ø'=>'p','—Ä'=>'r','—Å'=>'s','—Ç'=>'t','—É'=>'u','—Ñ'=>'f','—Ö'=>'h','—Ü'=>'c','—á'=>'ch','—à'=>'sh','—â'=>'sch','—ä'=>'','—ã'=>'y','—å'=>'','—ç'=>'e','—é'=>'yu','—è'=>'ya',' '=>'-','‚Äî'=>'-','‚Äì'=>'-','¬´'=>'','¬ª'=>'','"'=>'','\''=>'','/'=>'-','\\'=>'-','&'=>'-','?'=>'',','=>'','.'=>'','('=>' ',')'=>' '];
    $s = mb_strtolower($s, 'UTF-8');
    $s = strtr($s, $map);
    $s = preg_replace('~[^a-z0-9\-]+~', '-', $s);
    $s = preg_replace('~-+~', '-', $s);
    return trim($s, '-');
}

// ====== –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ======
$slug    = trim((string)($_GET['slug'] ?? ''));
$limit   = max(1, (int)($_GET['limit'] ?? 10));
$catId   = (int)($_GET['dle_category_id'] ?? DEFAULT_DLE_CAT_ID);
$publish = (int)($_GET['publish'] ?? DEFAULT_PUBLISH); // 1=–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å, 0=—á–µ—Ä–Ω–æ–≤–∏–∫
$useGpt  = (int)($_GET['use_gpt'] ?? 1);

if (debug_enabled()) { ini_set('display_errors','1'); error_reporting(E_ALL); }
if (!$slug) {
    if (debug_enabled()) { die('Param "slug" is required'); }
    json_out(['ok'=>false,'error'=>'Param "slug" is required']);
}

// ====== 1) —Ç—è–Ω–µ–º —Å—ã—Ä—É—é —Å—Ç–∞—Ç—å—é –∏–∑ –±–∏–ª–¥–µ—Ä–∞ ======
$builder = same_dir_url('td_build_article.php') . '?slug=' . urlencode($slug) . '&limit=' . $limit . '&json=1';
say('Builder URL: <b>'.$builder.'</b>');

$raw = http_get_json($builder);
if (!$raw || empty($raw['ok']) || empty($raw['data'])) {
    if (debug_enabled()) {
        die('Build article failed (–Ω–µ—Ç JSON –æ—Ç td_build_article.php). –ü—Ä–æ–≤–µ—Ä—å: —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏ –æ—Ç–¥–∞—ë—Ç json=1.');
    }
    json_out(['ok'=>false,'error'=>'Build article failed']);
}
$article = $raw['data'];
say('Builder OK: –ø–æ–ª—É—á–µ–Ω—ã –ø–æ–ª—è title/short/full/meta');

// ====== 2) GPT —Ä–µ—Ä–∞–π—Ç (–ø–æ –∂–µ–ª–∞–Ω–∏—é) ======
$catName = extract_cat_name_from_title($article['title'] ?? '', $slug);
if ($useGpt) {
    say('GPT: start rewrite‚Ä¶');
    $article = td_gpt_rewrite($article, $catName, $slug);
    say('GPT: done');
} else {
    say('GPT: –ø—Ä–æ–ø—É—â–µ–Ω (use_gpt=0)');
}

// ====== 3) –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ DLE ======
try {
    $postId = dle_publish($article, $catId, (bool)$publish);
    say('DLE: –≤—Å—Ç–∞–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, post_id='.$postId.', publish='.(int)(bool)$publish);
} catch (Throwable $e) {
    if (debug_enabled()) { die('DLE publish error: '.$e->getMessage()); }
    json_out(['ok'=>false,'error'=>'DLE publish error']);
}

// ====== –∏—Ç–æ–≥ ======
if (debug_enabled()) {
    echo '<hr><pre style="font:12px/1.5 monospace;background:#fafafa;border:1px solid #eee;padding:8px;">'.
         htmlspecialchars(json_encode(['ok'=>true,'post_id'=>$postId,'slug'=>$slug,'published'=>(bool)$publish,'category'=>$catId], JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT)).
         '</pre>';
    exit;
}
json_out(['ok'=>true,'post_id'=>$postId,'slug'=>$slug,'published'=>(bool)$publish,'category'=>$catId]);

// ====== DLE –≤—Å—Ç–∞–≤–∫–∞ ======
function dle_publish(array $article, int $catId, bool $publish): int {
    $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
    if ($mysqli->connect_errno) {
        throw new RuntimeException('DB connect: ' . $mysqli->connect_error);
    }
    $mysqli->set_charset(DB_CHARSET);

    $title = (string)($article['title'] ?? '');
    $short = (string)($article['short_story'] ?? '');
    $full  = (string)($article['full_story'] ?? '');
    $mt    = (string)($article['meta_title'] ?? '');
    $mdesc = (string)($article['meta_description'] ?? '');
    $tags  = (string)($article['hashtags'] ?? '');

    if ($title === '' || $full === '') {
        throw new RuntimeException('Empty title/full_story ‚Äî –Ω–∏—á–µ–≥–æ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å');
    }

    // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
    $escTitle = $mysqli->real_escape_string($title);
    $dupSql   = "SELECT id FROM dle_post WHERE title='{$escTitle}' AND category='{$catId}' LIMIT 1";
    $dupRes   = $mysqli->query($dupSql);
    if ($dupRes && $dupRes->num_rows > 0) {
        $row = $dupRes->fetch_assoc();
        return (int)$row['id']; // —É–∂–µ –µ—Å—Ç—å
    }

    $date       = date('Y-m-d H:i:s');
    $autor      = DEFAULT_AUTHOR;
    $approve    = $publish ? 1 : 0;
    $allow_comm = DEFAULT_ALLOW_COMM;
    $allow_main = DEFAULT_ALLOW_MAIN;
    $alt_name   = translit_to_url($title);

    $stmt = $mysqli->prepare("
        INSERT INTO dle_post
          (autor, date, title, short_story, full_story, category, tags, alt_name, approve, allow_comm, allow_main, descr, metatitle)
        VALUES
          (?,     ?,    ?,     ?,           ?,          ?,        ?,    ?,        ?,       ?,          ?,         ?,     ?)
    ");
    if (!$stmt) {
        throw new RuntimeException('DB prepare: ' . $mysqli->error);
    }
    $stmt->bind_param(
        'sssssisiiiiss',
        $autor, $date, $title, $short, $full, $catId, $tags, $alt_name, $approve, $allow_comm, $allow_main, $mdesc, $mt
    );
    if (!$stmt->execute()) {
        throw new RuntimeException('DB execute: ' . $stmt->error);
    }
    $postId = (int)$stmt->insert_id;
    $stmt->close();
    $mysqli->close();
    return $postId;
}
]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="td_mass.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
declare(strict_types=1);
ini_set('display_errors','0'); error_reporting(E_ALL);

define('SITE_HOST', $_SERVER['HTTP_HOST'] ?? 'localhost');
$csv = __DIR__ . '/td_cache/technodom_categories_links.csv';

$limit   = max(1, (int)($_GET['limit'] ?? 5));     // —Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞ –ø—Ä–æ–≥–æ–Ω
$shuffle = (int)($_GET['shuffle'] ?? 1) === 1;     // –ø–µ—Ä–µ–º–µ—à–∞—Ç—å?
$catId   = (int)($_GET['dle_category_id'] ?? 0);   // DLE –∫–∞—Ç–µ–≥–æ—Ä–∏—è
$publish = (int)($_GET['publish'] ?? 0);           // 0 ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫–∏, 1 ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è

if (!is_file($csv)) { header('Content-Type: text/plain; charset=utf-8'); echo "–ù–µ—Ç CSV: {$csv}\n"; exit; }

$rows = [];
if (($fh = fopen($csv, 'r')) !== false) {
  $header = fgetcsv($fh, 0, ';'); // –∑–∞–≥–æ–ª–æ–≤–∫–∏
  while (($r = fgetcsv($fh, 0, ';')) !== false) {
    // –û–∂–∏–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä—É–±—Ä–∏–∫–∏;Slug;ASC;DESC;Sitemap URL
    $rows[] = [
      'name' => $r[0] ?? '',
      'slug' => $r[1] ?? '',
      'asc'  => $r[2] ?? '',
      'desc' => $r[3] ?? ''
    ];
  }
  fclose($fh);
}
$rows = array_values(array_filter($rows, fn($r)=> $r['slug'] && $r['asc'] && $r['desc']));

if ($shuffle) shuffle($rows);
$batch = array_slice($rows, 0, $limit);

function callJson(string $url,int $timeout=40): array {
  $ch = curl_init($url);
  curl_setopt_array($ch,[
    CURLOPT_RETURNTRANSFER=>true,
    CURLOPT_FOLLOWLOCATION=>true,
    CURLOPT_TIMEOUT=>$timeout,
    CURLOPT_HTTPHEADER=>['Accept: application/json'],
    CURLOPT_ENCODING=>'gzip,deflate'
  ]);
  $body = curl_exec($ch);
  $code = curl_getinfo($ch, CURLINFO_RESPONSE_CODE);
  curl_close($ch);
  if ($code!==200 || !$body) return [];
  $j = json_decode($body, true);
  return is_array($j)?$j:[];
}

header('Content-Type: text/plain; charset=utf-8');
echo "TD MASS RUN | limit={$limit} | shuffle=".($shuffle?'1':'0')." | cat={$catId} | publish={$publish}\n\n";

$ok=0; $fail=0;
foreach ($batch as $r) {
  $pubUrl = "https://".SITE_HOST."/td_publish.php"
          ."?slug=".rawurlencode($r['slug'])
          ."&name=".rawurlencode($r['name'])
          ."&asc=".rawurlencode($r['asc'])
          ."&desc=".rawurlencode($r['desc'])
          ."&dle_category_id=".$catId
          ."&publish=".$publish;

  $res = callJson($pubUrl, 60);
  if (!empty($res['ok'])) {
    $ok++;
    echo "‚úî {$r['slug']} ‚Üí post_id=".$res['post_id']."\n";
  } else {
    $fail++;
    echo "‚úñ {$r['slug']} ‚Üí –æ—à–∏–±–∫–∞\n";
  }
  usleep(120000); // —â–∞–¥–∏–º API
}

echo "\n–ì–æ—Ç–æ–≤–æ. –£—Å–ø–µ—à–Ω–æ: {$ok}, –û—à–∏–±–æ–∫: {$fail}\n";
]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="engine/inc/technodom_dashboard.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
if (!defined('DATALIFEENGINE') || !defined('LOGGED_IN')) {
    header('HTTP/1.1 403 Forbidden');
    header('Location: ../../');
    die('Hacking attempt!');
}

global $config, $member_id;

$scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
$host = $_SERVER['HTTP_HOST'] ?? ($_SERVER['SERVER_NAME'] ?? 'localhost');
$homeUrl = trim((string)($config['http_home_url'] ?? ''));
if ($homeUrl === '') {
    $homeUrl = $scheme . '://' . $host;
} elseif (!preg_match('~^https?://~i', $homeUrl)) {
    $homeUrl = $scheme . '://' . $host . '/' . ltrim($homeUrl, '/');
}
$baseUrl = rtrim($homeUrl, '/');

$dashboardUrl = $baseUrl . '/td_dashboard.php';
$builderUrl   = $baseUrl . '/td_build_article.php';
$publishUrl   = $baseUrl . '/td_publish.php';
$massUrl      = $baseUrl . '/td_mass.php';
$csvPath      = ROOT_DIR . '/td_cache/technodom_categories_links.csv';

$hasCsv = is_file($csvPath);
$csvInfo = $hasCsv
    ? '<span class="status-ok">–Ω–∞–π–¥–µ–Ω</span>'
    : '<span class="status-miss">–Ω–µ –Ω–∞–π–¥–µ–Ω</span>';

if (!function_exists('echoheader') || !function_exists('echofooter')) {
    die('DLE admin skin helpers missing');
}

echoheader('<i class="fa fa-plug"></i> Technodom Parser', '–ü–∞—Ä—Å–µ—Ä Technodom ‚Üí GPT ‚Üí DLE');
?>
<style>
    .tdp-links code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .tdp-links .status-ok { color: #198754; font-weight: 600; }
    .tdp-links .status-miss { color: #dc3545; font-weight: 600; }
    .tdp-iframe { width: 100%; min-height: 720px; border: 1px solid #dee2e6; border-radius: 12px; background: #fff; }
</style>
<div class="panel panel-default tdp-links">
    <div class="panel-heading">
        <strong>Technodom ‚Üí GPT ‚Üí DLE</strong>
    </div>
    <div class="panel-body">
        <p>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω –∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Technodom, —Å–±–æ—Ä–∫–∏ —Å—Ç–∞—Ç—å–∏ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ DLE.</p>
        <ol>
            <li>–û–±–Ω–æ–≤–∏—Ç–µ CSV —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π: <code>td_cache/technodom_categories_links.csv</code> ‚Äî —Ñ–∞–π–ª <?= $csvInfo ?>.</li>
            <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä¬ª –≤ –¥–∞—à–±–æ—Ä–¥–µ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π.</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª / ¬´–ß–µ—Ä–Ω–æ–≤–∏–∫¬ª –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –±–ª–æ–∫ ¬´–ü–∞–∫–µ—Ç–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è¬ª.</li>
        </ol>
        <p class="small text-muted">–ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏: 
            <a href="<?= htmlspecialchars($dashboardUrl, ENT_QUOTES, 'UTF-8'); ?>" target="_blank" rel="noopener">–î–∞—à–±–æ—Ä–¥</a>, 
            <a href="<?= htmlspecialchars($builderUrl, ENT_QUOTES, 'UTF-8'); ?>?ping=1" target="_blank" rel="noopener">Builder ping</a>, 
            <a href="<?= htmlspecialchars($publishUrl, ENT_QUOTES, 'UTF-8'); ?>?ping=1" target="_blank" rel="noopener">Publisher ping</a>, 
            <a href="<?= htmlspecialchars($massUrl, ENT_QUOTES, 'UTF-8'); ?>" target="_blank" rel="noopener">–ü–∞–∫–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º</a>.
        </p>
    </div>
</div>
<div class="panel panel-default">
    <div class="panel-heading">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</div>
    <div class="panel-body">
        <iframe class="tdp-iframe" src="<?= htmlspecialchars($dashboardUrl, ENT_QUOTES, 'UTF-8'); ?>" loading="lazy"></iframe>
    </div>
</div>
<?php
echofooter();
]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>
    <file name="engine/modules/technodom_dashboard.php">
        <operation action="create">
            <replacecode><![CDATA[<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);

if (!defined('DATALIFEENGINE')) {
    define('DATALIFEENGINE', true);
}

if (!defined('ROOT_DIR')) {
    define('ROOT_DIR', dirname(__FILE__, 2));
}

if (!defined('ENGINE_DIR')) {
    define('ENGINE_DIR', ROOT_DIR . '/engine');
}
require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';

include_once DLEPlugins::Check(ENGINE_DIR . '/inc/technodom_dashboard.php');

]]></replacecode>
            <enabled>1</enabled>
        </operation>
    </file>

<file name="engine/engine.php">
    <operation action="after">
        <searchcode><![CDATA[   case "changemail":
            include(DLEPlugins::Check(ENGINE_DIR . '/modules/changemail.php'));
            break;]]></searchcode>
        <replacecode><![CDATA[  case "technodom_parser":
            include(DLEPlugins::Check(ENGINE_DIR . '/modules/technodom_dashboard.php'));
            break;]]></replacecode>
        <enabled>1</enabled>
    </operation>
</file>
</dleplugin>
