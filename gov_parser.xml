<?xml version="1.0" encoding="utf-8"?>
<dleplugin>
	<name>gov_parser</name>
	<description>Парсинг, рерайт и публикация новостей gov.kz</description>
	<icon></icon>
	<version>0.2.0</version>
	<dleversion></dleversion>
	<versioncompare>greater</versioncompare>
	<upgradeurl></upgradeurl>
	<filedelete>0</filedelete>
	<needplugin></needplugin>
	<mnotice>0</mnotice>
	<mysqlinstall><![CDATA[CREATE TABLE IF NOT EXISTS {prefix}_gov_settings (
    id INT(11) NOT NULL PRIMARY KEY DEFAULT 1,
    settings TEXT NOT NULL,
    updated_at INT(11) NOT NULL DEFAULT 0
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO {prefix}_gov_settings (id, settings, updated_at)
VALUES (1, '{"gpt_model":"gpt-3.5-turbo","gpt_temperature":0.6,"target_category":1,"rewrite_enabled":1,"auto_publish":0,"main_image_target":"xfield:picture","gallery_target":"full_story_append","prompts_include_source":1,"ids_request_warn_ms":5000,"fetch_request_warn_ms":5000,"fetch_request_error_ms":15000,"prepare_min_length":400,"prepare_length_drop_warn":0.8,"rewrite_full_min_length":200,"rewrite_length_ratio_warn":0.4,"publish_request_warn_ms":5000,"publish_request_error_ms":20000}', UNIX_TIMESTAMP())
ON DUPLICATE KEY UPDATE updated_at = UNIX_TIMESTAMP();

CREATE TABLE IF NOT EXISTS {prefix}_gov_queue (
    id INT(11) NOT NULL AUTO_INCREMENT,
    source_id BIGINT(20) NOT NULL,
    status ENUM('new','fetched','prepared','ready','rewritten','published','error') NOT NULL DEFAULT 'new',
    rewrite_progress VARCHAR(32) NOT NULL DEFAULT '',
    payload_raw LONGTEXT NULL,
    payload_clean LONGTEXT NULL,
    payload_rewrite LONGTEXT NULL,
    payload_publish LONGTEXT NULL,
    meta LONGTEXT NULL,
    metrics LONGTEXT NULL,
    last_error TEXT NULL,
    last_error_at INT(11) NULL DEFAULT 0,
    retry_count SMALLINT(5) NOT NULL DEFAULT 0,
    published_url VARCHAR(255) NULL,
    locked_at INT(11) NULL,
    created_at INT(11) NOT NULL DEFAULT 0,
    updated_at INT(11) NOT NULL DEFAULT 0,
    PRIMARY KEY (id),
    UNIQUE KEY uniq_source (source_id),
    INDEX source_idx (source_id),
    INDEX status_idx (status),
    INDEX updated_at_idx (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS {prefix}_gov_logs (
    id INT(11) NOT NULL AUTO_INCREMENT,
    level VARCHAR(16) NOT NULL,
    stage VARCHAR(32) NOT NULL,
    source_id BIGINT(20) NULL,
    message TEXT NOT NULL,
    context TEXT NULL,
    duration_ms INT(11) NULL,
    debug_payload LONGTEXT NULL,
    created_at INT(11) NOT NULL,
    PRIMARY KEY (id),
    INDEX stage_idx (stage),
    INDEX level_idx (level),
    INDEX source_idx (source_id),
    INDEX created_idx (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO {prefix}_admin_sections (`name`, `title`, `descr`, `icon`, `allow_groups`)
VALUES ('gov_parser', 'Парсер gov новостей', 'gov_parser', '', '1')
ON DUPLICATE KEY UPDATE
    `title` = VALUES(`title`),
    `descr` = VALUES(`descr`),
    `icon` = VALUES(`icon`),
    `allow_groups` = VALUES(`allow_groups`);]]></mysqlinstall>
	<mysqlupgrade><![CDATA[]]></mysqlupgrade>
	<mysqlenable><![CDATA[]]></mysqlenable>
	<mysqldisable><![CDATA[]]></mysqldisable>
	<mysqldelete><![CDATA[DROP TABLE IF EXISTS {prefix}_gov_logs;
DROP TABLE IF EXISTS {prefix}_gov_queue;
DROP TABLE IF EXISTS {prefix}_gov_settings;
DELETE FROM {prefix}_admin_sections WHERE name='gov_parser';]]></mysqldelete>
	<phpinstall><![CDATA[]]></phpinstall>
	<phpupgrade><![CDATA[if (!defined('DATALIFEENGINE')) {
    return;
}

global $db, $config;

$tablePrefix = defined('PREFIX') ? PREFIX : ($config['dbprefix'] ?? 'dle');
$queueTable = $tablePrefix . '_gov_queue';
$logsTable = $tablePrefix . '_gov_logs';
$settingsTable = $tablePrefix . '_gov_settings';

if (!function_exists('gov_parser_column_exists')) {
    function gov_parser_column_exists($table, $column)
    {
        global $db;

        $column = $db->safesql($column);
        $row = $db->super_query("SHOW COLUMNS FROM {$table} LIKE '{$column}'");

        return !empty($row);
    }
}

if (!function_exists('gov_parser_index_exists')) {
    function gov_parser_index_exists($table, $index)
    {
        global $db;

        $index = $db->safesql($index);
        $result = $db->query("SHOW INDEX FROM {$table} WHERE Key_name = '{$index}'");
        $exists = $result && $db->num_rows($result) > 0;

        if ($result) {
            $db->free($result);
        }

        return $exists;
    }
}

$queueColumns = [
    'rewrite_progress' => "ALTER TABLE {$queueTable} ADD COLUMN `rewrite_progress` VARCHAR(32) NOT NULL DEFAULT '' AFTER `status`",
    'payload_clean' => "ALTER TABLE {$queueTable} ADD COLUMN `payload_clean` LONGTEXT NULL AFTER `payload_raw`",
    'payload_publish' => "ALTER TABLE {$queueTable} ADD COLUMN `payload_publish` LONGTEXT NULL AFTER `payload_rewrite`",
    'metrics' => "ALTER TABLE {$queueTable} ADD COLUMN `metrics` LONGTEXT NULL AFTER `meta`",
    'last_error' => "ALTER TABLE {$queueTable} ADD COLUMN `last_error` TEXT NULL AFTER `metrics`",
    'last_error_at' => "ALTER TABLE {$queueTable} ADD COLUMN `last_error_at` INT(11) NULL DEFAULT 0 AFTER `last_error`",
    'retry_count' => "ALTER TABLE {$queueTable} ADD COLUMN `retry_count` SMALLINT(5) NOT NULL DEFAULT 0 AFTER `last_error_at`",
    'published_url' => "ALTER TABLE {$queueTable} ADD COLUMN `published_url` VARCHAR(255) NULL AFTER `retry_count`",
];

foreach ($queueColumns as $column => $sql) {
    if (!gov_parser_column_exists($queueTable, $column)) {
        $db->query($sql);
    }
}

$db->query("ALTER TABLE {$queueTable} MODIFY COLUMN `status` ENUM('new','fetched','prepared','ready','rewritten','published','error') NOT NULL DEFAULT 'new'");

if (!gov_parser_index_exists($queueTable, 'source_idx')) {
    $db->query("ALTER TABLE {$queueTable} ADD INDEX `source_idx` (`source_id`)");
}

if (!gov_parser_index_exists($queueTable, 'status_idx')) {
    $db->query("ALTER TABLE {$queueTable} ADD INDEX `status_idx` (`status`)");
}

if (!gov_parser_index_exists($queueTable, 'updated_at_idx')) {
    $db->query("ALTER TABLE {$queueTable} ADD INDEX `updated_at_idx` (`updated_at`)");
}

$logColumns = [
    'duration_ms' => "ALTER TABLE {$logsTable} ADD COLUMN `duration_ms` INT(11) NULL AFTER `context`",
    'debug_payload' => "ALTER TABLE {$logsTable} ADD COLUMN `debug_payload` LONGTEXT NULL AFTER `duration_ms`",
];

foreach ($logColumns as $column => $sql) {
    if (!gov_parser_column_exists($logsTable, $column)) {
        $db->query($sql);
    }
}

if (!gov_parser_index_exists($logsTable, 'source_idx')) {
    $db->query("ALTER TABLE {$logsTable} ADD INDEX `source_idx` (`source_id`)");
}

if (!gov_parser_index_exists($logsTable, 'created_idx')) {
    $db->query("ALTER TABLE {$logsTable} ADD INDEX `created_idx` (`created_at`)");
}

$row = $db->super_query("SELECT settings FROM {$settingsTable} WHERE id=1 LIMIT 1");

if (isset($row['settings'])) {
    $settings = json_decode($row['settings'], true);
    if (!is_array($settings)) {
        $settings = [];
    }

    $defaults = [
        'ids_request_warn_ms' => 5000,
        'fetch_request_warn_ms' => 5000,
        'fetch_request_error_ms' => 15000,
        'prepare_min_length' => 400,
        'prepare_length_drop_warn' => 0.8,
        'rewrite_full_min_length' => 200,
        'rewrite_length_ratio_warn' => 0.4,
        'publish_request_warn_ms' => 5000,
        'publish_request_error_ms' => 20000,
        'main_image_target' => 'xfield:picture',
        'gallery_target' => 'full_story_append',
    ];

    $changed = false;

    foreach ($defaults as $key => $value) {
        if (!array_key_exists($key, $settings)) {
            $settings[$key] = $value;
            $changed = true;
        }
    }

    if ($changed) {
        $settingsJson = json_encode($settings, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
        $db->query("UPDATE {$settingsTable} SET settings='" . $db->safesql($settingsJson) . "', updated_at=UNIX_TIMESTAMP() WHERE id=1");
    }
}]]></phpupgrade>
	<phpenable><![CDATA[]]></phpenable>
	<phpdisable><![CDATA[]]></phpdisable>
	<phpdelete><![CDATA[]]></phpdelete>
	<notice><![CDATA[Добавлен модуль gov_parser]]></notice>
	<file name="engine/inc/gov_parser.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
if (!defined('DATALIFEENGINE') || !defined('LOGGED_IN')) {
    header("HTTP/1.1 403 Forbidden");
    header('Location: ../../');
    die('Hacking attempt!');
}

if (!class_exists('DLEPlugins')) {
    include_once ENGINE_DIR . '/classes/plugins.class.php';
}

include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

$controller = new GovParser_AdminController($member_id, $config, $db);
$controller->handle($_REQUEST);
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/engine.php">
		<operation action="after">
			<searchcode><![CDATA[	case "changemail":
		include(DLEPlugins::Check(ENGINE_DIR . '/modules/changemail.php'));
		break;]]></searchcode>
			<replacecode><![CDATA[	case "gov_parser_ids":
		include(DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_ids.php'));
		break;

        case "gov_parser_fetch":
                include(DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_fetch.php'));
                break;

        case "gov_parser_prepare":
                include(DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_prepare.php'));
                break;

        case "gov_parser_rewrite":
                include(DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_rewrite.php'));
                break;

	case "gov_parser_publish":
		include(DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_publish.php'));
		break;

	case "gov_parser_run":
		include(DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_run.php'));
		break;]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_bootstrap.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
if (!defined('DATALIFEENGINE')) {
    die('Hacking attempt!');
}

if (!class_exists('DLEPlugins')) {
    include_once ENGINE_DIR . '/classes/plugins.class.php';
}

include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_autoload.php');

if (!function_exists('gov_parser_require_password')) {
    function gov_parser_require_password(): void
    {
        static $govParserPasswordValidated = false;

        if ($govParserPasswordValidated) {
            return;
        }

        global $db;

        if (!isset($db)) {
            $govParserPasswordValidated = true;
            return;
        }

        $settings = [];
        try {
            $configRepository = new GovParser_ConfigRepository($db, PREFIX);
            $settings = $configRepository->load();
        } catch (\Throwable $e) {
            $settings = [];
        }

        $secret = trim((string)($settings['execution_secret'] ?? ''));
        if ($secret !== '') {
            $secretCandidates = [];

            foreach (['secret', 'passecret'] as $param) {
                if (isset($_REQUEST[$param])) {
                    $secretCandidates[] = (string)$_REQUEST[$param];
                }
            }

            if (!empty($_SERVER['HTTP_GOV_PARSER_SECRET'])) {
                $secretCandidates[] = (string)$_SERVER['HTTP_GOV_PARSER_SECRET'];
            }

            if (!empty($_SERVER['HTTP_X_GOV_PARSER_SECRET'])) {
                $secretCandidates[] = (string)$_SERVER['HTTP_X_GOV_PARSER_SECRET'];
            }

            $providedSecret = '';
            foreach ($secretCandidates as $candidate) {
                $candidate = trim($candidate);
                if ($candidate !== '') {
                    $providedSecret = $candidate;
                    break;
                }
            }

            $secretValid = false;
            if ($providedSecret !== '') {
                if (function_exists('hash_equals')) {
                    $secretValid = hash_equals($secret, $providedSecret);
                } else {
                    $secretValid = $secret === $providedSecret;
                }
            }

            if (!$secretValid) {
                header('HTTP/1.1 403 Forbidden');
                echo 'gov_parser: access denied';
                exit;
            }

            $govParserPasswordValidated = true;
            return;
        }

        $passwordHash = (string)($settings['execution_password_hash'] ?? '');
        $useFallbackHash = !empty($settings['execution_password_fallback']);
        if ($passwordHash === '') {
            $govParserPasswordValidated = true;
            return;
        }

        $candidates = [];

        if (isset($_REQUEST['gov_parser_password'])) {
            $candidates[] = (string)$_REQUEST['gov_parser_password'];
        }

        if (isset($_REQUEST['gov_parser_token'])) {
            $candidates[] = (string)$_REQUEST['gov_parser_token'];
        }

        if (!empty($_SERVER['HTTP_GOV_PARSER_PASSWORD'])) {
            $candidates[] = (string)$_SERVER['HTTP_GOV_PARSER_PASSWORD'];
        }

        if (!empty($_SERVER['HTTP_X_GOV_PARSER_PASSWORD'])) {
            $candidates[] = (string)$_SERVER['HTTP_X_GOV_PARSER_PASSWORD'];
        }

        $provided = '';
        foreach ($candidates as $candidate) {
            $candidate = trim($candidate);
            if ($candidate !== '') {
                $provided = $candidate;
                break;
            }
        }

        $isValid = false;
        if ($provided !== '') {
            if ($useFallbackHash) {
                $expected = hash('sha256', $provided);
                if ($expected !== '') {
                    if (function_exists('hash_equals')) {
                        $isValid = hash_equals($passwordHash, $expected);
                    } else {
                        $isValid = $passwordHash === $expected;
                    }
                }
            } elseif (function_exists('password_verify')) {
                $isValid = password_verify($provided, $passwordHash);
            }
        }

        if (!$isValid) {
            header('HTTP/1.1 403 Forbidden');
            echo 'gov_parser: access denied';
            exit;
        }

        if ($useFallbackHash) {
            if (function_exists('password_hash') && function_exists('password_verify')) {
                try {
                    $settings['execution_password_hash'] = password_hash($provided, PASSWORD_DEFAULT);
                    unset($settings['execution_password_fallback']);
                    $configRepository = new GovParser_ConfigRepository($db, PREFIX);
                    $configRepository->save($settings);
                } catch (\Throwable $e) {
                    // ignore
                }
            }
        } elseif (function_exists('password_needs_rehash') && password_needs_rehash($passwordHash, PASSWORD_DEFAULT)) {
            try {
                $settings['execution_password_hash'] = password_hash($provided, PASSWORD_DEFAULT);
                unset($settings['execution_password_fallback']);
                $configRepository = new GovParser_ConfigRepository($db, PREFIX);
                $configRepository->save($settings);
            } catch (\Throwable $e) {
                // ignore errors while attempting to rehash
            }
        }

        $govParserPasswordValidated = true;
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_autoload.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
static $govParserAutoloadRegistered;

if (!$govParserAutoloadRegistered) {
    $govParserAutoloadRegistered = true;

    spl_autoload_register(function ($class) {
        static $map = [
            'GovParser_ConfigRepository' => 'gov_parser_config_repository.php',
            'GovParser_Logger' => 'gov_parser_logger.php',
            'GovParser_QueueRepository' => 'gov_parser_queue_repository.php',
            'GovParser_HttpClient' => 'gov_parser_http_client.php',
            'GovParser_GovApiClient' => 'gov_parser_gov_api_client.php',
            'GovParser_TelegramIdCollector' => 'gov_parser_telegram_id_collector.php',
            'GovParser_PayloadHelper' => 'gov_parser_payload_helper.php',
            'GovParser_ContentPreparationService' => 'gov_parser_content_preparation_service.php',
            'GovParser_RewriteService' => 'gov_parser_rewrite_service.php',
            'GovParser_AdminController' => 'gov_parser_admin_controller.php',
            'GovParser_CategoryManager' => 'gov_parser_category_manager.php',
        ];

        if (!isset($map[$class])) {
            return;
        }

        include_once DLEPlugins::Check(ENGINE_DIR . '/modules/' . $map[$class]);
    });
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_category_manager.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_CategoryManager
{
    private $db;
    /** @var string */
    private $table;

    public function __construct($db, $tablePrefix)
    {
        $this->db = $db;
        $this->table = $tablePrefix . '_category';
    }

    public function ensureSubcategory(int $parentId, string $sourceName): ?int
    {
        $parentId = (int)$parentId;
        $sourceName = $this->normalizeName($sourceName);
        if ($parentId <= 0 || $sourceName === '') {
            return null;
        }

        $existing = $this->findExisting($parentId, $sourceName);
        if ($existing !== null) {
            return $existing;
        }

        $parent = $this->db->super_query("SELECT * FROM {$this->table} WHERE id={$parentId} LIMIT 1");
        if (!$parent || !is_array($parent)) {
            return null;
        }

        $slug = $this->buildSlug($sourceName);
        if ($slug === '') {
            $slug = 'tg-' . md5($sourceName);
        }
        $slug = $this->ensureUniqueSlug($slug);

        $insert = $this->buildInsertData($parent, $parentId, $sourceName, $slug);
        if (!$insert) {
            return null;
        }

        $columns = [];
        $values = [];
        foreach ($insert as $key => $value) {
            $columns[] = $key;
            if ($value === null) {
                $values[] = 'NULL';
            } else {
                $values[] = "'" . $this->db->safesql($value) . "'";
            }
        }

        $sql = "INSERT INTO {$this->table} (" . implode(',', $columns) . ") VALUES (" . implode(',', $values) . ")";
        $this->db->query($sql);

        $newId = (int)$this->db->insert_id();
        if ($newId > 0) {
            $this->flushCategoryCache();
            return $newId;
        }

        return null;
    }

    private function normalizeName(string $value): string
    {
        $value = trim($value);
        if ($value === '') {
            return '';
        }

        return preg_replace('/\s+/u', ' ', $value);
    }

    private function findExisting(int $parentId, string $name): ?int
    {
        $safeName = $this->db->safesql($name);
        $row = $this->db->super_query("SELECT id FROM {$this->table} WHERE parentid={$parentId} AND name='{$safeName}' LIMIT 1");
        if (!empty($row['id'])) {
            return (int)$row['id'];
        }

        $slug = $this->buildSlug($name);
        if ($slug !== '') {
            $safeSlug = $this->db->safesql($slug);
            $row = $this->db->super_query("SELECT id FROM {$this->table} WHERE parentid={$parentId} AND alt_name='{$safeSlug}' LIMIT 1");
            if (!empty($row['id'])) {
                return (int)$row['id'];
            }
        }

        return null;
    }

    private function buildInsertData(array $parent, int $parentId, string $name, string $slug): array
    {
        $insert = [];
        foreach ($parent as $key => $value) {
            if (is_int($key) || $key === 'id') {
                continue;
            }
            $insert[$key] = $value;
        }

        $insert['parentid'] = $parentId;
        $insert['name'] = $name;
        $insert['alt_name'] = $slug;

        $posRow = $this->db->super_query("SELECT MAX(posi) AS max_pos FROM {$this->table} WHERE parentid={$parentId}");
        if (isset($insert['posi'])) {
            $insert['posi'] = (int)($posRow['max_pos'] ?? 0) + 1;
        }

        $resetKeys = [
            'descr',
            'keywords',
            'short_tpl',
            'full_tpl',
            'metatitle',
            'metadescr',
            'metakeywords',
            'icon',
            'dzen_url',
            'rss_title',
            'rss_description',
            'rss_image',
            'tpl_prefix',
        ];

        foreach ($resetKeys as $key) {
            if (array_key_exists($key, $insert)) {
                $insert[$key] = '';
            }
        }

        return $insert;
    }

    private function buildSlug(string $value): string
    {
        $value = trim($value);
        if ($value === '') {
            return '';
        }

        if (function_exists('totranslit')) {
            $slug = totranslit($value, true, false);
        } else {
            $slug = $this->fallbackTransliterate($value);
        }

        $slug = preg_replace('/[^a-z0-9-]+/i', '-', (string)$slug);
        $slug = trim($slug, '-');
        if ($slug === '') {
            return '';
        }

        if (function_exists('mb_substr')) {
            $slug = mb_substr($slug, 0, 60);
        } else {
            $slug = substr($slug, 0, 60);
        }

        return trim($slug, '-');
    }

    private function fallbackTransliterate(string $value): string
    {
        $lower = function_exists('mb_strtolower') ? mb_strtolower($value, 'UTF-8') : strtolower($value);
        $trans = function_exists('iconv') ? iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', $lower) : $lower;
        if ($trans === false || $trans === null) {
            $trans = $lower;
        }

        return $trans;
    }

    private function ensureUniqueSlug(string $slug): string
    {
        $slug = trim($slug, '-');
        if ($slug === '') {
            $slug = 'tg-category';
        }

        $base = $slug;
        $counter = 1;
        while ($this->slugExists($slug)) {
            $counter++;
            $candidate = $base . '-' . $counter;
            if (function_exists('mb_substr')) {
                $candidate = mb_substr($candidate, 0, 60);
            } else {
                $candidate = substr($candidate, 0, 60);
            }
            $slug = trim($candidate, '-');
            if ($slug === '') {
                $slug = $base . '-' . $counter;
            }
        }

        return $slug;
    }

    private function slugExists(string $slug): bool
    {
        $safe = $this->db->safesql($slug);
        $row = $this->db->super_query("SELECT id FROM {$this->table} WHERE alt_name='{$safe}' LIMIT 1");
        return !empty($row['id']);
    }

    private function flushCategoryCache(): void
    {
        if (function_exists('clear_cache')) {
            clear_cache(['category', 'categorynews']);
        } elseif (defined('ENGINE_DIR')) {
            @unlink(ENGINE_DIR . '/cache/system/category.php');
        }
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_config_repository.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_ConfigRepository
{
    private $db;
    private $table;

    public function __construct($db, $tablePrefix)
    {
        $this->db = $db;
        $this->table = $tablePrefix . '_gov_settings';
    }

    public function load(): array
    {
        $row = $this->db->super_query("SELECT settings FROM {$this->table} WHERE id=1");
        if (!$row || empty($row['settings'])) {
            return [];
        }

        $decoded = json_decode($row['settings'], true);
        return is_array($decoded) ? $decoded : [];
    }

    public function save(array $settings): void
    {
        $json = json_encode($settings, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
        $timestamp = time();

        $this->db->query("REPLACE INTO {$this->table} (id, settings, updated_at) VALUES (1, '" . $this->db->safesql($json) . "', $timestamp)");
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_logger.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_Logger
{
    private $db;
    private $table;

    public function __construct($db, $tablePrefix)
    {
        $this->db = $db;
        $this->table = $tablePrefix . '_gov_logs';
    }

    public function log(string $level, string $stage, ?int $sourceId, string $message, array $context = []): void
    {
        $contextJson = json_encode($context, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
        $this->db->query("INSERT INTO {$this->table} (level, stage, source_id, message, context, created_at) VALUES ('" . $this->db->safesql($level) . "', '" . $this->db->safesql($stage) . "', " . ($sourceId ? (int)$sourceId : 'NULL') . ", '" . $this->db->safesql($message) . "', '" . $this->db->safesql($contextJson) . "', " . time() . ")");
    }

    public function getRecent(int $limit = 20): array
    {
        $limit = max(1, min(100, (int)$limit));
        $rows = $this->db->super_query(
            "SELECT id, level, stage, source_id, message, context, created_at FROM {$this->table} ORDER BY id DESC LIMIT $limit",
            true
        );

        return is_array($rows) ? $rows : [];
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_queue_repository.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_QueueRepository
{
    private $db;
    private $table;

    public function __construct($db, $tablePrefix)
    {
        $this->db = $db;
        $this->table = $tablePrefix . '_gov_queue';
    }

    public function createOrTouch(int $sourceId, array $meta = []): void
    {
        $sourceId = (int)$sourceId;
        $now = time();

        $meta = array_filter($meta, static function ($value) {
            return $value !== null && $value !== '';
        });

        $existing = $this->db->super_query("SELECT id, meta FROM {$this->table} WHERE source_id={$sourceId} LIMIT 1");

        if ($existing) {
            $id = (int)$existing['id'];
            $mergedMeta = [];
            if (!empty($existing['meta'])) {
                $decoded = json_decode($existing['meta'], true);
                if (is_array($decoded)) {
                    $mergedMeta = $decoded;
                }
            }

            if ($meta) {
                foreach ($meta as $key => $value) {
                    $mergedMeta[$key] = $value;
                }
            }

            $setParts = ["updated_at=$now"];
            if ($mergedMeta) {
                $metaJson = $this->db->safesql(json_encode($mergedMeta, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES));
                $setParts[] = "meta='" . $metaJson . "'";
            }

            $this->db->query("UPDATE {$this->table} SET " . implode(', ', $setParts) . " WHERE id=$id");
            return;
        }

        $metaSql = 'NULL';
        if ($meta) {
            $metaJson = $this->db->safesql(json_encode($meta, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES));
            $metaSql = "'" . $metaJson . "'";
        }

        $this->db->query("INSERT INTO {$this->table} (source_id, status, meta, created_at, updated_at) VALUES ($sourceId, 'new', $metaSql, $now, $now)");
    }

    public function claimBatch(string $status, int $limit = 10): array
    {
        $limit = max(1, min(100, (int)$limit));
        $now = time();
        $statusSql = $this->db->safesql($status);
        $this->db->query("UPDATE {$this->table} SET locked_at = $now WHERE status='$statusSql' AND (locked_at IS NULL OR locked_at < ($now - 600)) ORDER BY updated_at ASC LIMIT $limit");
        $result = $this->db->super_query("SELECT * FROM {$this->table} WHERE locked_at = $now AND status='$statusSql'", true);
        return is_array($result) ? $result : [];
    }

    public function updateStatus(int $id, string $status, array $fields = []): void
    {
        $id = (int)$id;
        $statusSql = $this->db->safesql($status);
        $updates = ["status='$statusSql'", 'updated_at=' . time(), 'locked_at=NULL'];
        foreach ($fields as $key => $value) {
            if ($value === null) {
                $updates[] = "$key = NULL";
            } else {
                $updates[] = "$key='" . $this->db->safesql($value) . "'";
            }
        }
        $this->db->query("UPDATE {$this->table} SET " . implode(',', $updates) . " WHERE id=$id");
    }

    public function getStats(): array
    {
        $rows = $this->db->super_query("SELECT status, COUNT(*) AS cnt FROM {$this->table} GROUP BY status", true);
        $stats = [
            'new' => 0,
            'fetched' => 0,
            'ready' => 0,
            'rewritten' => 0,
            'published' => 0,
            'error' => 0,
        ];

        if (is_array($rows)) {
            foreach ($rows as $row) {
                $status = $row['status'] ?? '';
                if (isset($stats[$status])) {
                    $stats[$status] = (int)$row['cnt'];
                }
            }
        }

        $stats['total'] = array_sum($stats);

        return $stats;
    }

    public function getRecent(int $limit = 20): array
    {
        $limit = max(1, min(100, (int)$limit));
        $rows = $this->db->super_query(
            "SELECT id, source_id, status, meta, updated_at FROM {$this->table} ORDER BY updated_at DESC LIMIT $limit",
            true
        );

        return is_array($rows) ? $rows : [];
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_payload_helper.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_PayloadHelper
{
    private const BODY_FIELD_PRIORITY = [
        ['body'],
        ['text'],
        ['body_html'],
        ['bodyHtml'],
        ['content'],
        ['data', 'body'],
        ['data', 'text'],
    ];

    private const BODY_COLLECTION_FIELDS = [
        'newsContents',
        'newsContent',
        'contents',
        'translations',
        'localizedContents',
        'contentItems',
        'items',
    ];

    private const TITLE_FIELDS = [
        ['title_ru'],
        ['title'],
        ['name_ru'],
        ['name'],
        ['header'],
        ['headline'],
        ['title_en'],
        ['title_kz'],
        ['data', 'title'],
    ];

    private const PREVIEW_FIELDS = [
        ['announce'],
        ['announce_ru'],
        ['announce_kz'],
        ['description'],
        ['short_description'],
        ['shortDescription'],
        ['summary'],
        ['lead'],
        ['preview'],
        ['data', 'announce'],
    ];

    public static function extractBody(array $payload, string $lang = 'ru'): array
    {
        $langVariants = self::buildLangVariants($lang);
        $checked = [];

        foreach (self::BODY_FIELD_PRIORITY as $path) {
            $checked[] = implode('.', $path);
            $value = self::valueByPath($payload, $path);
            if ($value === null) {
                continue;
            }

            $raw = self::resolveValue($value, $langVariants);
            if ($raw === '') {
                continue;
            }

            $candidate = self::prepareBodyCandidate($raw, false);
            if ($candidate['valid']) {
                $candidate['source'] = implode('.', $path);
                $candidate['checked'] = $checked;
                return $candidate;
            }
        }

        foreach (self::BODY_COLLECTION_FIELDS as $key) {
            if (empty($payload[$key]) || !is_array($payload[$key])) {
                continue;
            }

            $checked[] = $key;
            $raw = self::extractFromCollection($payload[$key], $langVariants);
            if ($raw === '') {
                continue;
            }

            $candidate = self::prepareBodyCandidate($raw, false);
            if ($candidate['valid']) {
                $candidate['source'] = $key;
                $candidate['checked'] = $checked;
                return $candidate;
            }
        }

        $checked[] = 'deep_search';
        $raw = self::resolveValue($payload, $langVariants, 0, true);
        if ($raw !== '') {
            $candidate = self::prepareBodyCandidate($raw, true);
            if ($candidate['valid']) {
                $candidate['source'] = 'deep_search';
                $candidate['checked'] = $checked;
                return $candidate;
            }
        }

        return [
            'html' => '',
            'plain' => '',
            'plain_length' => 0,
            'media_only' => false,
            'valid' => false,
            'source' => null,
            'checked' => $checked,
        ];
    }

    public static function extractTitle(array $payload, string $lang = 'ru'): string
    {
        $langVariants = self::buildLangVariants($lang);

        foreach (self::TITLE_FIELDS as $path) {
            $value = self::valueByPath($payload, $path);
            if ($value === null) {
                continue;
            }

            $title = self::resolveScalar($value, $langVariants, 0, 5);
            if ($title !== '') {
                return $title;
            }
        }

        if (!empty($payload['newsContents']) && is_array($payload['newsContents'])) {
            foreach ($payload['newsContents'] as $item) {
                if (!is_array($item)) {
                    continue;
                }

                $title = self::resolveScalar($item['title'] ?? null, $langVariants, 0, 5);
                if ($title !== '') {
                    return $title;
                }
            }
        }

        return '';
    }

    public static function extractPreview(array $payload, string $lang = 'ru'): string
    {
        $langVariants = self::buildLangVariants($lang);

        foreach (self::PREVIEW_FIELDS as $path) {
            $value = self::valueByPath($payload, $path);
            if ($value === null) {
                continue;
            }

            $preview = self::resolveScalar($value, $langVariants, 0, 15);
            if ($preview !== '') {
                return $preview;
            }
        }

        if (!empty($payload['newsContents']) && is_array($payload['newsContents'])) {
            foreach ($payload['newsContents'] as $item) {
                if (!is_array($item)) {
                    continue;
                }

                $preview = self::resolveScalar($item['announce'] ?? ($item['description'] ?? null), $langVariants, 0, 15);
                if ($preview !== '') {
                    return $preview;
                }
            }
        }

        return '';
    }

    public static function extractFieldByPaths(array $payload, array $paths, string $lang = 'ru', int $minLength = 1): string
    {
        if (!$paths) {
            return '';
        }

        $langVariants = self::buildLangVariants($lang);

        foreach ($paths as $path) {
            if (!is_array($path)) {
                $path = [$path];
            }

            $value = self::valueByPath($payload, $path);
            if ($value === null) {
                continue;
            }

            $resolved = self::resolveScalar($value, $langVariants, 0, max(1, (int)$minLength));
            if ($resolved !== '') {
                return $resolved;
            }
        }

        return '';
    }

    public static function htmlToPlain(string $html): string
    {
        return self::plainFromHtml($html);
    }

    public static function stringLength(string $value): int
    {
        return self::strLength($value);
    }

    private static function buildLangVariants(string $lang): array
    {
        $lang = strtolower(trim($lang));
        if ($lang === '') {
            $lang = 'ru';
        }

        $variants = [$lang];
        $normalized = str_replace(['-', '_'], '', $lang);
        if (!in_array($normalized, $variants, true)) {
            $variants[] = $normalized;
        }
        if (strpos($lang, '-') !== false) {
            $variants[] = str_replace('-', '_', $lang);
        }
        if (strpos($lang, '_') !== false) {
            $variants[] = str_replace('_', '-', $lang);
        }
        $variants[] = 'ru';
        $variants[] = 'ru-ru';
        $variants[] = 'ru_ru';

        $variants = array_map(function ($value) {
            return strtolower((string)$value);
        }, $variants);

        return array_values(array_unique(array_filter($variants)));
    }

    private static function valueByPath(array $payload, array $path)
    {
        $current = $payload;
        foreach ($path as $segment) {
            if (is_array($current) && array_key_exists($segment, $current)) {
                $current = $current[$segment];
            } else {
                return null;
            }
        }

        return $current;
    }

    private static function resolveValue($value, array $langVariants, int $depth = 0, bool $allowLoose = false): string
    {
        if ($depth > 8) {
            return '';
        }

        if (is_string($value)) {
            $trim = trim($value);
            if ($trim === '') {
                return '';
            }

            if (self::looksLikeJson($trim)) {
                $decoded = json_decode($trim, true);
                if (is_array($decoded)) {
                    $decodedValue = self::resolveValue($decoded, $langVariants, $depth + 1, $allowLoose);
                    if ($decodedValue !== '') {
                        return $decodedValue;
                    }
                }
            }

            return $trim;
        }

        if (is_object($value)) {
            $value = (array)$value;
        }

        if (!is_array($value)) {
            return '';
        }

        foreach ($langVariants as $variant) {
            if (array_key_exists($variant, $value)) {
                $maybe = self::resolveValue($value[$variant], $langVariants, $depth + 1, $allowLoose);
                if ($maybe !== '') {
                    return $maybe;
                }
            }
        }

        $contentKeys = ['body', 'bodyHtml', 'body_html', 'text', 'content', 'html', 'value', 'description', 'fullText', 'full_text'];
        foreach ($contentKeys as $key) {
            if (array_key_exists($key, $value)) {
                $maybe = self::resolveValue($value[$key], $langVariants, $depth + 1, $allowLoose);
                if ($maybe !== '') {
                    return $maybe;
                }
            }
        }

        foreach ($value as $item) {
            if (!is_array($item) && !is_object($item)) {
                continue;
            }

            $itemArray = (array)$item;
            $itemLang = null;
            foreach (['language', 'lang', 'locale', 'languageCode', 'langCode'] as $langKey) {
                if (!empty($itemArray[$langKey])) {
                    $itemLang = strtolower((string)$itemArray[$langKey]);
                    break;
                }
            }

            if ($itemLang !== null) {
                $itemNormalized = str_replace(['-', '_'], '', $itemLang);
                foreach ($langVariants as $variant) {
                    $variantNormalized = str_replace(['-', '_'], '', strtolower($variant));
                    if ($itemLang === strtolower($variant) || $itemNormalized === $variantNormalized) {
                        $maybe = self::resolveValue($itemArray, $langVariants, $depth + 1, $allowLoose);
                        if ($maybe !== '') {
                            return $maybe;
                        }
                    }
                }
            }
        }

        if ($allowLoose) {
            foreach ($value as $item) {
                if (is_string($item)) {
                    $trim = trim($item);
                    if ($trim !== '') {
                        return $trim;
                    }
                }
            }
        }

        foreach ($value as $item) {
            $maybe = self::resolveValue($item, $langVariants, $depth + 1, $allowLoose);
            if ($maybe !== '') {
                return $maybe;
            }
        }

        return '';
    }

    private static function resolveScalar($value, array $langVariants, int $depth = 0, int $minLength = 0): string
    {
        if ($depth > 6) {
            return '';
        }

        if (is_string($value)) {
            $trim = trim(strip_tags((string)$value));
            if ($trim === '') {
                return '';
            }

            if (self::looksLikeJson($trim)) {
                $decoded = json_decode($trim, true);
                if (is_array($decoded)) {
                    return self::resolveScalar($decoded, $langVariants, $depth + 1, $minLength);
                }
            }

            $plain = preg_replace('/\s+/u', ' ', $trim);
            $plain = trim($plain);
            if ($plain === '') {
                return '';
            }

            if ($minLength > 0 && self::strLength($plain) < $minLength) {
                return '';
            }

            return $plain;
        }

        if (is_object($value)) {
            $value = (array)$value;
        }

        if (!is_array($value)) {
            return '';
        }

        foreach ($langVariants as $variant) {
            if (array_key_exists($variant, $value)) {
                $maybe = self::resolveScalar($value[$variant], $langVariants, $depth + 1, $minLength);
                if ($maybe !== '') {
                    return $maybe;
                }
            }
        }

        $keys = ['title', 'name', 'header', 'headline', 'text', 'value', 'description', 'announce', 'preview', 'shortDescription', 'short_description', 'summary', 'lead'];
        foreach ($keys as $key) {
            if (array_key_exists($key, $value)) {
                $maybe = self::resolveScalar($value[$key], $langVariants, $depth + 1, $minLength);
                if ($maybe !== '') {
                    return $maybe;
                }
            }
        }

        foreach ($value as $item) {
            if (!is_array($item) && !is_object($item)) {
                continue;
            }

            $itemArray = (array)$item;
            $itemLang = null;
            foreach (['language', 'lang', 'locale', 'languageCode', 'langCode'] as $langKey) {
                if (!empty($itemArray[$langKey])) {
                    $itemLang = strtolower((string)$itemArray[$langKey]);
                    break;
                }
            }

            if ($itemLang !== null) {
                $itemNormalized = str_replace(['-', '_'], '', $itemLang);
                foreach ($langVariants as $variant) {
                    $variantNormalized = str_replace(['-', '_'], '', strtolower($variant));
                    if ($itemLang === strtolower($variant) || $itemNormalized === $variantNormalized) {
                        $maybe = self::resolveScalar($itemArray, $langVariants, $depth + 1, $minLength);
                        if ($maybe !== '') {
                            return $maybe;
                        }
                    }
                }
            }
        }

        foreach ($value as $item) {
            $maybe = self::resolveScalar($item, $langVariants, $depth + 1, $minLength);
            if ($maybe !== '') {
                return $maybe;
            }
        }

        return '';
    }

    private static function extractFromCollection(array $items, array $langVariants): string
    {
        foreach ($items as $item) {
            if (!is_array($item) && !is_object($item)) {
                continue;
            }

            $itemArray = (array)$item;
            $itemLang = null;
            foreach (['language', 'lang', 'locale', 'languageCode', 'langCode'] as $langKey) {
                if (!empty($itemArray[$langKey])) {
                    $itemLang = strtolower((string)$itemArray[$langKey]);
                    break;
                }
            }

            if ($itemLang !== null) {
                $itemNormalized = str_replace(['-', '_'], '', $itemLang);
                foreach ($langVariants as $variant) {
                    $variantNormalized = str_replace(['-', '_'], '', strtolower($variant));
                    if ($itemLang === strtolower($variant) || $itemNormalized === $variantNormalized) {
                        $maybe = self::resolveValue($itemArray, $langVariants);
                        if ($maybe !== '') {
                            return $maybe;
                        }
                    }
                }
            }
        }

        foreach ($items as $item) {
            $maybe = self::resolveValue($item, $langVariants);
            if ($maybe !== '') {
                return $maybe;
            }
        }

        return '';
    }

    private static function prepareBodyCandidate(string $html, bool $strict): array
    {
        $html = trim($html);
        if ($html === '') {
            return [
                'html' => '',
                'plain' => '',
                'plain_length' => 0,
                'media_only' => false,
                'valid' => false,
            ];
        }

        $plain = self::plainFromHtml($html);
        $plainLength = self::strLength($plain);
        $hasHtmlTags = stripos($html, '<p') !== false
            || stripos($html, '<div') !== false
            || stripos($html, '<br') !== false
            || stripos($html, '<li') !== false
            || stripos($html, '<table') !== false;
        $hasMedia = stripos($html, '<img') !== false
            || stripos($html, '<iframe') !== false
            || stripos($html, '<video') !== false
            || stripos($html, '<figure') !== false;

        $minLength = $strict ? 80 : 20;

        $isValid = false;
        if ($plainLength >= $minLength) {
            $isValid = true;
        } elseif ($hasHtmlTags && $plainLength >= 5) {
            $isValid = true;
        } elseif ($hasMedia && !$strict) {
            $isValid = true;
        }

        if (!$isValid) {
            return [
                'html' => '',
                'plain' => '',
                'plain_length' => 0,
                'media_only' => false,
                'valid' => false,
            ];
        }

        return [
            'html' => $html,
            'plain' => $plain,
            'plain_length' => $plainLength,
            'media_only' => $hasMedia && $plainLength === 0,
            'valid' => true,
        ];
    }

    private static function plainFromHtml(string $html): string
    {
        if ($html === '') {
            return '';
        }

        $decodeFlags = defined('ENT_HTML5') ? (ENT_QUOTES | ENT_HTML5) : (ENT_QUOTES | ENT_COMPAT);
        $decoded = html_entity_decode($html, $decodeFlags, 'UTF-8');
        $stripped = strip_tags($decoded);
        $normalized = preg_replace('/\s+/u', ' ', $stripped);

        return trim((string)$normalized);
    }

    private static function strLength(string $value): int
    {
        if ($value === '') {
            return 0;
        }

        return function_exists('mb_strlen') ? mb_strlen($value) : strlen($value);
    }

    private static function looksLikeJson(string $value): bool
    {
        $value = trim($value);
        if ($value === '') {
            return false;
        }

        $first = $value[0];
        $last = substr($value, -1);

        return ($first === '{' && $last === '}') || ($first === '[' && $last === ']');
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_content_preparation_service.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_ContentPreparationService
{
    /** @var array */
    private $stopWords;

    public function __construct(array $stopWords = [])
    {
        if (!$stopWords) {
            $stopWords = ['казино', 'букмекер', 'ставки', 'лотерея', 'микрозайм', 'азарт'];
        }

        $normalized = [];
        foreach ($stopWords as $word) {
            $word = trim((string)$word);
            if ($word === '') {
                continue;
            }

            $normalized[] = $this->lower($word);
        }

        $this->stopWords = array_values(array_unique($normalized));
    }

    public function prepare(int $sourceId, array $payload, string $lang = 'ru'): array
    {
        $lang = $lang !== '' ? $lang : 'ru';

        $title = trim(GovParser_PayloadHelper::extractTitle($payload, $lang));
        $preview = trim(GovParser_PayloadHelper::extractPreview($payload, $lang));
        $bodyInfo = GovParser_PayloadHelper::extractBody($payload, $lang);

        $rawHtml = trim((string)($bodyInfo['html'] ?? ''));
        if ($rawHtml === '') {
            throw new RuntimeException('Пустой основной текст после извлечения');
        }

        $normalized = $this->normalizeContent($rawHtml);
        $plainText = $normalized['plain'];
        $plainLength = (int)$normalized['plain_length'];

        if ($plainText === '') {
            throw new RuntimeException('Основной текст пуст после очистки');
        }

        if ($plainLength < 500) {
            throw new RuntimeException('Основной текст короче 500 символов');
        }

        $stopHits = $this->detectStopWords($plainText);
        if ($stopHits) {
            throw new RuntimeException('Обнаружены стоп-слова: ' . implode(', ', $stopHits));
        }

        if ($title === '' && !empty($payload['title'])) {
            $title = trim((string)$payload['title']);
        }

        if ($preview === '') {
            $preview = $this->shorten($plainText, 400);
        }

        $summary = $this->buildSummary($plainText);
        if ($summary === '') {
            $summary = $preview;
        }

        $sourceMeta = $this->buildSourceMeta($payload, $sourceId, $lang);
        $publishedAt = $this->extractPublicationDate($payload, $lang);
        if ($publishedAt !== null) {
            $sourceMeta['published_at'] = $publishedAt;
        }

        if (empty($sourceMeta['url'])) {
            $sourceMeta['url'] = $this->buildFallbackUrl($sourceId, $lang);
        }

        $mediaRefs = $this->extractMediaRefs($payload, $rawHtml);
        $baseMediaUrl = isset($sourceMeta['url']) ? (string)$sourceMeta['url'] : '';
        $mediaAssets = $this->buildMediaAssets($mediaRefs, $title, $baseMediaUrl);
        $normalizedMediaRefs = array_map(static function ($asset) {
            return $asset['ref'];
        }, $mediaAssets);

        $issues = $normalized['issues'];
        if (!$mediaAssets) {
            $issues[] = 'Изображения не найдены';
        }

        $keyFacts = $this->buildKeyFacts($payload, $lang, $summary !== '' ? $summary : $preview, $sourceMeta, $publishedAt, $plainText);

        $bodyHash = sha1($plainText);

        $checklist = [
            'title_clean' => $title !== '',
            'description_clean' => $preview !== '',
            'body_normalized' => $plainLength >= 500,
            'media_extracted' => count($mediaAssets) > 0,
            'summary_ready' => $summary !== '',
            'facts_prepared' => !empty($keyFacts),
            'status_ready' => true,
            'meta_enriched' => !empty($sourceMeta['url']) && !empty($sourceMeta['id']),
        ];

        $rewritePayload = [
            'id' => $sourceId,
            'title' => $title,
            'short' => $preview,
            'body' => $normalized['html'],
            'source' => array_filter([
                'url' => $sourceMeta['url'] ?? null,
                'region' => $sourceMeta['region'] ?? null,
                'direction' => $sourceMeta['direction'] ?? null,
                'published_at' => $publishedAt,
            ], function ($value) {
                return $value !== null && $value !== '' && $value !== [];
            }),
            'media_refs' => $normalizedMediaRefs,
        ];

        return [
            'rewrite_payload' => $rewritePayload,
            'summary' => $summary,
            'key_facts' => $keyFacts,
            'plain_length' => $plainLength,
            'plain_text' => $plainText,
            'body_hash' => $bodyHash,
            'checklist' => $checklist,
            'issues' => $issues,
            'clean_log' => $normalized['log'],
            'media_assets' => $mediaAssets,
            'source_meta' => $sourceMeta,
        ];
    }

    private function normalizeContent(string $html): array
    {
        $log = [];
        $issues = [];

        $work = $html;

        $work = preg_replace('~<!DOCTYPE[^>]*>~i', '', $work, -1, $doctypeRemoved);
        if (!empty($doctypeRemoved)) {
            $log['removed_doctype'] = (int)$doctypeRemoved;
        }

        $work = preg_replace('~@DOCTYPE[^\n<]*~i', '', $work, -1, $atDoctypeRemoved);
        if (!empty($atDoctypeRemoved)) {
            $log['removed_at_doctype'] = (int)$atDoctypeRemoved;
        }

        $work = preg_replace('~<\?xml[^>]*>~i', '', $work, -1, $xmlRemoved);
        if (!empty($xmlRemoved)) {
            $log['removed_xml_decl'] = (int)$xmlRemoved;
        }

        $work = preg_replace('~</?(html|head|body)[^>]*>~i', '', $work, -1, $layoutRemoved);
        if (!empty($layoutRemoved)) {
            $log['removed_layout_tags'] = (int)$layoutRemoved;
        }

        $work = preg_replace('~<script\b[^>]*>.*?</script>~is', '', $work, -1, $scriptsRemoved);
        if ($scriptsRemoved > 0) {
            $log['removed_scripts'] = $scriptsRemoved;
        }

        $work = preg_replace('~<style\b[^>]*>.*?</style>~is', '', $work, -1, $stylesRemoved);
        if ($stylesRemoved > 0) {
            $log['removed_styles'] = $stylesRemoved;
        }

        $work = preg_replace('~<!--.*?-->~s', '', $work, -1, $commentsRemoved);
        if ($commentsRemoved > 0) {
            $log['removed_comments'] = $commentsRemoved;
        }

        $work = preg_replace('~<iframe\b[^>]*>.*?</iframe>~is', '', $work, -1, $iframesRemoved);
        if ($iframesRemoved > 0) {
            $log['removed_iframes'] = $iframesRemoved;
        }

        $work = preg_replace('~<object\b[^>]*>.*?</object>~is', '', $work, -1, $objectsRemoved);
        if ($objectsRemoved > 0) {
            $log['removed_objects'] = $objectsRemoved;
        }

        $work = preg_replace('~<figure\b[^>]*>.*?</figure>~is', '', $work, -1, $figuresRemoved);
        if ($figuresRemoved > 0) {
            $log['removed_figures'] = $figuresRemoved;
        }

        $work = preg_replace('~<img[^>]*>~i', '', $work, -1, $imagesRemoved);
        if ($imagesRemoved > 0) {
            $log['removed_images'] = $imagesRemoved;
        }

        $work = preg_replace('/\s+(?:style|class|id|data-[a-z0-9_-]+|onclick|onload|aria-[a-z0-9_-]+)="[^"]*"/i', '', $work, -1, $attrRemoved1);
        $work = preg_replace("/\s+(?:style|class|id|data-[a-z0-9_-]+|onclick|onload|aria-[a-z0-9_-]+)='[^']*'/i", '', $work, -1, $attrRemoved2);
        $removedAttrs = (int)$attrRemoved1 + (int)$attrRemoved2;
        if ($removedAttrs > 0) {
            $log['removed_attributes'] = $removedAttrs;
        }

        $work = str_replace(['&nbsp;', "\xC2\xA0"], ' ', $work);

        $work = preg_replace('~<li[^>]*>~i', "\n• ", $work, -1, $liConverted);
        if ($liConverted > 0) {
            $log['converted_list_items'] = $liConverted;
        }

        $work = preg_replace('~</li>~i', '', $work);
        $work = preg_replace('~</?(ul|ol)[^>]*>~i', "\n", $work);

        $work = preg_replace('~<br\s*/?>~i', "\n", $work, -1, $brConverted);
        if ($brConverted > 0) {
            $log['converted_br'] = $brConverted;
        }

        $work = preg_replace('~<(p|div|section|article|header|footer|aside)[^>]*>~i', "\n", $work);
        $work = preg_replace('~</(p|div|section|article|header|footer|aside)>~i', "\n", $work);

        $work = preg_replace('~<span[^>]*>\s*</span>~i', '', $work, -1, $emptySpansRemoved);
        if ($emptySpansRemoved > 0) {
            $log['removed_empty_spans'] = $emptySpansRemoved;
        }

        $work = preg_replace('~<a[^>]*>(.*?)</a>~is', '$1', $work);

        $work = strip_tags($work);

        $flags = defined('ENT_HTML5') ? (ENT_QUOTES | ENT_HTML5) : (ENT_QUOTES | ENT_COMPAT);
        $work = html_entity_decode($work, $flags, 'UTF-8');

        $work = preg_replace("/(\r\n|\r)/u", "\n", $work);
        $work = preg_replace('/[\t ]+/u', ' ', $work);
        $work = preg_replace('/\n{3,}/u', "\n\n", $work);
        $work = preg_replace('/\n +/u', "\n", $work);
        $work = preg_replace('/ +\n/u', "\n", $work);
        $work = trim($work);

        $work = $this->normalizeTypography($work);

        if ($work === '') {
            return [
                'html' => '',
                'plain' => '',
                'plain_length' => 0,
                'log' => $log,
                'issues' => $issues,
            ];
        }

        $paragraphs = array_filter(array_map('trim', preg_split('/\n{2,}/u', $work)));
        if (!$paragraphs) {
            $paragraphs = [$work];
        }

        $htmlParts = [];
        foreach ($paragraphs as $paragraph) {
            $htmlParts[] = '<p>' . htmlspecialchars($paragraph, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8') . '</p>';
        }

        $plainLength = GovParser_PayloadHelper::stringLength($work);

        return [
            'html' => implode("\n", $htmlParts),
            'plain' => $work,
            'plain_length' => $plainLength,
            'log' => $log,
            'issues' => $issues,
        ];
    }

    private function buildSummary(string $plain): string
    {
        if ($plain === '') {
            return '';
        }

        $normalized = preg_replace('/\s+/u', ' ', $plain);
        $sentences = preg_split('/(?<=[.!?])\s+/u', $normalized);

        $result = [];
        foreach ($sentences as $sentence) {
            $sentence = trim($sentence);
            if ($sentence === '' || strpos($sentence, '•') === 0) {
                continue;
            }
            $result[] = $sentence;
            if (count($result) >= 3) {
                break;
            }
        }

        if (!$result) {
            $lines = preg_split('/\n+/u', $plain);
            foreach ($lines as $line) {
                $line = trim($line);
                if ($line === '') {
                    continue;
                }
                $result[] = $line;
                if (count($result) >= 2) {
                    break;
                }
            }
        }

        $summary = implode(' ', $result);

        return $this->shorten($summary, 400);
    }

    private function detectStopWords(string $text): array
    {
        if (!$this->stopWords) {
            return [];
        }

        $haystack = $this->lower($text);
        $found = [];
        foreach ($this->stopWords as $word) {
            if ($word === '') {
                continue;
            }

            if (strpos($haystack, $word) !== false) {
                $found[] = $word;
            }
        }

        return array_values(array_unique($found));
    }

    private function extractMediaRefs(array $payload, string $html): array
    {
        $refs = [];

        $paths = [
            ['image'],
            ['images'],
            ['heropic'],
            ['photos'],
            ['gallery'],
            ['media'],
            ['mediaFiles'],
            ['attachments'],
            ['files'],
            ['documents'],
            ['pictures'],
            ['mainPhoto'],
            ['previewImage'],
            ['data', 'image'],
            ['data', 'images'],
            ['data', 'heropic'],
        ];

        foreach ($paths as $path) {
            $value = $this->getValueByPath($payload, $path);
            if ($value === null) {
                continue;
            }

            $this->collectMediaRefs($value, $refs);
        }

        if ($html !== '') {
            if (preg_match_all('~<img[^>]+src=["\']([^"\']+)["\']~i', $html, $matches)) {
                foreach ($matches[1] as $src) {
                    $this->pushMediaRef($refs, $src);
                }
            }

            if (preg_match_all('~<img[^>]+data-src=["\']([^"\']+)["\']~i', $html, $matches)) {
                foreach ($matches[1] as $src) {
                    $this->pushMediaRef($refs, $src);
                }
            }

            if (preg_match_all('~<a[^>]+href=["\']([^"\']+\.(?:pdf|docx?|pptx?|xlsx?))["\']~i', $html, $matches)) {
                foreach ($matches[1] as $src) {
                    $this->pushMediaRef($refs, $src);
                }
            }
        }

        return array_values($refs);
    }

    private function collectMediaRefs($value, array &$refs): void
    {
        if ($value === null) {
            return;
        }

        if (is_string($value)) {
            $this->pushMediaRef($refs, $value);
            return;
        }

        if (is_object($value)) {
            $value = (array)$value;
        }

        if (!is_array($value)) {
            return;
        }

        foreach ($value as $item) {
            if (is_string($item)) {
                $this->pushMediaRef($refs, $item);
                continue;
            }

            if (is_object($item) || is_array($item)) {
                $itemArray = (array)$item;
                foreach (['url', 'href', 'src', 'path', 'original', 'downloadUrl', 'download', 'file', 'fileUrl', 'image'] as $key) {
                    if (!empty($itemArray[$key])) {
                        $this->pushMediaRef($refs, $itemArray[$key]);
                    }
                }

                $this->collectMediaRefs($itemArray, $refs);
            }
        }
    }

    private function pushMediaRef(array &$refs, $value): void
    {
        if (is_array($value) || is_object($value)) {
            return;
        }

        $value = trim((string)$value);
        if ($value === '') {
            return;
        }

        if (!$this->looksLikeMedia($value)) {
            return;
        }

        if (!in_array($value, $refs, true)) {
            $refs[] = $value;
        }
    }

    private function looksLikeMedia(string $value): bool
    {
        if ($value === '') {
            return false;
        }

        if (preg_match('~\.(?:jpe?g|png|gif|webp|bmp|svg|pdf|docx?|pptx?|xlsx?|mp4|avi|mov)\b~i', $value)) {
            return true;
        }

        if (strpos($value, '/uploads/') !== false || strpos($value, '/storage/') !== false) {
            return true;
        }

        return (bool)preg_match('~^https?://~i', $value);
    }

    private function buildMediaAssets(array $refs, string $title, string $baseUrl = ''): array
    {
        if (!$refs) {
            return [];
        }

        $baseUrl = trim($baseUrl);
        $uniqueRefs = [];

        foreach ($refs as $ref) {
            if (!is_string($ref) && !is_numeric($ref)) {
                continue;
            }

            $normalized = $this->normalizeMediaRef((string)$ref, $baseUrl);
            if ($normalized === '') {
                continue;
            }

            if (!isset($uniqueRefs[$normalized])) {
                $uniqueRefs[$normalized] = true;
            }
        }

        $refs = array_keys($uniqueRefs);
        if (!$refs) {
            return [];
        }

        $result = [];
        $baseAlt = $title !== '' ? $title : 'Иллюстрация для новости gov.kz';
        $count = count($refs);

        foreach ($refs as $index => $ref) {
            $suffix = $count > 1 ? ' (' . ($index + 1) . ')' : '';
            $path = parse_url($ref, PHP_URL_PATH);
            $filename = '';
            if (is_string($path) && $path !== '') {
                $filename = basename($path);
            }
            if ($filename === '') {
                $filename = basename((string)$ref);
            }
            if ($filename === '' || $filename === '/' || $filename === '.') {
                $filename = 'image';
            }

            $result[] = [
                'ref' => $ref,
                'alt' => $baseAlt . $suffix,
                'filename' => $filename,
            ];
        }

        return $result;
    }

    private function normalizeMediaRef(string $value, string $baseUrl): string
    {
        $value = trim($value);
        if ($value === '' || strpos($value, 'data:') === 0) {
            return '';
        }

        if (strpos($value, '//') === 0) {
            return 'https:' . $value;
        }

        if (preg_match('~^https?://~i', $value)) {
            return $value;
        }

        if ($baseUrl === '') {
            return $value;
        }

        $fragment = '';
        if (false !== $hashPos = strpos($value, '#')) {
            $fragment = substr($value, $hashPos);
            $value = substr($value, 0, $hashPos);
        }

        $query = '';
        if (false !== $queryPos = strpos($value, '?')) {
            $query = substr($value, $queryPos);
            $value = substr($value, 0, $queryPos);
        }

        $baseParts = @parse_url($baseUrl);
        if (!$baseParts || empty($baseParts['scheme']) || empty($baseParts['host'])) {
            return $value . $query . $fragment;
        }

        $scheme = $baseParts['scheme'];
        $host = $baseParts['host'];
        $port = isset($baseParts['port']) ? ':' . $baseParts['port'] : '';
        $root = $scheme . '://' . $host . $port;

        if ($value !== '' && $value[0] === '/') {
            $path = $value;
        } else {
            $basePath = $baseParts['path'] ?? '';
            if ($basePath === '' || substr($basePath, -1) === '/') {
                $dir = $basePath;
            } else {
                $slashPos = strrpos($basePath, '/');
                $dir = $slashPos === false ? '/' : substr($basePath, 0, $slashPos + 1);
            }
            if ($dir === '') {
                $dir = '/';
            } elseif ($dir[0] !== '/') {
                $dir = '/' . ltrim($dir, '/');
            }
            $path = rtrim($dir, '/') . '/' . ltrim($value, '/');
        }

        $segments = [];
        foreach (explode('/', $path) as $segment) {
            if ($segment === '' || $segment === '.') {
                continue;
            }
            if ($segment === '..') {
                array_pop($segments);
            } else {
                $segments[] = $segment;
            }
        }

        $normalizedPath = '/' . implode('/', $segments);

        return $root . $normalizedPath . $query . $fragment;
    }

    private function buildSourceMeta(array $payload, int $sourceId, string $lang): array
    {
        $meta = [
            'id' => $sourceId,
        ];

        $urlCandidates = [
            ['source', 'url'],
            ['sourceUrl'],
            ['url'],
            ['link'],
            ['original_url'],
            ['data', 'url'],
        ];

        foreach ($urlCandidates as $candidate) {
            $url = GovParser_PayloadHelper::extractFieldByPaths($payload, [$candidate], $lang, 3);
            if ($url !== '' && filter_var($url, FILTER_VALIDATE_URL)) {
                $meta['url'] = $url;
                break;
            }
        }

        $meta['region'] = trim(GovParser_PayloadHelper::extractFieldByPaths($payload, [
            ['region', 'title'],
            ['region', 'name'],
            ['regionTitle'],
            ['regionName'],
            ['region'],
            ['territory', 'title'],
            ['location', 'name'],
            ['location'],
        ], $lang, 3));

        $meta['direction'] = trim(GovParser_PayloadHelper::extractFieldByPaths($payload, [
            ['direction', 'title'],
            ['direction', 'name'],
            ['direction'],
            ['category', 'title'],
            ['category', 'name'],
            ['category'],
            ['rubric', 'title'],
            ['rubric'],
            ['department', 'name'],
            ['sphere'],
        ], $lang, 3));

        $tags = $this->extractTags($payload, $lang);
        if ($tags) {
            $meta['tags'] = $tags;
        }

        return array_filter($meta, function ($value) {
            if ($value === null) {
                return false;
            }

            if (is_string($value)) {
                return $value !== '';
            }

            if (is_array($value)) {
                return !empty($value);
            }

            return true;
        });
    }

    private function extractPublicationDate(array $payload, string $lang): ?string
    {
        $paths = [
            ['publishDate'],
            ['publish_date'],
            ['publicationDate'],
            ['publication_date'],
            ['published_at'],
            ['created_at'],
            ['createdAt'],
            ['date'],
            ['newsDate'],
            ['publicDate'],
            ['data', 'publishDate'],
        ];

        $raw = GovParser_PayloadHelper::extractFieldByPaths($payload, $paths, $lang, 3);
        if ($raw === '') {
            return null;
        }

        if (is_numeric($raw)) {
            $timestamp = (int)$raw;
            if ($timestamp > 1000000000) {
                return gmdate('Y-m-d H:i:s', $timestamp);
            }
        }

        $timestamp = strtotime($raw);
        if ($timestamp === false) {
            return null;
        }

        return gmdate('Y-m-d H:i:s', $timestamp);
    }

    private function buildKeyFacts(array $payload, string $lang, string $summary, array $sourceMeta, ?string $publishedAt, string $plain): array
    {
        $facts = [];

        $who = trim(GovParser_PayloadHelper::extractFieldByPaths($payload, [
            ['author', 'name'],
            ['author'],
            ['responsible'],
            ['speaker'],
            ['person', 'name'],
            ['organization', 'name'],
        ], $lang, 3));
        if ($who !== '') {
            $facts[] = 'Кто: ' . $this->shorten($who, 160);
        }

        $what = $summary !== '' ? $summary : $plain;
        if ($what !== '') {
            $facts[] = 'Что: ' . $this->shorten($what, 220);
        }

        $where = $sourceMeta['region'] ?? '';
        if ($where === '') {
            $where = trim(GovParser_PayloadHelper::extractFieldByPaths($payload, [
                ['city'],
                ['location'],
                ['region_name'],
                ['regionName'],
                ['territory'],
            ], $lang, 3));
        }
        if ($where !== '') {
            $facts[] = 'Где: ' . $this->shorten($where, 160);
        }

        if ($publishedAt !== null) {
            $facts[] = 'Когда: ' . $publishedAt;
        }

        $direction = $sourceMeta['direction'] ?? '';
        if ($direction === '') {
            $direction = trim(GovParser_PayloadHelper::extractFieldByPaths($payload, [
                ['direction'],
                ['category'],
                ['rubric'],
                ['topic'],
                ['department', 'name'],
            ], $lang, 3));
        }
        if ($direction !== '') {
            $facts[] = 'Зачем: ' . $this->shorten($direction, 180);
        }

        if (count($facts) > 5) {
            $facts = array_slice($facts, 0, 5);
        }

        return $facts;
    }

    private function extractTags(array $payload, string $lang): array
    {
        $tags = [];
        $fields = ['tags', 'tag', 'keywords', 'rubrics', 'themes', 'topics'];

        foreach ($fields as $field) {
            if (!array_key_exists($field, $payload)) {
                continue;
            }

            $this->collectTags($payload[$field], $tags, $lang);
        }

        $unique = [];
        foreach ($tags as $tag) {
            $tag = trim((string)$tag);
            if ($tag === '') {
                continue;
            }

            if (!in_array($tag, $unique, true)) {
                $unique[] = $tag;
            }
        }

        return $unique;
    }

    private function collectTags($value, array &$tags, string $lang): void
    {
        if ($value === null) {
            return;
        }

        if (is_string($value)) {
            $parts = preg_split('/[,;]+/u', $value);
            if (!$parts) {
                $parts = [$value];
            }
            foreach ($parts as $part) {
                $part = trim($part);
                if ($part !== '') {
                    $tags[] = $part;
                }
            }
            return;
        }

        if (is_object($value)) {
            $value = (array)$value;
        }

        if (!is_array($value)) {
            return;
        }

        foreach ($value as $item) {
            if (is_string($item)) {
                $item = trim($item);
                if ($item !== '') {
                    $tags[] = $item;
                }
                continue;
            }

            if (is_array($item) || is_object($item)) {
                $itemArray = (array)$item;
                if (isset($itemArray['title'])) {
                    $tags[] = trim((string)$itemArray['title']);
                    continue;
                }
                if (isset($itemArray['name'])) {
                    $tags[] = trim((string)$itemArray['name']);
                    continue;
                }
                $this->collectTags($itemArray, $tags, $lang);
            }
        }
    }

    private function getValueByPath(array $payload, array $path)
    {
        $current = $payload;
        foreach ($path as $segment) {
            if (is_array($current) && array_key_exists($segment, $current)) {
                $current = $current[$segment];
            } else {
                return null;
            }
        }

        return $current;
    }

    private function buildFallbackUrl(int $id, string $lang): string
    {
        $id = max(0, $id);
        $lang = $lang !== '' ? $lang : 'ru';

        return 'https://www.gov.kz/api/v1/public/content-manager/news/' . $id . '?lang=' . rawurlencode($lang);
    }

    private function normalizeTypography(string $text): string
    {
        if ($text === '') {
            return '';
        }

        $map = [
            '“' => '"',
            '”' => '"',
            '„' => '"',
            '‟' => '"',
            '«' => '"',
            '»' => '"',
            '‹' => '"',
            '›' => '"',
            '’' => "'",
            '‘' => "'",
        ];

        $text = strtr($text, $map);
        $text = preg_replace('/\s+—\s+/u', ' — ', $text);
        $text = preg_replace('/\s+-\s+/u', ' — ', $text);
        $text = preg_replace('/\s{2,}/u', ' ', $text);
        $text = preg_replace('/\h*\n\h*/u', "\n", $text);

        return trim($text);
    }

    private function shorten(string $text, int $limit): string
    {
        if ($text === '') {
            return '';
        }

        if (function_exists('mb_strlen') && function_exists('mb_substr')) {
            if (mb_strlen($text, 'UTF-8') <= $limit) {
                return $text;
            }

            $trimmed = mb_substr($text, 0, $limit, 'UTF-8');

            return rtrim($trimmed) . '…';
        }

        if (strlen($text) <= $limit) {
            return $text;
        }

        return rtrim(substr($text, 0, $limit)) . '…';
    }

    private function lower(string $value): string
    {
        if (function_exists('mb_strtolower')) {
            return mb_strtolower($value, 'UTF-8');
        }

        return strtolower($value);
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_http_client.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_HttpClient
{
    public function get(string $url, int $timeout = 15, array $headers = []): array
    {
        $ch = curl_init($url);

        $defaultHeaders = [
            'Accept: application/json, text/plain, */*',
            'Accept-Language: ru,en;q=0.8',
            'Referer: https://www.gov.kz/',
        ];

        if ($headers) {
            $defaultHeaders = array_merge($defaultHeaders, $headers);
        }

        $options = [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_CONNECTTIMEOUT => 5,
            CURLOPT_TIMEOUT => $timeout,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => 0,
            CURLOPT_USERAGENT => 'gov-parser/0.1',
            CURLOPT_ENCODING => '',
        ];

        if (!empty($defaultHeaders)) {
            $options[CURLOPT_HTTPHEADER] = array_values(array_unique(array_filter($defaultHeaders)));
        }

        curl_setopt_array($ch, $options);

        $body = curl_exec($ch);
        $err = curl_error($ch);
        $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        return [$code, $body, $err];
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_gov_api_client.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_GovApiClient
{
    private const BASE_URL = 'https://www.gov.kz/api/v1/public/content-manager/news/';

    /** @var GovParser_HttpClient */
    private $http;
    /** @var string */
    private $lastUrl = '';
    /** @var int */
    private $lastStatus = 0;
    /** @var string|null */
    private $lastError = null;

    public function __construct(GovParser_HttpClient $http)
    {
        $this->http = $http;
    }

    public function getNews(int $id, string $lang = 'ru'): ?array
    {
        $lang = trim($lang) ?: 'ru';
        $primaryUrl = self::BASE_URL . $id . '?lang=' . rawurlencode($lang);

        $payload = $this->fetchJson($primaryUrl);
        if ($payload !== null) {
            return $payload;
        }

        $fallbackUrl = $this->buildFallbackUrl($id, $lang);
        if ($fallbackUrl !== null) {
            $payload = $this->fetchJson($fallbackUrl);
            if ($payload !== null) {
                return $payload;
            }
        }

        $message = $this->lastError ?: ('HTTP ' . $this->lastStatus);
        throw new RuntimeException('Gov API error: ' . $message);
    }

    public function getLastUrl(): string
    {
        return $this->lastUrl;
    }

    public function getLastStatus(): int
    {
        return $this->lastStatus;
    }

    public function getLastError(): ?string
    {
        return $this->lastError;
    }

    private function fetchJson(string $url): ?array
    {
        $this->lastUrl = $url;

        [$code, $body, $err] = $this->http->get($url, 20);
        $this->lastStatus = (int)$code;
        $this->lastError = $err !== '' ? $err : null;

        if ($code !== 200 || !$body) {
            if ($this->lastError === null && $code !== 200) {
                $this->lastError = 'HTTP ' . $code;
            }

            return null;
        }

        $decoded = $this->decodeJsonBody($body);
        if ($decoded !== null) {
            return $decoded;
        }

        $this->lastError = 'Invalid JSON from gov.kz';

        return null;
    }

    private function buildFallbackUrl(int $id, string $lang): ?string
    {
        $id = (int)$id;
        if ($id <= 0) {
            return null;
        }

        return 'https://r.jina.ai/https://www.gov.kz/api/v1/public/content-manager/news/' . $id . '?lang=' . rawurlencode($lang);
    }

    private function decodeJsonBody(string $body): ?array
    {
        $candidates = [];
        $trimmed = trim($body);

        if ($trimmed !== '') {
            $candidates[] = $trimmed;

            $startCurly = strpos($trimmed, '{');
            $endCurly = strrpos($trimmed, '}');
            if ($startCurly !== false && $endCurly !== false && $endCurly > $startCurly) {
                $candidates[] = substr($trimmed, $startCurly, $endCurly - $startCurly + 1);
            }

            $startBracket = strpos($trimmed, '[');
            $endBracket = strrpos($trimmed, ']');
            if ($startBracket !== false && $endBracket !== false && $endBracket > $startBracket) {
                $candidates[] = substr($trimmed, $startBracket, $endBracket - $startBracket + 1);
            }
        }

        foreach ($candidates as $candidate) {
            $candidate = trim($candidate);
            if ($candidate === '') {
                continue;
            }

            $decoded = json_decode($candidate, true);
            if (is_array($decoded)) {
                return $decoded;
            }
        }

        return null;
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_telegram_id_collector.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_TelegramIdCollector
{
    /** @var GovParser_HttpClient */
    private $http;
    /** @var string */
    private $feedUrl;
    private const TELEGRAM_HEADERS = [
        'Accept: text/html,application/xhtml+xml;q=0.9,*/*;q=0.8',
        'Cache-Control: no-cache',
    ];

    public function __construct(GovParser_HttpClient $http, string $feedUrl = 'https://r.jina.ai/http://t.me/s/govkz_news')
    {
        $this->http = $http;
        $this->feedUrl = $feedUrl;
    }

    public function fetchIds(int $limit = 100): array
    {
        [$code, $body, $err] = $this->http->get($this->feedUrl, 12, self::TELEGRAM_HEADERS);
        if ($code !== 200 || !$body) {
            throw new RuntimeException('Failed to load Telegram feed: ' . ($err ?: 'HTTP ' . $code));
        }

        $items = $this->parseFeed($body);
        if (!$items) {
            return [];
        }

        $limit = max(1, min(200, (int)$limit));

        return array_slice($items, 0, $limit);
    }

    private function extractGovId(?string $url): ?int
    {
        if (!is_string($url) || $url === '') {
            return null;
        }

        $patterns = [
            '~news/(?:details/|view/)?(\d+)~i',
            '~[?&](?:id|newsId|itemId)=(\d+)~i',
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $url, $match)) {
                return (int)$match[1];
            }
        }

        return null;
    }

    private function parseFeed(string $body): array
    {
        $newsList = [];

        $pattern = '/\[GOV\\.KZ[^\]]*\]\(https:\/\/t\.me\/govkz_news\)\s*\*\*([^*]+)\*\*\s*([^\[]+)\[(https:\/\/www\.gov\.kz[^\]]+)\]/u';
        preg_match_all($pattern, $body, $matches, PREG_SET_ORDER);

        foreach ($matches as $match) {
            $source = trim($match[1], ": \t\n\r\0\x0B");
            $title = preg_replace('/\s+/u', ' ', trim($match[2]));
            $newsUrl = trim($match[3]);
            $govId = $this->extractGovId($newsUrl);

            $newsList[] = [
                'source' => $source !== '' ? $source : null,
                'title' => $title !== '' ? $title : null,
                'news_url' => $newsUrl !== '' ? $newsUrl : null,
                'gov_id' => $govId,
            ];
        }

        preg_match_all('/\[(\d{2}:\d{2})\]\(https:\/\/t\.me\/govkz_news\/(\d+)\)/', $body, $idMatches, PREG_SET_ORDER);

        foreach ($idMatches as $index => $idMatch) {
            if (!isset($newsList[$index])) {
                continue;
            }

            $telegramId = (int)$idMatch[2];
            $newsList[$index]['telegram_post_id'] = $telegramId;
            $newsList[$index]['telegram_url'] = 'https://t.me/govkz_news/' . $telegramId;
            $newsList[$index]['time'] = $idMatch[1];
        }

        $result = [];
        $seen = [];
        foreach ($newsList as $item) {
            $govId = isset($item['gov_id']) ? (int)$item['gov_id'] : 0;
            if ($govId <= 0) {
                continue;
            }

            if (isset($seen[$govId])) {
                continue;
            }

            $seen[$govId] = true;
            $item['id'] = $govId;
            $item['source'] = $item['source'] ?? $this->feedUrl;
            if (!empty($item['telegram_post_id'])) {
                $item['telegram_id'] = (int)$item['telegram_post_id'];
            }

            $result[] = $item;
        }

        usort($result, static fn(array $a, array $b) => $b['id'] <=> $a['id']);

        return $result;
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_rewrite_service.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_RewriteService
{
    /** @var array */
    private $settings;
    /** @var GovParser_Logger */
    private $logger;

    private const PROMPT_DEFAULTS = [
        'short' => 'Создай свежий SEO-анонс на 2–3 предложения по материалу [full-story]. Не повторяй дословно заголовок [title], используй ключевые факты [facts].',
        'title' => 'Перепиши заголовок новости, опираясь на анонс [short-story-rerite] и основные факты [facts]. Избегай клише и прямых повторов. Исходный заголовок: [title]',
        'full' => 'Перепиши текст новости литературным языком, сохрани факты и структуру. Учитывай новый заголовок [title-rerite] и анонс [short-story-rerite]. Исходный текст: [full-story]',
        'meta_title' => 'Составь мета-заголовок до 70 символов на основе [title-rerite] и анонса [short-story-rerite], избегая повтора исходного [title].',
        'meta_description' => 'Напиши мета-описание до 160 символов, используя [title], [title-rerite] и анонс [short-story-rerite], избегая повторов.',
    ];

    public function __construct(array $settings, GovParser_Logger $logger)
    {
        $this->settings = $settings;
        $this->logger = $logger;
    }

    public function rewrite(array $item): array
    {
        $original = $this->extractOriginal($item);
        $context = $this->initializeContext($original);
        $promptSetup = $this->buildPromptSetup($original);
        $report = [
            'prompt_full' => '',
            'instructions' => [],
            'response_raw' => null,
            'usage' => null,
            'duration_ms' => 0,
            'status' => empty($this->settings['rewrite_enabled']) ? 'disabled' : 'pending',
            'steps' => [],
        ];

        if (empty($this->settings['rewrite_enabled'])) {
            $result = $this->composeResult($original, $context);
            $report['steps'] = $this->buildStepReport([], $context, $original, null, 0, 'disabled');

            return [
                'result' => $result,
                'report' => $report,
                'progress' => '',
            ];
        }

        $startedAt = microtime(true);
        $execution = $this->runRewritePipeline($promptSetup, $context, $original);
        $durationMs = (int)round((microtime(true) - $startedAt) * 1000);

        $report['instructions'] = $execution['prompts'];
        $report['prompt_full'] = $this->summarizePrompts($execution['prompts']);
        $report['response_raw'] = $execution['responses']
            ? json_encode($execution['responses'], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT)
            : null;
        $report['usage'] = $execution['usage'];
        $report['duration_ms'] = $durationMs;
        $report['status'] = $execution['status'];
        $report['steps'] = $this->buildStepReport(
            $execution['prompts'],
            $execution['context'],
            $original,
            $execution['steps_meta'],
            $durationMs,
            $execution['status']
        );

        return [
            'result' => $execution['result'],
            'report' => $report,
            'progress' => $execution['progress'],
        ];
    }

    private function initializeContext(array $original): array
    {
        return [
            'title' => $original['title'],
            'short_story' => $original['short_story'],
            'short_story_plain' => strip_tags($original['short_story']),
            'full_story' => $original['full_story'],
            'full_story_plain' => $original['full_story_plain'],
            'summary' => $original['summary'],
            'facts' => $original['facts'],
            'facts_text' => $original['facts_text'],
            'title_rerite' => '',
            'short_story_rerite' => '',
            'full_story_rerite' => '',
            'meta_title' => '',
            'meta_description' => '',
        ];
    }

    private function composeResult(array $original, array $context): array
    {
        $titleRewrite = $context['title_rerite'] !== '' ? $context['title_rerite'] : $original['title'];
        $shortRewrite = $context['short_story_rerite'] !== '' ? $context['short_story_rerite'] : $original['short_story'];
        $fullRewrite = $context['full_story_rerite'] !== '' ? $context['full_story_rerite'] : $original['full_story'];
        $metaTitle = $context['meta_title'] !== '' ? $context['meta_title'] : $titleRewrite;
        $metaDescription = $context['meta_description'] !== '' ? $context['meta_description'] : $shortRewrite;

        return [
            'title' => [
                'original' => $original['title'],
                'rerite' => $titleRewrite,
            ],
            'short_story' => [
                'original' => $original['short_story'],
                'rerite' => $shortRewrite,
            ],
            'body' => [
                'original' => $original['full_story'],
                'rerite' => $fullRewrite,
                'outline' => '',
            ],
            'meta' => [
                'title' => $metaTitle,
                'description' => $metaDescription,
            ],
            'tags' => $this->buildTagValues($context, $original),
        ];
    }

    private function buildTagValues(array $context, array $original): array
    {
        $titleRewrite = $context['title_rerite'] !== '' ? $context['title_rerite'] : $original['title'];
        $shortRewrite = $context['short_story_rerite'] !== '' ? $context['short_story_rerite'] : $original['short_story'];
        $fullRewrite = $context['full_story_rerite'] !== '' ? $context['full_story_rerite'] : $original['full_story'];
        $metaTitle = $context['meta_title'] !== '' ? $context['meta_title'] : $titleRewrite;
        $metaDescription = $context['meta_description'] !== '' ? $context['meta_description'] : $shortRewrite;

        return [
            'title' => $original['title'],
            'short-story' => $original['short_story'],
            'short-story-plain' => strip_tags($original['short_story']),
            'full-story' => $original['full_story'],
            'full-story-plain' => strip_tags($original['full_story']),
            'title-rerite' => $titleRewrite,
            'short-story-rerite' => $shortRewrite,
            'short-story-rerite-plain' => strip_tags($shortRewrite),
            'full-story-rerite' => $fullRewrite,
            'full-story-rerite-plain' => strip_tags($fullRewrite),
            'meta-title' => $metaTitle,
            'meta-description' => $metaDescription,
        ];
    }

    private function summarizePrompts(array $prompts): string
    {
        if (!$prompts) {
            return '';
        }

        $labels = [
            'short' => 'SEO-анонс',
            'title' => 'Заголовок',
            'meta_title' => 'Мета-заголовок',
            'meta_description' => 'Мета-описание',
            'full' => 'Полный текст',
        ];

        $parts = [];
        foreach (['short', 'title', 'meta_title', 'meta_description', 'full'] as $key) {
            if (empty($prompts[$key])) {
                continue;
            }

            $label = $labels[$key] ?? $key;
            $parts[] = $label . ":\n" . $prompts[$key];
        }

        return $parts ? implode("\n\n---\n\n", $parts) : '';
    }

    private function runRewritePipeline(array $setup, array $baseContext, array $original): array
    {
        $context = $baseContext;
        $promptsUsed = [];
        $responses = [];
        $usageTotals = [];
        $stepsMeta = [];
        $overallStatus = 'ok';
        $progress = '';

        $order = ['short', 'title', 'meta_title', 'meta_description', 'full'];

        foreach ($order as $type) {
            $template = $setup['templates'][$type] ?? null;
            if ($template === null) {
                $stepsMeta[$type] = [
                    'usage' => [],
                    'duration_ms' => 0,
                    'status' => 'skipped',
                ];
                continue;
            }

            $prompt = $this->renderTemplate($template, $context, $setup['source'], $setup['include_source']);
            if ($setup['include_source'] && $setup['source'] !== '' && stripos($template, '[source]') === false) {
                $prompt = trim($prompt . "\n\n" . $setup['source']);
            }
            $format = $this->buildResultFormatForType($type);
            if ($format !== '') {
                $prompt = trim($prompt . "\n\n" . $format);
            }

            if ($prompt === '') {
                $stepsMeta[$type] = [
                    'usage' => [],
                    'duration_ms' => 0,
                    'status' => 'skipped',
                ];
                continue;
            }

            $promptsUsed[$type] = $prompt;
            $fallback = $this->getFallbackForStage($type, $context, $original);

            try {
                $stepStartedAt = microtime(true);
                $response = $this->callOpenAI($prompt);
                $stepDuration = (int)round((microtime(true) - $stepStartedAt) * 1000);

                $responses[$type] = $response['raw'];

                if (!empty($response['usage']) && is_array($response['usage'])) {
                    foreach ($response['usage'] as $usageKey => $value) {
                        $usageTotals[$usageKey] = ($usageTotals[$usageKey] ?? 0) + (int)$value;
                    }
                }

                $value = $this->extractResponseValue($type, $response['data'], $context, $fallback);
                $normalizedValue = $type === 'full' ? (string)$value : trim((string)$value);

                $status = 'ok';
                if ($normalizedValue === '') {
                    $normalizedValue = $fallback;
                    $status = 'fallback';
                } elseif ($this->normalizeComparisonText($normalizedValue) === $this->normalizeComparisonText((string)$fallback)) {
                    $status = 'unchanged';
                }

                if ($status !== 'ok' && $overallStatus === 'ok') {
                    $overallStatus = 'warning';
                }

                $this->applyStageResult($type, $normalizedValue, $context);
                $stepMeta = [
                    'usage' => $response['usage'],
                    'duration_ms' => $stepDuration,
                    'status' => $status,
                ];

                if ($status === 'fallback') {
                    $stepMeta['message'] = 'Использован запасной текст вместо ответа GPT.';
                } elseif ($status === 'unchanged') {
                    $stepMeta['message'] = 'Ответ GPT совпал с исходным вариантом.';
                }

                $stepsMeta[$type] = $stepMeta;

                $stageProgress = $this->progressLabelForStage($type);
                if ($stageProgress !== '') {
                    $progress = $stageProgress;
                }
            } catch (\Throwable $e) {
                $this->logger->log('error', 'rewrite', null, 'GPT step failed', ['type' => $type, 'message' => $e->getMessage()]);
                $this->applyStageResult($type, $fallback, $context);
                $stepsMeta[$type] = [
                    'usage' => [],
                    'duration_ms' => 0,
                    'status' => 'error',
                    'message' => $e->getMessage(),
                ];
                $overallStatus = 'error';
                $progress = $progress !== '' ? $progress : 'error';
                break;
            }
        }

        $result = $this->composeResult($original, $context);

        if ($overallStatus === 'error' && $progress === '') {
            $progress = 'error';
        }

        return [
            'result' => $result,
            'prompts' => $promptsUsed,
            'responses' => $responses,
            'usage' => $usageTotals,
            'steps_meta' => $stepsMeta,
            'status' => $overallStatus,
            'progress' => $progress,
            'context' => $context,
        ];
    }

    private function getFallbackForStage(string $type, array $context, array $original): string
    {
        switch ($type) {
            case 'short':
                return $context['short_story_rerite'] !== '' ? $context['short_story_rerite'] : $original['short_story'];
            case 'title':
                return $context['title_rerite'] !== '' ? $context['title_rerite'] : $original['title'];
            case 'meta_title':
                if ($context['meta_title'] !== '') {
                    return $context['meta_title'];
                }
                if ($context['title_rerite'] !== '') {
                    return $context['title_rerite'];
                }

                return $original['title'];
            case 'meta_description':
                if ($context['meta_description'] !== '') {
                    return $context['meta_description'];
                }
                if ($context['short_story_rerite'] !== '') {
                    return $context['short_story_rerite'];
                }

                return $original['short_story'];
            case 'full':
                return $context['full_story_rerite'] !== '' ? $context['full_story_rerite'] : $original['full_story'];
        }

        return '';
    }

    private function applyStageResult(string $type, string $value, array &$context): void
    {
        switch ($type) {
            case 'short':
                $context['short_story_rerite'] = $value;
                $context['short_story_plain'] = strip_tags($value !== '' ? $value : ($context['short_story'] ?? ''));
                break;
            case 'title':
                $context['title_rerite'] = $value;
                break;
            case 'meta_title':
                $context['meta_title'] = $value;
                break;
            case 'meta_description':
                $context['meta_description'] = $value;
                break;
            case 'full':
                $context['full_story_rerite'] = $value;
                break;
        }
    }

    private function progressLabelForStage(string $type): string
    {
        switch ($type) {
            case 'short':
                return 'short';
            case 'title':
                return 'title';
            case 'meta_title':
                return 'meta';
            case 'meta_description':
                return 'meta';
            case 'full':
                return 'full';
        }

        return '';
    }

    private function getStageAnswerValue(string $stage, array $context, array $original): string
    {
        switch ($stage) {
            case 'short':
                return $context['short_story_rerite'] !== '' ? $context['short_story_rerite'] : $original['short_story'];
            case 'title':
                return $context['title_rerite'] !== '' ? $context['title_rerite'] : $original['title'];
            case 'meta_title':
                if ($context['meta_title'] !== '') {
                    return $context['meta_title'];
                }
                if ($context['title_rerite'] !== '') {
                    return $context['title_rerite'];
                }

                return $original['title'];
            case 'meta_description':
                if ($context['meta_description'] !== '') {
                    return $context['meta_description'];
                }
                if ($context['short_story_rerite'] !== '') {
                    return $context['short_story_rerite'];
                }

                return $original['short_story'];
            case 'full':
                if ($context['full_story_rerite'] !== '') {
                    return $context['full_story_rerite'];
                }

                return $original['full_story'];
        }

        return '';
    }

    private function extractOriginal(array $item): array
    {
        $title = trim((string)($item['title'] ?? ''));
        $short = trim((string)($item['preview'] ?? ''));
        $full = (string)($item['text'] ?? '');
        $plainFull = trim(strip_tags($full));
        $summary = trim((string)($item['summary'] ?? ($short !== '' ? $short : '')));

        $facts = [];
        if (!empty($item['facts']) && is_array($item['facts'])) {
            foreach ($item['facts'] as $fact) {
                $fact = trim((string)$fact);
                if ($fact !== '') {
                    $facts[] = $fact;
                }
            }
        }

        $factsText = '';
        if ($facts) {
            $lines = [];
            foreach ($facts as $fact) {
                $lines[] = '- ' . $fact;
            }
            $factsText = implode("\n", $lines);
        }

        return [
            'title' => $title,
            'short_story' => $short,
            'full_story' => $full,
            'full_story_plain' => $this->truncate($plainFull, 12000),
            'summary' => $summary,
            'facts' => $facts,
            'facts_text' => $factsText,
        ];
    }

    private function buildPromptSetup(array $original): array
    {
        $includeSource = array_key_exists('prompts_include_source', $this->settings)
            ? !empty($this->settings['prompts_include_source'])
            : true;

        $sourceParts = [];
        if (!empty($original['title'])) {
            $sourceParts[] = 'Оригинальный заголовок: ' . $original['title'];
        }
        if (!empty($original['short_story'])) {
            $sourceParts[] = 'Краткое описание: ' . $original['short_story'];
        }
        if (!empty($original['summary'])) {
            $sourceParts[] = 'Резюме (подготовлено): ' . $original['summary'];
        }
        if (!empty($original['facts_text'])) {
            $sourceParts[] = "Ключевые факты:\n" . $original['facts_text'];
        }
        if (!empty($original['full_story_plain'])) {
            $sourceParts[] = "Полный текст:\n" . $original['full_story_plain'];
        }

        $source = implode("\n", array_filter($sourceParts, static fn($part) => $part !== ''));

        $templates = [];

        foreach (['short', 'title', 'meta_title', 'meta_description', 'full'] as $type) {
            $template = $this->pickTemplate($type);
            if ($template === null) {
                continue;
            }

            $templates[$type] = $template;
        }

        if (!$templates) {
            $templates['full'] = 'Перепиши текст новости, сохранив факты и смысл.';
        }

        return [
            'templates' => $templates,
            'include_source' => $includeSource,
            'source' => $source,
        ];
    }

    private function buildResultFormatForType(string $type): string
    {
        $key = $this->mapResultKey($type);

        return 'Ответ верни в формате JSON без пояснений: {"' . $key . '":"..."}';
    }

    private function extractResponseValue(string $type, array $data, array $context, string $fallback)
    {
        $key = $this->mapResultKey($type);
        $candidates = [$key];

        if ($type === 'title') {
            $candidates[] = 'headline';
            $candidates[] = 'title';
        } elseif ($type === 'short') {
            $candidates[] = 'short';
            $candidates[] = 'short_story';
            $candidates[] = 'description';
        } elseif ($type === 'full') {
            $candidates[] = 'full';
            $candidates[] = 'body';
            $candidates[] = 'full_story';
        } elseif ($type === 'meta_title') {
            $candidates[] = 'metaTitle';
            $candidates[] = 'title';
        } elseif ($type === 'meta_description') {
            $candidates[] = 'metaDescription';
            $candidates[] = 'description';
        }

        foreach ($candidates as $candidate) {
            if (array_key_exists($candidate, $data)) {
                $value = $data[$candidate];
                if (is_array($value)) {
                    $value = json_encode($value, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                }

                return $value;
            }
        }

        if ($fallback !== '') {
            return $fallback;
        }

        if (array_key_exists($key, $context) && $context[$key] !== '') {
            return $context[$key];
        }

        $fallbackMap = [
            'short' => 'short_story',
            'title' => 'title',
            'full' => 'full_story',
            'meta_title' => 'title',
            'meta_description' => 'short_story',
        ];

        $originalKey = $fallbackMap[$type] ?? null;
        if ($originalKey !== null && array_key_exists($originalKey, $context)) {
            return $context[$originalKey];
        }

        return '';
    }

    private function normalizeComparisonText(string $text): string
    {
        $normalized = strip_tags($text);
        $normalized = preg_replace('/\s+/u', ' ', $normalized);
        $normalized = trim((string)$normalized);

        if (function_exists('mb_strtolower')) {
            return mb_strtolower($normalized, 'UTF-8');
        }

        return strtolower($normalized);
    }

    private function buildStepReport(array $instructionMap, array $context, array $original, ?array $responseMeta, int $durationMs, string $status): array
    {
        $labels = [
            'short' => 'SEO-анонс',
            'title' => 'Заголовок',
            'meta_title' => 'Мета-заголовок',
            'meta_description' => 'Мета-описание',
            'full' => 'Полный текст',
        ];

        $rows = [];
        foreach (['short', 'title', 'meta_title', 'meta_description', 'full'] as $key) {
            $promptText = $instructionMap[$key] ?? '';
            $answerText = $this->getStageAnswerValue($key, $context, $original);

            $usageSummary = '—';
            $stepDuration = $durationMs;
            $stepStatus = $answerText !== '' ? $status : 'empty';
            $stepMessage = '';

            if (is_array($responseMeta)) {
                if (isset($responseMeta[$key]) && is_array($responseMeta[$key])) {
                    $meta = $responseMeta[$key];
                    $usageSummary = $this->formatUsageSummary($meta['usage'] ?? null);
                    if (isset($meta['duration_ms'])) {
                        $stepDuration = (int)$meta['duration_ms'];
                    }
                    if (!empty($meta['status'])) {
                        $stepStatus = (string)$meta['status'];
                    }
                    if (!empty($meta['message'])) {
                        $stepMessage = (string)$meta['message'];
                    }
                } elseif (isset($responseMeta['usage']) || isset($responseMeta['duration_ms'])) {
                    $usageSummary = $this->formatUsageSummary($responseMeta['usage'] ?? null);
                    if (isset($responseMeta['duration_ms'])) {
                        $stepDuration = (int)$responseMeta['duration_ms'];
                    }
                }
            }

            if ($answerText === '') {
                $stepStatus = 'empty';
            }

            $rows[] = [
                'step' => $labels[$key] ?? $key,
                'prompt' => $promptText,
                'answer' => $answerText,
                'lengths' => [
                    'prompt' => $this->stringLength($promptText),
                    'answer' => $this->stringLength(strip_tags($answerText)),
                ],
                'usage' => $usageSummary,
                'duration_ms' => $stepDuration,
                'status' => $stepStatus,
                'message' => $stepMessage,
            ];
        }

        if (!$rows) {
            $rows[] = [
                'step' => 'Инструкция отсутствует',
                'prompt' => '',
                'answer' => '',
                'lengths' => ['prompt' => 0, 'answer' => 0],
                'usage' => $usageSummary,
                'duration_ms' => $durationMs,
                'status' => 'skipped',
            ];
        }

        return $rows;
    }

    private function mapResultKey(string $key): string
    {
        if ($key === 'short') {
            return 'short_story_rerite';
        }
        if ($key === 'title') {
            return 'title_rerite';
        }
        if ($key === 'full') {
            return 'full_story_rerite';
        }

        return $key;
    }

    private function formatUsageSummary($usage): string
    {
        if (!is_array($usage) || !$usage) {
            return '—';
        }

        $parts = [];
        foreach (['prompt_tokens' => 'prompt', 'completion_tokens' => 'completion', 'total_tokens' => 'total'] as $key => $label) {
            if (isset($usage[$key])) {
                $parts[] = $label . ': ' . (int)$usage[$key];
            }
        }

        return $parts ? implode(', ', $parts) : '—';
    }

    private function stringLength(string $text): int
    {
        if (class_exists('GovParser_PayloadHelper')) {
            return GovParser_PayloadHelper::stringLength($text);
        }

        if (function_exists('mb_strlen')) {
            return mb_strlen($text, 'UTF-8');
        }

        return strlen($text);
    }

    private function pickTemplate(string $type): ?string
    {
        $templates = [];
        if (!empty($this->settings['prompts'][$type]) && is_array($this->settings['prompts'][$type])) {
            $templates = array_filter(array_map('trim', $this->settings['prompts'][$type]));
        }

        if (!$templates && isset(self::PROMPT_DEFAULTS[$type])) {
            $templates = [self::PROMPT_DEFAULTS[$type]];
        }

        if (!$templates) {
            return null;
        }

        return $templates[array_rand($templates)];
    }

    private function renderTemplate(string $template, array $data, string $source, bool $includeSource): string
    {
        $variables = $this->buildTemplateVariables($data, $source, $includeSource);

        $rendered = preg_replace_callback('/\[([a-z0-9_-]+)]/i', static function (array $matches) use ($variables) {
            $key = strtolower($matches[1]);

            return $variables[$key] ?? '';
        }, $template);

        $rendered = preg_replace('/[ \t]{2,}/u', ' ', $rendered);
        $rendered = preg_replace("/\n{3,}/u", "\n\n", $rendered);
        $rendered = preg_replace("/\n[ \t]+/u", "\n", $rendered);
        $rendered = preg_replace('/\(\s*\)/u', '', $rendered);

        return trim((string)$rendered);
    }

    private function buildTemplateVariables(array $data, string $source, bool $includeSource): array
    {
        $factsArray = [];
        if (!empty($data['facts']) && is_array($data['facts'])) {
            foreach ($data['facts'] as $fact) {
                $fact = trim((string)$fact);
                if ($fact !== '') {
                    $factsArray[] = $fact;
                }
            }
        }

        $factsJson = json_encode($factsArray, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);

        $titleRerite = $data['title_rerite'] ?? ($data['title_rewrite'] ?? '');
        if ($titleRerite === '') {
            $titleRerite = $data['title'] ?? '';
        }

        $shortRerite = $data['short_story_rerite'] ?? ($data['short_story_rewrite'] ?? '');
        if ($shortRerite === '') {
            $shortRerite = $data['short_story'] ?? '';
        }

        $fullRerite = $data['full_story_rerite'] ?? ($data['full_story_rewrite'] ?? '');
        if ($fullRerite === '') {
            $fullRerite = $data['full_story'] ?? '';
        }

        $metaTitle = $data['meta_title'] ?? '';
        if ($metaTitle === '') {
            $metaTitle = $titleRerite !== '' ? $titleRerite : ($data['title'] ?? '');
        }

        $metaDescription = $data['meta_description'] ?? '';
        if ($metaDescription === '') {
            $metaDescription = $shortRerite !== '' ? $shortRerite : ($data['short_story'] ?? '');
        }

        $values = [
            'title' => $data['title'] ?? '',
            'title_rerite' => $titleRerite,
            'title_rewrite' => $titleRerite,
            'short_story' => $data['short_story'] ?? '',
            'short_story_plain' => strip_tags($data['short_story'] ?? ''),
            'short_story_rerite' => $shortRerite,
            'short_story_rerite_plain' => strip_tags($shortRerite),
            'full_story' => $data['full_story'] ?? '',
            'full_story_html' => $data['full_story'] ?? '',
            'full_story_plain' => $data['full_story_plain'] ?? ($data['full_story'] ?? ''),
            'full_story_rerite' => $fullRerite,
            'full_story_rerite_plain' => strip_tags($fullRerite),
            'summary' => $data['summary'] ?? ($data['short_story'] ?? ''),
            'facts' => $data['facts_text'] ?? '',
            'facts_text' => $data['facts_text'] ?? '',
            'facts_plain' => $factsArray ? implode('; ', $factsArray) : ($data['facts_text'] ?? ''),
            'facts_list' => $factsArray ? implode("\n", $factsArray) : '',
            'facts_bullets' => $data['facts_text'] ?? '',
            'facts_json' => $factsJson !== false ? $factsJson : '[]',
            'meta_title' => $metaTitle,
            'meta_description' => $metaDescription,
            'source' => $includeSource ? $source : '',
        ];

        $map = [];
        foreach ($values as $key => $value) {
            $keyLower = strtolower($key);
            $map[$keyLower] = (string)$value;
            $map[str_replace('_', '-', $keyLower)] = (string)$value;
        }

        return $map;
    }

    private function callOpenAI(string $prompt): array
    {
        if (empty($this->settings['gpt_key'])) {
            throw new RuntimeException('GPT key is not configured');
        }

        $payload = [
            'model' => $this->settings['gpt_model'] ?? 'gpt-3.5-turbo',
            'messages' => [
                ['role' => 'system', 'content' => $this->settings['prompt_system'] ?? 'Ты профессиональный редактор новостей.'],
                ['role' => 'user', 'content' => $prompt],
            ],
            'temperature' => isset($this->settings['gpt_temperature']) ? (float)$this->settings['gpt_temperature'] : 0.6,
        ];

        $ch = curl_init('https://api.openai.com/v1/chat/completions');
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_POST => true,
            CURLOPT_HTTPHEADER => [
                'Content-Type: application/json',
                'Authorization: Bearer ' . $this->settings['gpt_key'],
            ],
            CURLOPT_POSTFIELDS => json_encode($payload, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
            CURLOPT_TIMEOUT => 30,
        ]);

        $body = curl_exec($ch);
        $err = curl_error($ch);
        $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($code !== 200 || !$body) {
            $errorMessage = '';
            if ($body) {
                $decodedError = json_decode($body, true);
                if (isset($decodedError['error']['message'])) {
                    $errorMessage = trim((string)$decodedError['error']['message']);
                } elseif (is_string($body) && trim($body) !== '') {
                    $errorMessage = trim($body);
                }
            }

            if ($errorMessage === '' && $err !== '') {
                $errorMessage = $err;
            }

            if ($errorMessage === '' && $code) {
                $errorMessage = 'HTTP ' . $code;
            }

            $context = ['code' => $code, 'error' => $err, 'body' => $body];
            if ($errorMessage !== '') {
                $context['message'] = $errorMessage;
            }

            $this->logger->log('error', 'rewrite', null, 'GPT request failed', $context);

            $exceptionMessage = 'GPT API error';
            if ($errorMessage !== '') {
                $exceptionMessage .= ': ' . $errorMessage;
            }

            throw new RuntimeException($exceptionMessage);
        }

        $json = json_decode($body, true);
        $content = $json['choices'][0]['message']['content'] ?? '';
        $this->logger->log('info', 'rewrite', null, 'GPT success', ['prompt_len' => strlen($prompt), 'answer_len' => strlen($content)]);

        if (!$content) {
            throw new RuntimeException('Empty GPT response');
        }

        $content = trim($content);
        if (preg_match('/^```(?:json)?\s*(.+?)\s*```$/is', $content, $matches)) {
            $content = trim($matches[1]);
        }

        $decoded = json_decode($content, true);
        if (!is_array($decoded)) {
            $this->logger->log('error', 'rewrite', null, 'GPT response is not valid JSON', ['content' => $content]);
            $decoded = ['full_story' => $content];
        }

        return [
            'data' => $decoded,
            'raw' => $content,
            'usage' => isset($json['usage']) && is_array($json['usage']) ? $json['usage'] : [],
        ];
    }

    private function truncate(string $text, int $limit): string
    {
        if (function_exists('mb_strlen') && function_exists('mb_substr')) {
            if (mb_strlen($text, 'UTF-8') > $limit) {
                return mb_substr($text, 0, $limit, 'UTF-8');
            }
            return $text;
        }

        if (strlen($text) > $limit) {
            return substr($text, 0, $limit);
        }

        return $text;
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_admin_controller.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php

class GovParser_AdminController
{
    /** @var array */
    private $user;
    /** @var array */
    private $config;
    private $db;
    /** @var GovParser_ConfigRepository */
    private $configRepository;
    /** @var GovParser_QueueRepository */
    private $queueRepository;
    /** @var GovParser_Logger */
    private $logger;

    private const PROMPT_TYPES = [
        'short' => [
            'icon' => '🧾',
            'label' => 'SEO-анонс',
            'default' => 'Создай свежий SEO-анонс на 2–3 предложения по материалу [full-story]. Не повторяй дословно заголовок [title], используй ключевые факты [facts].'
        ],
        'title' => [
            'icon' => '📝',
            'label' => 'Заголовок',
            'default' => 'Перепиши заголовок новости, опираясь на анонс [short-story-rerite] и основные факты [facts]. Избегай клише и прямых повторов. Исходный заголовок: [title]'
        ],
        'full' => [
            'icon' => '📄',
            'label' => 'Полная новость',
            'default' => 'Перепиши текст новости литературным языком, сохрани факты и структуру. Используй заголовок [title-rerite], анонс [short-story-rerite] и исходный текст: [full-story]'
        ],
        'meta_title' => [
            'icon' => '🔖',
            'label' => 'Мета-заголовок',
            'default' => 'Составь мета-заголовок до 70 символов на основе [title-rerite] и анонса [short-story-rerite], избегая повтора исходного [title].'
        ],
        'meta_description' => [
            'icon' => '📌',
            'label' => 'Мета-описание',
            'default' => 'Напиши мета-описание до 160 символов, используя [title], [title-rerite] и анонс [short-story-rerite], избегая повторов.'
        ],
    ];

    private const STAGE_LABELS = [
        'ids' => 'Сбор ID',
        'fetch' => 'Загрузка контента',
        'ready' => 'Подготовка',
        'rewrite' => 'Рерайт',
        'publish' => 'Публикация',
    ];

    private const LOG_LEVEL_LABELS = [
        'info' => 'Инфо',
        'warning' => 'Предупреждение',
        'error' => 'Ошибка',
    ];

    private const CHECKLIST_LABELS = [
        'title_clean' => 'Заголовок',
        'description_clean' => 'Описание',
        'body_normalized' => 'Текст очищен',
        'media_extracted' => 'Медиа извлечены',
        'summary_ready' => 'Сводка',
        'facts_prepared' => 'Факты',
        'status_ready' => 'Статус',
        'meta_enriched' => 'Метаданные',
    ];

    public function __construct(array $user, array $config, $db)
    {
        $this->user = $user;
        $this->config = $config;
        $this->db = $db;
        $this->configRepository = new GovParser_ConfigRepository($db, PREFIX);
        $this->queueRepository = new GovParser_QueueRepository($db, PREFIX);
        $this->logger = new GovParser_Logger($db, PREFIX);
    }

    public function handle(array $request): void
    {
        if (!in_array('1', (array)$this->user['user_group'])) {
            die('Access denied');
        }

        $settings = $this->configRepository->load();

        if (!empty($request['action']) && $request['action'] === 'save') {
            $updated = $this->buildSettings($settings, $request);
            $this->configRepository->save($updated);
            $this->showMessage('success', 'Настройки сохранены', "<a href=\"?mod=gov_parser\">Вернуться</a>");
            return;
        }

        $this->renderPage($settings);
    }

    private function buildSettings(array $current, array $request): array
    {
        $settings = $current;

        $gptKey = trim($request['gpt_key'] ?? '');
        if ($gptKey === '' && !empty($current['gpt_key'])) {
            $gptKey = $current['gpt_key'];
        }

        $settings['gpt_key'] = $gptKey;
        $settings['gpt_model'] = trim($request['gpt_model'] ?? 'gpt-3.5-turbo');
        $settings['gpt_temperature'] = isset($request['gpt_temperature']) ? (float)$request['gpt_temperature'] : 0.6;
        $settings['target_category'] = (int)($request['target_category'] ?? 1);
        $settings['rewrite_enabled'] = !empty($request['rewrite_enabled']) ? 1 : 0;
        $settings['auto_publish'] = !empty($request['auto_publish']) ? 1 : 0;
        $settings['prompts_include_source'] = !empty($request['prompts_include_source']) ? 1 : 0;
        $settings['prompt_system'] = trim($request['prompt_system'] ?? '');

        $clearPassword = !empty($request['execution_password_clear']);
        $newPassword = trim((string)($request['execution_password'] ?? ''));
        if ($clearPassword) {
            unset($settings['execution_password_hash'], $settings['execution_password_fallback']);
        } elseif ($newPassword !== '') {
            if (function_exists('password_hash')) {
                $settings['execution_password_hash'] = password_hash($newPassword, PASSWORD_DEFAULT);
                unset($settings['execution_password_fallback']);
            } else {
                $settings['execution_password_hash'] = hash('sha256', $newPassword);
                $settings['execution_password_fallback'] = 1;
            }
        }

        $clearSecret = !empty($request['execution_secret_clear']);
        $newSecret = trim((string)($request['execution_secret'] ?? ''));
        if ($clearSecret) {
            unset($settings['execution_secret']);
        } elseif ($newSecret !== '') {
            $settings['execution_secret'] = $newSecret;
        }

        $settings['main_image_target'] = $this->sanitizeImageTarget($request['main_image_target'] ?? '', true);
        $settings['gallery_target'] = $this->sanitizeImageTarget($request['gallery_target'] ?? '', false);

        $prompts = [];
        $requestPrompts = $request['prompts'] ?? [];
        foreach (self::PROMPT_TYPES as $type => $meta) {
            $values = $requestPrompts[$type] ?? [];
            if (!is_array($values)) {
                $values = [$values];
            }

            $filtered = [];
            foreach ($values as $value) {
                $value = trim((string)$value);
                if ($value !== '') {
                    $filtered[] = $value;
                }
            }

            if ($filtered) {
                $prompts[$type] = array_values($filtered);
            }
        }

        if ($prompts) {
            $settings['prompts'] = $prompts;
        } else {
            unset($settings['prompts']);
        }

        if (!empty($prompts['full'][0])) {
            $settings['prompt_full'] = $prompts['full'][0];
        } else {
            unset($settings['prompt_full']);
        }

        return $settings;
    }

    private function renderPage(array $settings): void
    {
        echoheader('<i class="fa fa-newspaper-o"></i> gov_parser', 'Парсинг новостей gov.kz');

        $rewriteChecked = !empty($settings['rewrite_enabled']) ? 'checked' : '';
        $publishChecked = !empty($settings['auto_publish']) ? 'checked' : '';
        $includeSourceChecked = array_key_exists('prompts_include_source', $settings)
            ? (!empty($settings['prompts_include_source']) ? 'checked' : '')
            : 'checked';
        $gptModel = htmlspecialchars($settings['gpt_model'] ?? 'gpt-3.5-turbo', ENT_QUOTES, 'UTF-8');
        $gptTemp = htmlspecialchars((string)($settings['gpt_temperature'] ?? 0.6), ENT_QUOTES, 'UTF-8');
        $category = htmlspecialchars((string)($settings['target_category'] ?? 1), ENT_QUOTES, 'UTF-8');
        $promptSystem = htmlspecialchars($settings['prompt_system'] ?? '', ENT_QUOTES, 'UTF-8');
        $mainImageSelected = (string)($settings['main_image_target'] ?? 'xfield:picture');
        $gallerySelected = (string)($settings['gallery_target'] ?? 'full_story_append');
        $mainImageOptions = $this->buildImageTargetOptions(true);
        $galleryOptions = $this->buildImageTargetOptions(false);
        $prompts = $this->preparePromptValues($settings);
        $queueStats = $this->queueRepository->getStats();
        $recentQueue = $this->queueRepository->getRecent(20);
        $logEntries = $this->prepareLogEntries($this->logger->getRecent(15));

        $placeholdersList = [
            '[title]',
            '[title-rerite]',
            '[short-story]',
            '[short-story-plain]',
            '[short-story-rerite]',
            '[short-story-rerite-plain]',
            '[full-story]',
            '[full-story-plain]',
            '[full-story-html]',
            '[full-story-rerite]',
            '[summary]',
            '[facts]',
            '[facts-list]',
            '[facts-plain]',
            '[facts-json]',
            '[meta-title]',
            '[meta-description]',
            '[source]'
        ];
        $placeholdersInfo = implode(', ', $placeholdersList);
        $hasSavedKey = !empty($settings['gpt_key']);
        $hasScriptPassword = !empty($settings['execution_password_hash']);
        $hasScriptSecret = isset($settings['execution_secret']) && trim((string)$settings['execution_secret']) !== '';

        ob_start();
        ?>
        <?php if ($logEntries): ?>
        <div class="panel panel-default">
            <div class="panel-heading">Последние события</div>
            <div class="table-responsive">
                <table class="table table-striped table-condensed">
                    <thead>
                        <tr>
                            <th>Время</th>
                            <th>Этап</th>
                            <th>Уровень</th>
                            <th>Сообщение</th>
                            <th>Детали</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($logEntries as $log): ?>
                            <tr>
                                <td><?= $log['time'] ?></td>
                                <td><?= $log['stage'] ?></td>
                                <td><?= $log['level'] ?></td>
                                <td><?= $log['message'] ?></td>
                                <td>
                                    <?php if ($log['details'] !== ''): ?>
                                        <?= $log['details'] ?>
                                    <?php else: ?>
                                        <span class="text-muted">—</span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
        <?php endif; ?>
        <div class="panel panel-default">
            <div class="panel-heading">Очередь новостей</div>
            <div class="panel-body">
                <div class="row text-center">
                    <?php foreach (['new' => 'Новые', 'fetched' => 'Загружено', 'ready' => 'Готово к рерайту', 'rewritten' => 'Отправлено в публикацию', 'published' => 'Опубликовано', 'error' => 'Ошибки'] as $status => $label): ?>
                        <div class="col-sm-2 col-xs-4">
                            <div class="well">
                                <div class="h4" style="margin:0;"><?= (int)($queueStats[$status] ?? 0) ?></div>
                                <div class="small text-muted"><?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?></div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-condensed">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Источник</th>
                                <th>Статус</th>
                                <th>Обновлено</th>
                                <th>Комментарий</th>
                            </tr>
                        </thead>
                        <tbody>
                        <?php if (!$recentQueue): ?>
                            <tr>
                                <td colspan="5" class="text-center text-muted">Очередь пуста</td>
                            </tr>
                        <?php else: ?>
                            <?php foreach ($recentQueue as $row): ?>
                                <?php
                                $updatedAt = !empty($row['updated_at']) ? date('d.m.Y H:i', (int)$row['updated_at']) : '—';
                                $meta = [];
                                if (!empty($row['meta'])) {
                                    $decoded = json_decode($row['meta'], true);
                                    if (is_array($decoded)) {
                                        $meta = $decoded;
                                    }
                                }
                                $statusLabels = [
                                    'new' => 'Новая',
                                    'fetched' => 'Загружено',
                                    'ready' => 'Готово к рерайту',
                                    'rewritten' => 'Рерайт завершён',
                                    'published' => 'Опубликовано',
                                    'error' => 'Ошибка',
                                ];
                                $status = $row['status'] ?? 'new';
                                $statusText = $statusLabels[$status] ?? $status;
                                $progress = trim((string)($row['rewrite_progress'] ?? ''));
                                if ($progress !== '') {
                                    $progressLabels = [
                                        'short' => 'SEO-анонс',
                                        'title' => 'Заголовок',
                                        'meta' => 'Мета',
                                        'full' => 'Полный текст',
                                        'error' => 'Ошибка',
                                    ];
                                    $progressText = $progressLabels[$progress] ?? $progress;
                                    $statusText .= ' · ' . $progressText;
                                }
                                $commentHtml = $this->formatQueueComment($meta);
                                if ($commentHtml === '') {
                                    $commentHtml = '<span class="text-muted">—</span>';
                                }
                                ?>
                                <tr>
                                    <td><?= (int)$row['id'] ?></td>
                                    <td><?= (int)$row['source_id'] ?></td>
                                    <td><?= htmlspecialchars($statusText, ENT_QUOTES, 'UTF-8') ?></td>
                                    <td><?= htmlspecialchars($updatedAt, ENT_QUOTES, 'UTF-8') ?></td>
                                    <td><?= $commentHtml ?></td>
                                </tr>
                            <?php endforeach; ?>
                        <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <form method="post" id="gov-parser-settings">
            <input type="hidden" name="action" value="save" />
            <div class="panel panel-default">
                <div class="panel-heading">Настройки GPT</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label>API-ключ</label>
                        <input type="password" class="form-control" name="gpt_key" value="" placeholder="Введите ключ" autocomplete="off" />
                        <?php if ($hasSavedKey): ?>
                            <p class="help-block text-success">Текущий ключ сохранён. Оставьте поле пустым, чтобы не менять его.</p>
                        <?php endif; ?>
                    </div>
                    <div class="form-group">
                        <label>Модель</label>
                        <input type="text" class="form-control" name="gpt_model" value="<?= $gptModel ?>" />
                    </div>
                    <div class="form-group">
                        <label>Температура</label>
                        <input type="number" step="0.1" min="0" max="2" class="form-control" name="gpt_temperature" value="<?= $gptTemp ?>" />
                    </div>
                    <div class="form-group">
                        <label>System prompt</label>
                        <textarea class="form-control" name="prompt_system" rows="3"><?= $promptSystem ?></textarea>
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">Контент и публикация</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label>ID категории</label>
                        <input type="number" class="form-control" name="target_category" value="<?= $category ?>" />
                    </div>
                    <div class="form-group">
                        <label>Главное фото</label>
                        <select class="form-control" name="main_image_target">
                            <?php foreach ($mainImageOptions as $value => $label): ?>
                                <option value="<?= htmlspecialchars($value, ENT_QUOTES, 'UTF-8') ?>" <?= $value === $mainImageSelected ? 'selected' : '' ?>><?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?></option>
                            <?php endforeach; ?>
                        </select>
                        <p class="help-block">Выберите, куда сохранять обложку новости. Доп. поля можно настроить в панели управления DLE.</p>
                    </div>
                    <div class="form-group">
                        <label>Остальные фотографии</label>
                        <select class="form-control" name="gallery_target">
                            <?php foreach ($galleryOptions as $value => $label): ?>
                                <option value="<?= htmlspecialchars($value, ENT_QUOTES, 'UTF-8') ?>" <?= $value === $gallerySelected ? 'selected' : '' ?>><?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?></option>
                            <?php endforeach; ?>
                        </select>
                        <p class="help-block">Можно добавить галерею в конец текста или сохранить ссылки в дополнительное поле.</p>
                    </div>
                    <div class="checkbox">
                        <label><input type="checkbox" name="rewrite_enabled" value="1" <?= $rewriteChecked ?> /> Включить рерайт</label>
                    </div>
                    <div class="checkbox">
                        <label><input type="checkbox" name="auto_publish" value="1" <?= $publishChecked ?> /> Автопубликация</label>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Безопасность</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label>Секрет для запуска этапов</label>
                        <input type="text" class="form-control" name="execution_secret" value="" autocomplete="off" />
                        <?php if ($hasScriptSecret): ?>
                            <p class="help-block text-success">Секрет установлен. Передавайте его в параметре <code>secret</code> (&amp;secret=...) или заголовке <code>X-Gov-Parser-Secret</code>.</p>
                            <p class="help-block">Оставьте поле пустым, чтобы сохранить текущий секрет.</p>
                        <?php else: ?>
                            <p class="help-block">Укажите секрет, который потребуется добавлять в запрос (&amp;secret=...) при запуске этапов.</p>
                        <?php endif; ?>
                    </div>
                    <div class="checkbox">
                        <label><input type="checkbox" name="execution_secret_clear" value="1" /> Сбросить установленный секрет</label>
                    </div>
                    <div class="form-group">
                        <label>Пароль для выполнения скриптов</label>
                        <input type="password" class="form-control" name="execution_password" value="" autocomplete="off" />
                        <?php if ($hasScriptPassword): ?>
                            <p class="help-block text-success">Пароль установлен. Передавайте его в параметре <code>gov_parser_password</code> или заголовке <code>X-Gov-Parser-Password</code> при запуске этапов.</p>
                            <p class="help-block">Оставьте поле пустым, чтобы сохранить текущий пароль.</p>
                        <?php else: ?>
                            <p class="help-block">Задайте пароль, который потребуется указывать при обращении к ?do=gov_parser_*.</p>
                        <?php endif; ?>
                    </div>
                    <div class="checkbox">
                        <label><input type="checkbox" name="execution_password_clear" value="1" /> Сбросить установленный пароль</label>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">Вариации промптов</div>
                <div class="panel-body" data-role="gov-prompts">
                    <div class="checkbox">
                        <label><input type="checkbox" name="prompts_include_source" value="1" <?= $includeSourceChecked ?> /> Добавлять общий блок источника ко всем промптам</label>
                    </div>
                    <p class="help-block">Доступные переменные: <?= htmlspecialchars($placeholdersInfo, ENT_QUOTES, 'UTF-8') ?>.</p>
                    <p class="help-block">Используйте переменную [source], чтобы задать место вставки блока с исходными данными.</p>
                    <div class="panel-group" id="gov-prompts-accordion">
                        <?php $idx = 0; foreach (self::PROMPT_TYPES as $type => $meta): $idx++; ?>
                            <?php $panelId = 'gov-prompts-' . $type; ?>
                            <div class="panel panel-info" data-prompt-type="<?= htmlspecialchars($type, ENT_QUOTES, 'UTF-8') ?>">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#gov-prompts-accordion" href="#<?= $panelId ?>">
                                            <?= htmlspecialchars($meta['icon'] . ' ' . $meta['label'], ENT_QUOTES, 'UTF-8') ?>
                                        </a>
                                    </h4>
                                </div>
                                <div id="<?= $panelId ?>" class="panel-collapse collapse<?= $idx === 1 ? ' in' : '' ?>">
                                    <div class="panel-body">
                                        <div class="gov-prompt-variants">
                                            <?php foreach ($prompts[$type] as $value): ?>
                                                <div class="form-group gov-prompt-variant">
                                                    <textarea class="form-control" name="prompts[<?= htmlspecialchars($type, ENT_QUOTES, 'UTF-8') ?>][]" rows="3"><?= $value ?></textarea>
                                                    <button type="button" class="btn btn-link text-danger gov-remove-variant" title="Удалить вариант">Удалить</button>
                                                </div>
                                            <?php endforeach; ?>
                                        </div>
                                        <button type="button" class="btn btn-default btn-sm gov-add-variant" data-type="<?= htmlspecialchars($type, ENT_QUOTES, 'UTF-8') ?>">Добавить вариант</button>
                                    </div>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-body text-right">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </div>
        </form>

        <script>
        (function () {
            var container = document.querySelector('[data-role="gov-prompts"]');
            if (!container) {
                return;
            }

            container.addEventListener('click', function (event) {
                var target = event.target;
                if (target.classList.contains('gov-add-variant')) {
                    event.preventDefault();
                    var type = target.getAttribute('data-type');
                    var panel = target.closest('[data-prompt-type]');
                    if (!panel) {
                        return;
                    }
                    var variants = panel.querySelector('.gov-prompt-variants');
                    if (!variants) {
                        return;
                    }
                    var group = document.createElement('div');
                    group.className = 'form-group gov-prompt-variant';
                    group.innerHTML = '<textarea class="form-control" name="prompts[' + type + '][]" rows="3"></textarea>' +
                        '<button type="button" class="btn btn-link text-danger gov-remove-variant" title="Удалить вариант">Удалить</button>';
                    variants.appendChild(group);
                }

                if (target.classList.contains('gov-remove-variant')) {
                    event.preventDefault();
                    var parent = target.closest('.gov-prompt-variant');
                    if (parent && parent.parentNode.querySelectorAll('.gov-prompt-variant').length > 1) {
                        parent.parentNode.removeChild(parent);
                    } else if (parent) {
                        var textarea = parent.querySelector('textarea');
                        if (textarea) {
                            textarea.value = '';
                        }
                    }
                }
            });
        })();
        </script>
        <?php
        $html = ob_get_clean();
        echo $html;
        echofooter();
    }

    private function prepareLogEntries(array $logs): array
    {
        $result = [];
        foreach ($logs as $row) {
            $createdAt = !empty($row['created_at']) ? date('d.m.Y H:i', (int)$row['created_at']) : '—';
            $stage = (string)($row['stage'] ?? '');
            $level = strtolower((string)($row['level'] ?? ''));
            $message = (string)($row['message'] ?? '');

            $stageLabel = self::STAGE_LABELS[$stage] ?? ($stage !== '' ? $stage : '—');
            $levelLabel = self::LOG_LEVEL_LABELS[$level] ?? ($level !== '' ? ucfirst($level) : '—');
            $messageText = $message !== '' ? $message : '—';

            $result[] = [
                'time' => htmlspecialchars($createdAt, ENT_QUOTES, 'UTF-8'),
                'stage' => htmlspecialchars($stageLabel, ENT_QUOTES, 'UTF-8'),
                'level' => htmlspecialchars($levelLabel, ENT_QUOTES, 'UTF-8'),
                'message' => htmlspecialchars($messageText, ENT_QUOTES, 'UTF-8'),
                'details' => htmlspecialchars($this->formatLogDetails($row['context'] ?? ''), ENT_QUOTES, 'UTF-8'),
            ];
        }

        return $result;
    }

    private function formatLogDetails($context): string
    {
        if ($context === null || $context === '') {
            return '';
        }

        if (is_array($context)) {
            $data = $context;
        } else {
            $decoded = json_decode((string)$context, true);
            $data = is_array($decoded) ? $decoded : [];
        }

        if (!$data) {
            return '';
        }

        $parts = [];
        $count = 0;
        foreach ($data as $key => $value) {
            if ($count >= 6) {
                $parts[] = '…';
                break;
            }

            if (is_array($value) || is_object($value)) {
                $value = json_encode($value, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
            }

            $valueStr = (string)$value;
            $label = is_string($key) ? $key : ('item' . ($count + 1));
            $parts[] = $label . ': ' . $valueStr;
            $count++;
        }

        return implode('; ', $parts);
    }

    private function formatQueueComment(array $meta): string
    {
        $parts = [];

        if (!empty($meta['message'])) {
            $parts[] = '<div>' . htmlspecialchars((string)$meta['message'], ENT_QUOTES, 'UTF-8') . '</div>';
        }

        if (!empty($meta['telegram_source']) || !empty($meta['telegram_title'])) {
            $tgParts = [];
            if (!empty($meta['telegram_source'])) {
                $source = trim((string)$meta['telegram_source']);
                if ($source !== '' && !preg_match('/[:：]\s*$/u', $source)) {
                    $source .= ':';
                }
                if ($source !== '') {
                    $tgParts[] = '<strong>' . htmlspecialchars($source, ENT_QUOTES, 'UTF-8') . '</strong>';
                }
            }
            if (!empty($meta['telegram_title'])) {
                $tgParts[] = htmlspecialchars((string)$meta['telegram_title'], ENT_QUOTES, 'UTF-8');
            }
            if ($tgParts) {
                $parts[] = '<div class="small">TG: ' . implode(' ', $tgParts) . '</div>';
            }
        }

        if (!empty($meta['summary'])) {
            $parts[] = '<div class="small"><strong>Резюме:</strong> ' . htmlspecialchars((string)$meta['summary'], ENT_QUOTES, 'UTF-8') . '</div>';
        }

        if (!empty($meta['key_facts']) && is_array($meta['key_facts'])) {
            $factItems = [];
            foreach ($meta['key_facts'] as $fact) {
                $fact = trim((string)$fact);
                if ($fact === '') {
                    continue;
                }
                $factItems[] = '<li>' . htmlspecialchars($fact, ENT_QUOTES, 'UTF-8') . '</li>';
            }
            if ($factItems) {
                $parts[] = '<ul class="small" style="margin:5px 0 0 18px;padding:0;list-style:disc;">' . implode('', $factItems) . '</ul>';
            }
        }

        if (!empty($meta['checklist']) && is_array($meta['checklist'])) {
            $checkItems = [];
            foreach ($meta['checklist'] as $key => $value) {
                $label = self::CHECKLIST_LABELS[$key] ?? (string)$key;
                $icon = !empty($value) ? '✅' : '⚠️';
                $checkItems[] = $icon . ' ' . htmlspecialchars($label, ENT_QUOTES, 'UTF-8');
            }
            if ($checkItems) {
                $parts[] = '<div class="small text-muted">' . implode(' ', $checkItems) . '</div>';
            }
        }

        $details = [];
        if (!empty($meta['url'])) {
            $safeUrl = htmlspecialchars((string)$meta['url'], ENT_QUOTES, 'UTF-8');
            $details[] = 'URL: <a href="' . $safeUrl . '" target="_blank" rel="noopener">' . $safeUrl . '</a>';
        }

        if (!empty($meta['telegram_url'])) {
            $safeTgUrl = htmlspecialchars((string)$meta['telegram_url'], ENT_QUOTES, 'UTF-8');
            $details[] = 'TG: <a href="' . $safeTgUrl . '" target="_blank" rel="noopener">' . $safeTgUrl . '</a>';
        }

        $detailMap = [
            'status' => 'HTTP',
            'lang' => 'Язык',
            'count' => 'Количество',
            'body_length' => 'HTML',
            'plain_length' => 'Текст',
            'body_source' => 'Поле',
            'body_checked' => 'Проверено',
            'body_media_only' => 'Только медиа',
            'skip_reason' => 'Пропуск',
            'post_id' => 'ID публикации',
            'category_ids' => 'Категории',
            'subcategory_id' => 'Подкатегория',
        ];

        foreach ($detailMap as $key => $label) {
            if (isset($meta[$key]) && $meta[$key] !== '' && $meta[$key] !== null) {
                $details[] = htmlspecialchars($label, ENT_QUOTES, 'UTF-8') . ': ' . htmlspecialchars((string)$meta[$key], ENT_QUOTES, 'UTF-8');
            }
        }

        if (!empty($meta['error'])) {
            $details[] = 'Ошибка: ' . htmlspecialchars((string)$meta['error'], ENT_QUOTES, 'UTF-8');
        }

        if ($details) {
            $parts[] = '<div class="small text-muted">' . implode('; ', $details) . '</div>';
        }

        return implode('', $parts);
    }

    private function buildImageTargetOptions(bool $isMain): array
    {
        $options = ['none' => 'Не загружать'];

        if ($isMain) {
            $options['full_story_prepend'] = 'В начало полного текста';
            $options['full_story_append'] = 'В конец полного текста';
            $options['short_story_prepend'] = 'В начало анонса';
        }

        $options['full_story_append'] = 'Добавить в конец полного текста';

        if ($isMain) {
            $options['xfield:picture'] = 'Доп. поле: picture';
        }

        return $options;
    }

    private function sanitizeImageTarget($value, bool $allowShortStory): string
    {
        $value = trim((string)$value);
        $default = $allowShortStory ? 'xfield:picture' : 'full_story_append';

        $allowed = $allowShortStory
            ? ['none', 'full_story_prepend', 'full_story_append', 'short_story_prepend', 'xfield:picture']
            : ['none', 'full_story_append'];

        if (in_array($value, $allowed, true)) {
            return $value;
        }

        return $default;
    }

    private function preparePromptValues(array $settings): array
    {
        $result = [];
        $saved = [];
        if (!empty($settings['prompts']) && is_array($settings['prompts'])) {
            $saved = $settings['prompts'];
        }

        if (empty($saved['full']) && !empty($settings['prompt_full'])) {
            $saved['full'] = [$settings['prompt_full']];
        }

        foreach (self::PROMPT_TYPES as $type => $meta) {
            $values = [];
            if (!empty($saved[$type]) && is_array($saved[$type])) {
                $values = $saved[$type];
            }

            if (!$values) {
                $values = [$meta['default']];
            }

            $result[$type] = array_map(static function ($value) {
                return htmlspecialchars((string)$value, ENT_QUOTES, 'UTF-8');
            }, $values);
        }

        return $result;
    }

    private function showMessage(string $type, string $title, string $message): void
    {
        if (function_exists('msgbox')) {
            msgbox($type, $title, $message);
            return;
        }

        $class = $type === 'success' ? 'alert-success' : ($type === 'error' ? 'alert-danger' : 'alert-info');
        echo '<div class="alert ' . $class . '"><strong>' . htmlspecialchars($title, ENT_QUOTES, 'UTF-8') . '</strong><br>' . $message . '</div>';
    }
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_ids.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);
define('DATALIFEENGINE', true);
define('ROOT_DIR', dirname(__FILE__, 2));
define('ENGINE_DIR', ROOT_DIR . '/engine');

require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';
include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

gov_parser_require_password();

$http = new GovParser_HttpClient();
$collector = new GovParser_TelegramIdCollector($http);
$queue = new GovParser_QueueRepository($db, PREFIX);
$logger = new GovParser_Logger($db, PREFIX);

try {
    $items = $collector->fetchIds(20);
    foreach ($items as $item) {
        if (is_array($item)) {
            $id = (int)($item['id'] ?? 0);
            if ($id <= 0) {
                continue;
            }

            $meta = [];
            if (!empty($item['source'])) {
                $meta['telegram_source'] = trim((string)$item['source']);
            }
            if (!empty($item['time'])) {
                $meta['telegram_time'] = trim((string)$item['time']);
            }
            if (!empty($item['title'])) {
                $meta['telegram_title'] = trim((string)$item['title']);
            }
            if (!empty($item['news_url'])) {
                $meta['telegram_news_url'] = trim((string)$item['news_url']);
            }
            if (!empty($item['telegram_url'])) {
                $meta['telegram_post_url'] = trim((string)$item['telegram_url']);
            }
            if (!empty($item['telegram_post_id'])) {
                $meta['telegram_post_id'] = (int)$item['telegram_post_id'];
            } elseif (!empty($item['telegram_id'])) {
                $meta['telegram_post_id'] = (int)$item['telegram_id'];
            }

            $queue->createOrTouch($id, $meta);
            continue;
        }

        $queue->createOrTouch((int)$item);
    }
    $logger->log('info', 'ids', null, 'IDs collected', ['count' => count($items)]);
} catch (\Throwable $e) {
    $logger->log('error', 'ids', null, $e->getMessage());
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_fetch.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);
define('DATALIFEENGINE', true);
define('ROOT_DIR', dirname(__FILE__, 2));
define('ENGINE_DIR', ROOT_DIR . '/engine');

require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';
include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

gov_parser_require_password();

$http = new GovParser_HttpClient();
$api = new GovParser_GovApiClient($http);
$queue = new GovParser_QueueRepository($db, PREFIX);
$logger = new GovParser_Logger($db, PREFIX);

try {
    $items = $queue->claimBatch('new', 20);
    foreach ($items as $item) {
        try {
            $lang = 'ru';
            $payload = $api->getNews((int)$item['source_id'], $lang);

            $existingMeta = [];
            if (!empty($item['meta'])) {
                $decodedMeta = json_decode($item['meta'], true);
                if (is_array($decodedMeta)) {
                    $existingMeta = $decodedMeta;
                }
            }

            $bodyInfo = [
                'html' => '',
                'plain' => '',
                'plain_length' => 0,
                'media_only' => false,
                'source' => null,
                'checked' => [],
            ];

            if (is_array($payload)) {
                $extracted = GovParser_PayloadHelper::extractBody($payload, $lang);
                if (is_array($extracted)) {
                    $bodyInfo = array_merge($bodyInfo, $extracted);
                }
            }

            $bodyHtml = trim((string)($bodyInfo['html'] ?? ''));
            $plainBody = (string)($bodyInfo['plain'] ?? '');
            $plainLength = isset($bodyInfo['plain_length']) ? (int)$bodyInfo['plain_length'] : 0;
            if ($plainLength <= 0 && $plainBody !== '') {
                $plainLength = function_exists('mb_strlen') ? mb_strlen($plainBody) : strlen($plainBody);
            }

            $hasBody = $bodyHtml !== '' && ($plainBody !== '' || !empty($bodyInfo['media_only']));

            if (!$hasBody) {
                $context = [
                    'url' => $api->getLastUrl(),
                    'status' => $api->getLastStatus(),
                    'lang' => $lang,
                ];
                if ($api->getLastError()) {
                    $context['error'] = $api->getLastError();
                }
                if (is_array($payload)) {
                    $context['fields'] = array_keys($payload);
                }
                if ($plainLength > 0) {
                    $context['plain_length'] = $plainLength;
                }
                if (!empty($bodyInfo['source'])) {
                    $context['body_source'] = $bodyInfo['source'];
                }
                if (!empty($bodyInfo['checked'])) {
                    $context['body_checked'] = $bodyInfo['checked'];
                }

                $logger->log('warning', 'fetch', (int)$item['source_id'], 'Empty body returned from gov.kz API', $context);

                $meta = $existingMeta;
                $meta['message'] = 'Empty body returned from gov.kz API';
                $meta['url'] = $api->getLastUrl();
                $meta['status'] = $api->getLastStatus();
                $meta['lang'] = $lang;
                $meta['plain_length'] = $plainLength;
                if ($api->getLastError()) {
                    $meta['error'] = $api->getLastError();
                }
                if (!empty($bodyInfo['source'])) {
                    $meta['body_source'] = $bodyInfo['source'];
                }
                if (!empty($bodyInfo['checked'])) {
                    $meta['body_checked'] = $bodyInfo['checked'];
                }

                $queue->updateStatus((int)$item['id'], 'new', [
                    'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),
                ]);

                continue;
            }

            $bodyLength = function_exists('mb_strlen') ? mb_strlen($bodyHtml) : strlen($bodyHtml);
            $meta = $existingMeta;
            $meta['message'] = 'Контент получен с gov.kz';
            $meta['url'] = $api->getLastUrl();
            $meta['status'] = $api->getLastStatus();
            $meta['lang'] = $lang;
            $meta['body_length'] = $bodyLength;
            $meta['plain_length'] = $plainLength;
            $meta['body_source'] = $bodyInfo['source'];
            $meta['body_checked'] = $bodyInfo['checked'];
            $meta['body_media_only'] = !empty($bodyInfo['media_only']) ? 1 : 0;

            $queue->updateStatus((int)$item['id'], 'fetched', [
                'payload_raw' => json_encode($payload, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),
                'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),
            ]);

            $logger->log('info', 'fetch', (int)$item['source_id'], 'News payload fetched', [
                'url' => $api->getLastUrl(),
                'status' => $api->getLastStatus(),
                'lang' => $lang,
                'body_length' => $bodyLength,
                'plain_length' => $plainLength,
                'body_source' => $bodyInfo['source'],
                'body_media_only' => !empty($bodyInfo['media_only']) ? 1 : 0,
            ]);
        } catch (\Throwable $ex) {
            $queue->updateStatus((int)$item['id'], 'error', [
                'meta' => json_encode([
                    'message' => $ex->getMessage(),
                    'url' => $api->getLastUrl(),
                    'status' => $api->getLastStatus(),
                    'lang' => isset($lang) ? $lang : null,
                ], JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES)
            ]);
            $logger->log('error', 'fetch', (int)$item['source_id'], $ex->getMessage(), [
                'url' => $api->getLastUrl(),
                'status' => $api->getLastStatus(),
                'lang' => isset($lang) ? $lang : null,
            ]);
        }
    }
    $logger->log('info', 'fetch', null, 'Fetched batch', ['count' => count($items)]);
} catch (\Throwable $e) {
    $logger->log('error', 'fetch', null, $e->getMessage());
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_prepare.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);
define('DATALIFEENGINE', true);
define('ROOT_DIR', dirname(__FILE__, 2));
define('ENGINE_DIR', ROOT_DIR . '/engine');

require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';
include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

gov_parser_require_password();

$configRepo = new GovParser_ConfigRepository($db, PREFIX);
$settings = $configRepo->load();
$logger = new GovParser_Logger($db, PREFIX);
$queue = new GovParser_QueueRepository($db, PREFIX);

$stopWords = [];
if (!empty($settings['stop_words'])) {
    if (is_array($settings['stop_words'])) {
        $stopWords = $settings['stop_words'];
    } elseif (is_string($settings['stop_words'])) {
        $stopWords = preg_split('/[\r\n,;]+/u', $settings['stop_words']);
    }
}

$preparer = new GovParser_ContentPreparationService(is_array($stopWords) ? $stopWords : []);

try {
    $items = $queue->claimBatch('fetched', 20);
    foreach ($items as $item) {
        try {
            $payload = json_decode($item['payload_raw'], true);
            if (!is_array($payload)) {
                throw new RuntimeException('payload_raw is empty');
            }

            $lang = 'ru';
            $meta = [];
            if (!empty($item['meta'])) {
                $decodedMeta = json_decode($item['meta'], true);
                if (is_array($decodedMeta)) {
                    $meta = $decodedMeta;
                }
            }

            $result = $preparer->prepare((int)$item['source_id'], $payload, $lang);

            $meta = array_merge($meta, [
                'message' => 'Готово к рерайту',
                'plain_length' => $result['plain_length'],
                'summary' => $result['summary'],
                'key_facts' => $result['key_facts'],
                'checklist' => $result['checklist'],
                'issues' => $result['issues'],
                'clean_log' => $result['clean_log'],
                'body_hash' => $result['body_hash'],
                'media' => $result['media_assets'],
                'rewrite_payload' => $result['rewrite_payload'],
                'source_meta' => $result['source_meta'],
                'prepared_at' => gmdate('c'),
            ]);

            if (!empty($result['source_meta']['url'])) {
                $meta['url'] = $result['source_meta']['url'];
            }
            if (!empty($result['source_meta']['published_at'])) {
                $meta['published_at'] = $result['source_meta']['published_at'];
            }

            $queue->updateStatus((int)$item['id'], 'ready', [
                'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),
            ]);

            $logger->log('info', 'ready', (int)$item['source_id'], 'Контент готов к рерайту', [
                'plain_length' => $result['plain_length'],
                'media' => count($result['rewrite_payload']['media_refs']),
                'summary_len' => GovParser_PayloadHelper::stringLength($result['summary']),
            ]);

            if (!empty($result['issues'])) {
                $logger->log('warning', 'ready', (int)$item['source_id'], 'Контент подготовлен с предупреждениями', [
                    'issues' => $result['issues'],
                ]);
            }
        } catch (\Throwable $ex) {
            $meta = [];
            if (!empty($item['meta'])) {
                $decodedMeta = json_decode($item['meta'], true);
                if (is_array($decodedMeta)) {
                    $meta = $decodedMeta;
                }
            }

            $errorMessage = $ex->getMessage();
            $skipPatterns = [
                'Пустой основной текст',
                'Основной текст пуст',
                'payload_raw is empty',
                'Payload body is empty',
            ];
            $shouldSkip = false;
            foreach ($skipPatterns as $pattern) {
                if ($pattern === '') {
                    continue;
                }
                if (function_exists('mb_stripos')) {
                    if (mb_stripos($errorMessage, $pattern) !== false) {
                        $shouldSkip = true;
                        break;
                    }
                } elseif (stripos($errorMessage, $pattern) !== false) {
                    $shouldSkip = true;
                    break;
                }
            }

            if ($shouldSkip) {
                $meta['message'] = 'Пропущено: новость без текста';
                $meta['skip_reason'] = 'empty_body';
            } else {
                $meta['message'] = $errorMessage;
            }

            $meta['error'] = $errorMessage;
            $meta['error_stage'] = 'prepare';

            $queue->updateStatus((int)$item['id'], 'error', [
                'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES),
            ]);

            $logger->log('error', 'ready', (int)$item['source_id'], $errorMessage);
        }
    }

    $logger->log('info', 'ready', null, 'Preparation batch', ['count' => count($items)]);
} catch (\Throwable $e) {
    $logger->log('error', 'ready', null, $e->getMessage());
}
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_rewrite.php">
		<operation action="create">
			<replacecode><![CDATA[
<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);
define('DATALIFEENGINE', true);
define('ROOT_DIR', dirname(__FILE__, 2));
define('ENGINE_DIR', ROOT_DIR . '/engine');

require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';
include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

gov_parser_require_password();

header('Content-Type: text/html; charset=utf-8');

$configRepo = new GovParser_ConfigRepository($db, PREFIX);
$settings = $configRepo->load();
$logger = new GovParser_Logger($db, PREFIX);
$queue = new GovParser_QueueRepository($db, PREFIX);
$service = new GovParser_RewriteService($settings, $logger);

$results = [];
$globalErrors = [];

try {
    $items = $queue->claimBatch('ready', 1);
    if (empty($items)) {
        $results[] = [
            'source_id' => null,
            'status' => 'empty',
            'message' => 'Очередь пуста — новых материалов нет.',
        ];
    }

    foreach ($items as $item) {
        $itemStartedAt = microtime(true);

        try {
            $lang = 'ru';
            $meta = [];
            if (!empty($item['meta'])) {
                $decodedMeta = json_decode($item['meta'], true);
                if (is_array($decodedMeta)) {
                    $meta = $decodedMeta;
                }
            }

            $prepared = [];
            if (!empty($meta['rewrite_payload']) && is_array($meta['rewrite_payload'])) {
                $prepared = $meta['rewrite_payload'];
            }

            $title = trim((string)($prepared['title'] ?? ''));
            $bodyHtml = trim((string)($prepared['body'] ?? ''));
            $preview = trim((string)($prepared['short'] ?? ''));
            $summary = trim((string)($meta['summary'] ?? ''));
            $facts = [];
            if (!empty($meta['key_facts']) && is_array($meta['key_facts'])) {
                foreach ($meta['key_facts'] as $fact) {
                    $fact = trim((string)$fact);
                    if ($fact !== '') {
                        $facts[] = $fact;
                    }
                }
            }

            if ($title === '' || $bodyHtml === '') {
                $payload = json_decode($item['payload_raw'], true);
                if (!is_array($payload)) {
                    throw new RuntimeException('payload_raw is empty');
                }

                if ($title === '') {
                    $title = GovParser_PayloadHelper::extractTitle($payload, $lang);
                    if ($title === '') {
                        foreach (['title_ru', 'title', 'title_kz', 'title_en'] as $field) {
                            if (!empty($payload[$field])) {
                                $title = trim((string)$payload[$field]);
                                if ($title !== '') {
                                    break;
                                }
                            }
                        }
                    }
                }

                if ($bodyHtml === '') {
                    $bodyInfo = GovParser_PayloadHelper::extractBody($payload, $lang);
                    $bodyHtml = trim((string)($bodyInfo['html'] ?? ''));
                    if ($bodyHtml === '') {
                        throw new RuntimeException('Payload body is empty');
                    }
                    $meta['body_source'] = $bodyInfo['source'] ?? ($meta['body_source'] ?? null);
                    $meta['body_checked'] = $bodyInfo['checked'] ?? ($meta['body_checked'] ?? null);
                    $meta['body_media_only'] = !empty($bodyInfo['media_only']) ? 1 : ($meta['body_media_only'] ?? 0);
                    if (!isset($meta['plain_length']) && isset($bodyInfo['plain_length'])) {
                        $meta['plain_length'] = $bodyInfo['plain_length'];
                    }
                    if ($preview === '') {
                        $preview = GovParser_PayloadHelper::extractPreview($payload, $lang);
                    }
                    if ($summary === '') {
                        $summary = $preview;
                    }
                }
            }

            if ($title === '') {
                throw new RuntimeException('Не удалось определить заголовок для рерайта');
            }

            if ($bodyHtml === '') {
                throw new RuntimeException('Очищенный текст пуст');
            }

            $plainText = GovParser_PayloadHelper::htmlToPlain($bodyHtml);
            $plainLength = GovParser_PayloadHelper::stringLength($plainText);

            if ($plainLength < 100) {
                throw new RuntimeException('Подготовленный текст слишком короткий для рерайта');
            }

            if ($preview === '' && $summary !== '') {
                $preview = $summary;
            }

            if ($summary === '' && $preview !== '') {
                $summary = $preview;
            }

            $normalized = [
                'title' => $title,
                'preview' => $preview,
                'text' => $bodyHtml,
                'summary' => $summary,
                'facts' => $facts,
            ];

            $rewriteOutcome = $service->rewrite($normalized);
            $rewrite = $rewriteOutcome['result'];
            $report = $rewriteOutcome['report'];
            $progress = $rewriteOutcome['progress'] ?? '';

            $titleData = is_array($rewrite['title'] ?? null) ? $rewrite['title'] : [];
            $shortData = is_array($rewrite['short_story'] ?? null) ? $rewrite['short_story'] : [];
            $bodyData = is_array($rewrite['body'] ?? null) ? $rewrite['body'] : [];

            $titleRewrite = (string)($titleData['rerite'] ?? $titleData['rewrite'] ?? $titleData['original'] ?? '');
            $shortRewrite = (string)($shortData['rerite'] ?? $shortData['rewrite'] ?? $shortData['original'] ?? '');
            $fullRewrite = (string)($bodyData['rerite'] ?? $bodyData['rewrite'] ?? $bodyData['original'] ?? '');

            $meta['message'] = 'Рерайт подготовлен';
            $meta['plain_length'] = $plainLength;
            $meta['rewrite_result'] = [
                'title_length' => GovParser_PayloadHelper::stringLength($titleRewrite),
                'short_length' => GovParser_PayloadHelper::stringLength(strip_tags($shortRewrite)),
                'full_length' => GovParser_PayloadHelper::stringLength(strip_tags($fullRewrite)),
            ];
            $meta['rewrite_report'] = $report;
            if ($progress !== '') {
                $meta['rewrite_progress'] = $progress;
            }
            if (!empty($rewrite['tags']) && is_array($rewrite['tags'])) {
                $meta['rewrite_tags'] = $rewrite['tags'];
            }

            $metrics = [
                'rewrite' => [
                    'duration_ms' => $report['duration_ms'] ?? 0,
                    'prompt_length' => GovParser_PayloadHelper::stringLength((string)($report['prompt_full'] ?? '')),
                    'answer_length' => GovParser_PayloadHelper::stringLength((string)($report['response_raw'] ?? '')),
                ],
            ];

            $queue->updateStatus((int)$item['id'], 'rewritten', [
                'payload_rewrite' => json_encode($rewrite, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                'metrics' => json_encode($metrics, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                'rewrite_progress' => $progress !== '' ? $progress : '',
            ]);

            $results[] = [
                'source_id' => (int)$item['source_id'],
                'status' => 'ok',
                'message' => 'Рерайт подготовлен',
                'report' => $report,
                'duration_ms' => (int)round((microtime(true) - $itemStartedAt) * 1000),
                'progress' => $progress,
            ];
        } catch (\Throwable $ex) {
            $errorMeta = [];
            if (!empty($item['meta'])) {
                $decodedMeta = json_decode($item['meta'], true);
                if (is_array($decodedMeta)) {
                    $errorMeta = $decodedMeta;
                }
            }
            $errorMeta['message'] = $ex->getMessage();
            $errorMeta['error'] = $ex->getMessage();
            $errorMeta['error_stage'] = 'rewrite';
            $errorMeta['rewrite_progress'] = 'error';

            $queue->updateStatus((int)$item['id'], 'error', [
                'meta' => json_encode($errorMeta, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                'rewrite_progress' => 'error',
            ]);
            $logger->log('error', 'rewrite', (int)$item['source_id'], $ex->getMessage());

            $results[] = [
                'source_id' => (int)$item['source_id'],
                'status' => 'error',
                'message' => $ex->getMessage(),
            ];
        }
    }

    if (!empty($items)) {
        $logger->log('info', 'rewrite', null, 'Rewrite batch', ['count' => count($items)]);
    }
} catch (\Throwable $e) {
    $globalErrors[] = $e->getMessage();
    $logger->log('error', 'rewrite', null, $e->getMessage());
}

echo '<!DOCTYPE html><html lang="ru"><head><meta charset="utf-8"><title>gov_parser — рерайт</title>';
echo '<style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f6f8; color:#1f2d3d; }
    h1 { font-size: 22px; margin-bottom: 10px; }
    h2 { font-size: 18px; margin-top: 30px; }
    .gov-card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.04); padding:20px; margin-bottom:20px; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th, td { border:1px solid #dbe2ea; padding:10px; vertical-align:top; font-size:13px; }
    th { background:#eef3fb; text-transform:uppercase; font-weight:600; letter-spacing:0.03em; }
    .status-ok { color:#1c7c54; font-weight:600; }
    .status-error { color:#c62828; font-weight:600; }
    .status-empty { color:#5f6b7d; font-weight:600; }
    .gov-pre { background:#f8fafc; border-radius:8px; padding:8px 10px; margin:0; white-space:pre-wrap; word-break:break-word; }
    .gov-meta { margin-top:10px; font-size:13px; color:#51606f; }
    details { margin-top:10px; }
    summary { cursor:pointer; font-weight:600; }
    .gov-error { background:#ffecec; border:1px solid #ffcdd2; color:#b71c1c; padding:12px 15px; border-radius:10px; margin-bottom:15px; }
    .gov-empty { padding:40px 0; text-align:center; color:#5f6b7d; font-size:16px; }
</style></head><body>';

echo '<h1>Этап рерайта (gov_parser)</h1>';

foreach ($globalErrors as $error) {
    echo '<div class="gov-error">' . htmlspecialchars($error, ENT_QUOTES, 'UTF-8') . '</div>';
}

if (!$results) {
    echo '<div class="gov-empty">Данных для отображения нет.</div>';
} else {
    foreach ($results as $result) {
        echo '<div class="gov-card">';
        if ($result['status'] === 'empty') {
            echo '<div class="status-empty">' . htmlspecialchars($result['message'], ENT_QUOTES, 'UTF-8') . '</div>';
            echo '</div>';
            continue;
        }

        $header = 'Источник #' . (int)$result['source_id'];
        $statusClass = $result['status'] === 'ok' ? 'status-ok' : 'status-error';
        echo '<h2>' . htmlspecialchars($header, ENT_QUOTES, 'UTF-8') . ' — <span class="' . $statusClass . '">' . htmlspecialchars($result['status'], ENT_QUOTES, 'UTF-8') . '</span></h2>';
        echo '<div class="gov-meta">' . htmlspecialchars($result['message'], ENT_QUOTES, 'UTF-8');
        if (!empty($result['duration_ms'])) {
            echo ' · время обработки: ' . (int)$result['duration_ms'] . ' мс';
        }
        echo '</div>';

        $report = $result['report'] ?? [];
        if (!empty($report['prompt_full'])) {
            echo '<details><summary>Отправленный промпт</summary><pre class="gov-pre">' . htmlspecialchars($report['prompt_full'], ENT_QUOTES, 'UTF-8') . '</pre></details>';
        }
        if (!empty($report['response_raw'])) {
            echo '<details><summary>Ответ ChatGPT</summary><pre class="gov-pre">' . htmlspecialchars($report['response_raw'], ENT_QUOTES, 'UTF-8') . '</pre></details>';
        }

        $steps = $report['steps'] ?? [];
        echo '<table><thead><tr><th>Шаг</th><th>Отправленный промпт</th><th>Ответ</th><th>Длины</th><th>Usage</th><th>Время</th><th>Статус</th></tr></thead><tbody>';
        if (!$steps) {
            echo '<tr><td colspan="7" style="text-align:center; color:#5f6b7d;">Данные о шагах отсутствуют</td></tr>';
        } else {
            foreach ($steps as $row) {
                $prompt = $row['prompt'] ?? '';
                $answer = $row['answer'] ?? '';
                $lengths = $row['lengths'] ?? ['prompt' => 0, 'answer' => 0];
                $usage = $row['usage'] ?? '—';
                $time = isset($row['duration_ms']) && $row['duration_ms'] > 0 ? ((int)$row['duration_ms'] . ' мс') : '—';
                $rowStatus = $row['status'] ?? '—';
                $rowMessage = trim((string)($row['message'] ?? ''));
                $rowClass = $rowStatus === 'ok' ? 'status-ok' : ($rowStatus === 'empty' ? 'status-empty' : 'status-error');

                echo '<tr>';
                echo '<td>' . htmlspecialchars((string)($row['step'] ?? '—'), ENT_QUOTES, 'UTF-8') . '</td>';
                echo '<td><pre class="gov-pre">' . htmlspecialchars($prompt, ENT_QUOTES, 'UTF-8') . '</pre></td>';
                echo '<td><pre class="gov-pre">' . htmlspecialchars($answer, ENT_QUOTES, 'UTF-8') . '</pre></td>';
                echo '<td>prompt: ' . (int)($lengths['prompt'] ?? 0) . '<br>answer: ' . (int)($lengths['answer'] ?? 0) . '</td>';
                echo '<td>' . htmlspecialchars((string)$usage, ENT_QUOTES, 'UTF-8') . '</td>';
                echo '<td>' . htmlspecialchars($time, ENT_QUOTES, 'UTF-8') . '</td>';
                $statusHtml = htmlspecialchars($rowStatus, ENT_QUOTES, 'UTF-8');
                if ($rowMessage !== '') {
                    $statusHtml .= '<br><span style="font-weight:400; color:#51606f;">' . htmlspecialchars($rowMessage, ENT_QUOTES, 'UTF-8') . '</span>';
                }
                echo '<td class="' . $rowClass . '">' . $statusHtml . '</td>';
                echo '</tr>';
            }
        }
        echo '</tbody></table>';

        echo '</div>';
    }
}

echo '</body></html>';
?>
            ]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_publish.php">
		<operation action="create">
			<replacecode><![CDATA[<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);
define('DATALIFEENGINE', true);
define('ROOT_DIR', dirname(__FILE__, 2));
define('ENGINE_DIR', ROOT_DIR . '/engine');

require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';
include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

gov_parser_require_password();

header('Content-Type: text/html; charset=utf-8');

$reports = [];
$globalErrors = [];
$govParserShutdownRendered = false;
$logger = null;
$configRepo = null;
$queue = null;
$categoryManager = null;
$settings = [];

set_error_handler(function ($severity, $message, $file, $line) use (&$globalErrors, &$logger) {
    $handled = [E_WARNING, E_USER_WARNING, E_RECOVERABLE_ERROR, E_USER_ERROR];
    if (!in_array($severity, $handled, true)) {
        return false;
    }

    $normalizedMessage = strtolower((string)$message);
    if (strpos($normalizedMessage, 'exif_read_data(') !== false && strpos($normalizedMessage, 'file not supported') !== false) {
        if ($logger instanceof GovParser_Logger) {
            $logger->log('debug', 'publish', null, $message, [
                'file' => $file,
                'line' => $line,
                'severity' => $severity,
            ]);
        }

        return true;
    }

    $formatted = $message . ' (' . basename((string)$file) . ':' . (int)$line . ')';
    $globalErrors[] = 'PHP: ' . $formatted;

    if ($logger instanceof GovParser_Logger) {
        $logger->log('warning', 'publish', null, $message, [
            'file' => $file,
            'line' => $line,
            'severity' => $severity,
        ]);
    }

    return false;
});

register_shutdown_function(function () use (&$globalErrors, &$reports, &$govParserShutdownRendered, &$logger) {
    if ($govParserShutdownRendered) {
        return;
    }

    $error = error_get_last();
    if (!$error || !in_array($error['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR, E_USER_ERROR], true)) {
        return;
    }

    $govParserShutdownRendered = true;
    $message = $error['message'] . ' (' . $error['file'] . ':' . $error['line'] . ')';
    $globalErrors[] = 'Фатальная ошибка: ' . $message;

    if ($logger instanceof GovParser_Logger) {
        $logger->log('error', 'publish', null, $error['message'], [
            'file' => $error['file'],
            'line' => $error['line'],
            'type' => $error['type'],
        ]);
    }

    gov_parser_render_publish_page($globalErrors, $reports);
});

try {
    $configRepo = new GovParser_ConfigRepository($db, PREFIX);
    $settings = $configRepo->load();
    $queue = new GovParser_QueueRepository($db, PREFIX);
    $logger = new GovParser_Logger($db, PREFIX);
    $categoryManager = new GovParser_CategoryManager($db, PREFIX);

    $functionsPath = DLEPlugins::Check(ENGINE_DIR . '/modules/functions.php');
    if (!file_exists($functionsPath)) {
        throw new RuntimeException('Не найден файл функций DLE: ' . $functionsPath);
    }
    include_once $functionsPath;

    $uploadCandidates = array_filter(array_unique([
        DLEPlugins::Check(ENGINE_DIR . '/classes/upload.class.php'),
        ENGINE_DIR . '/classes/uploads/upload.class.php',
    ]));

    $uploadClassPath = null;
    foreach ($uploadCandidates as $candidate) {
        if (file_exists($candidate)) {
            $uploadClassPath = $candidate;
            break;
        }
    }

    if ($uploadClassPath === null) {
        throw new RuntimeException('Не найден файл upload.class.php: ' . implode(', ', $uploadCandidates));
    }

    require_once $uploadClassPath;

    $parseClassPath = DLEPlugins::Check(ENGINE_DIR . '/classes/parse.class.php');
    if (!file_exists($parseClassPath)) {
        throw new RuntimeException('Не найден файл parse.class.php: ' . $parseClassPath);
    }
    require_once $parseClassPath;

    $thumbCandidates = array_filter(array_unique([
        DLEPlugins::Check(ENGINE_DIR . '/classes/thumb.class.php'),
        ENGINE_DIR . '/classes/thumb.class.php',
    ]));

    $thumbClassPath = null;
    foreach ($thumbCandidates as $candidate) {
        if (file_exists($candidate)) {
            $thumbClassPath = $candidate;
            break;
        }
    }

    if ($thumbClassPath === null) {
        throw new RuntimeException('Не найден файл thumb.class.php: ' . implode(', ', $thumbCandidates));
    }

    require_once $thumbClassPath;

    if (!class_exists('\\Intervention\\Image\\ImageManagerStatic')) {
        $interventionCandidates = array_filter(array_unique([
            DLEPlugins::Check(ENGINE_DIR . '/classes/composer/vendor/autoload.php'),
            ENGINE_DIR . '/classes/composer/vendor/autoload.php',
            ENGINE_DIR . '/classes/intervention/vendor/autoload.php',
            ENGINE_DIR . '/classes/intervention/autoload.php',
            ENGINE_DIR . '/classes/intervention/ImageManagerStatic.php',
        ]));

        $interventionLoaded = false;
        foreach ($interventionCandidates as $candidate) {
            if (!file_exists($candidate)) {
                continue;
            }

            require_once $candidate;

            if (class_exists('\\Intervention\\Image\\ImageManagerStatic')) {
                $interventionLoaded = true;
                break;
            }
        }

        if (!$interventionLoaded) {
            throw new RuntimeException('Не найдена библиотека Intervention Image: ' . implode(', ', $interventionCandidates));
        }
    }

    $statusToClaim = !empty($settings['rewrite_enabled']) ? 'rewritten' : 'ready';
    $items = $queue->claimBatch($statusToClaim, 1);
    if (empty($items)) {
        $message = 'Очередь пуста — опубликованных материалов нет.';
        if ($statusToClaim === 'rewritten') {
            $stats = $queue->getStats();
            $readyCount = isset($stats['ready']) ? (int)$stats['ready'] : 0;
            if ($readyCount > 0) {
                $message = 'Очередь публикации пуста. ' . $readyCount . ' материал(ов) ждут этап рерайта (?do=gov_parser_rewrite).';
            }
        }

        $reports[] = [
            'source_id' => null,
            'status' => 'empty',
            'message' => $message,
        ];
    }

    foreach ($items as $item) {
        $startedAt = microtime(true);

        try {
            $meta = [];
            if (!empty($item['meta'])) {
                $decodedMeta = json_decode($item['meta'], true);
                if (is_array($decodedMeta)) {
                    $meta = $decodedMeta;
                }
            }

            $resolvedPayload = gov_parser_resolve_publish_payload($item, $meta);
            $rewrite = $resolvedPayload['payload'];
            if (!is_array($rewrite)) {
                throw new RuntimeException('payload_rewrite missing');
            }

            $usedPreparedPayload = ($resolvedPayload['source'] === 'prepared');

            $baseCategoryId = (int)($settings['target_category'] ?? 1);
            if ($baseCategoryId <= 0) {
                $baseCategoryId = 1;
            }

            $categoryIds = [];
            $subcategoryId = null;
            $telegramSource = trim((string)($meta['telegram_source'] ?? ''));
            if ($telegramSource !== '') {
                $subcategoryId = $categoryManager->ensureSubcategory($baseCategoryId, $telegramSource);
                if ($subcategoryId) {
                    $categoryIds[] = (int)$subcategoryId;
                }
            }

            if (!$categoryIds) {
                $categoryIds[] = $baseCategoryId;
            }

            $categoryIds = array_map('intval', $categoryIds);
            $categoryIds = array_values(array_unique(array_filter($categoryIds)));
            $categoryValue = $categoryIds ? implode(',', $categoryIds) : (string)$baseCategoryId;

            $titleValue = '';
            $shortValue = '';
            $fullValue = '';
            $metaTitleValue = '';
            $metaDescriptionValue = '';

            if (is_array($rewrite)) {
                $tags = is_array($rewrite['tags'] ?? null) ? $rewrite['tags'] : [];

                $titleValue = (string)($rewrite['title']['rerite'] ?? $rewrite['title']['rewrite'] ?? $rewrite['title']['original'] ?? ($tags['title-rerite'] ?? $tags['title'] ?? ''));
                $shortValue = (string)($rewrite['short_story']['rerite'] ?? $rewrite['short_story']['rewrite'] ?? $rewrite['short_story']['original'] ?? ($tags['short-story-rerite'] ?? $tags['short-story'] ?? ''));
                $fullValue = (string)($rewrite['body']['rerite'] ?? $rewrite['body']['rewrite'] ?? $rewrite['body']['original'] ?? ($tags['full-story-rerite'] ?? $tags['full-story'] ?? ''));

                $metaData = is_array($rewrite['meta'] ?? null) ? $rewrite['meta'] : [];
                $metaTitleValue = (string)($metaData['title'] ?? '');
                $metaDescriptionValue = (string)($metaData['description'] ?? '');
            }

            if ($metaTitleValue === '') {
                $metaTitleValue = $titleValue;
            }
            if ($metaDescriptionValue === '') {
                $plainShort = $shortValue !== '' ? strip_tags($shortValue) : strip_tags($fullValue);
                if ($plainShort === '') {
                    $plainShort = $titleValue;
                }
                $metaDescriptionValue = $plainShort;
            }

            $data = [
                'title' => $titleValue,
                'short_story' => $shortValue,
                'full_story' => $fullValue,
                'source_id' => $item['source_id'],
                'category' => $categoryValue,
                'meta_title' => $metaTitleValue,
                'meta_description' => $metaDescriptionValue,
            ];

            $xfields = ['source' => 'gov.kz'];
            $postLink = '';
            if (!empty($meta['url']) && filter_var($meta['url'], FILTER_VALIDATE_URL)) {
                $postLink = (string)$meta['url'];
            } elseif (is_array($rewrite) && !empty($rewrite['source']['url']) && filter_var($rewrite['source']['url'], FILTER_VALIDATE_URL)) {
                $postLink = (string)$rewrite['source']['url'];
            }

            if ($postLink !== '') {
                $xfields['post_link'] = $postLink;
            }

            $data['xfields'] = $xfields;

            if ($metaTitleValue !== '') {
                $meta['meta_title'] = $metaTitleValue;
            }
            if ($metaDescriptionValue !== '') {
                $meta['meta_description'] = $metaDescriptionValue;
            }

            $mediaAssets = [];
            if (!empty($meta['media']) && is_array($meta['media'])) {
                foreach ($meta['media'] as $asset) {
                    if (!is_array($asset)) {
                        continue;
                    }
                    $ref = trim((string)($asset['ref'] ?? ''));
                    if ($ref === '') {
                        continue;
                    }
                    $mediaAssets[] = [
                        'ref' => $ref,
                        'alt' => trim((string)($asset['alt'] ?? '')),
                        'filename' => trim((string)($asset['filename'] ?? '')),
                    ];
                }
            }

            $mediaSummary = gov_parser_apply_media($mediaAssets, $settings, $data, $meta);
            if (!empty($mediaSummary['errors'])) {
                $logger->log('warning', 'publish', (int)$item['source_id'], 'Ошибки при загрузке фото', [
                    'errors' => $mediaSummary['errors'],
                ]);
            }

            if ($mediaSummary['attempted'] > 0) {
                $meta['media_downloaded'] = $mediaSummary['downloaded'];
                $meta['media_targets'] = [
                    'main' => $mediaSummary['main_target'],
                    'gallery' => $mediaSummary['gallery_target'],
                ];
                if (!empty($mediaSummary['saved'])) {
                    $meta['media_saved'] = $mediaSummary['saved'];
                }
                if (!empty($mediaSummary['errors'])) {
                    $meta['media_errors'] = $mediaSummary['errors'];
                }
            }

            $lengths = [
                'title' => GovParser_PayloadHelper::stringLength($data['title']),
                'short_story' => GovParser_PayloadHelper::stringLength(strip_tags($data['short_story'])),
                'full_story' => GovParser_PayloadHelper::stringLength(strip_tags($data['full_story'])),
                'media' => $mediaSummary['downloaded'],
            ];

            $publishInfo = gov_parser_publish_post($data, $settings);

            $checks = $publishInfo['checks'] ?? [];
            $checks['rewrite_payload'] = $resolvedPayload['source'] === 'rewrite';
            if ($usedPreparedPayload) {
                $checks['prepared_payload'] = true;
                $meta['publish_source'] = 'prepared';
            } else {
                $meta['publish_source'] = 'rewrite';
            }
            if ($mediaSummary['attempted'] > 0) {
                $checks['media_saved'] = $mediaSummary['downloaded'] > 0;
                $checks['media_errors'] = empty($mediaSummary['errors']);
            }
            $publishInfo['checks'] = $checks;

            $durationMs = (int)round((microtime(true) - $startedAt) * 1000);

            if ($publishInfo['status'] === 'published') {
                $meta['message'] = 'Новость опубликована';
                $meta['post_id'] = $publishInfo['post_id'];
                $meta['category_ids'] = $categoryValue;
                if ($subcategoryId) {
                    $meta['subcategory_id'] = (int)$subcategoryId;
                }
                if (!empty($publishInfo['url'])) {
                    $meta['published_url'] = $publishInfo['url'];
                }
                if (!empty($publishInfo['slug'])) {
                    $meta['slug'] = $publishInfo['slug'];
                }

                $metrics = [
                    'publish' => [
                        'duration_ms' => $publishInfo['duration_ms'] ?? $durationMs,
                    ],
                ];

                $queue->updateStatus((int)$item['id'], 'published', [
                    'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                    'published_url' => $publishInfo['url'] ?? null,
                    'metrics' => json_encode($metrics, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                ]);

                $logger->log('info', 'publish', (int)$item['source_id'], 'Новость опубликована', array_filter([
                    'post_id' => $publishInfo['post_id'],
                    'categories' => $categoryValue,
                    'subcategory_id' => $subcategoryId,
                    'telegram_source' => $telegramSource !== '' ? $telegramSource : null,
                    'media_saved' => $mediaSummary['downloaded'],
                ], static function ($value) {
                    return $value !== null && $value !== '';
                }));
            } else {
                $meta['message'] = $publishInfo['message'] ?? 'Публикация пропущена';
                $meta['publish_status'] = $publishInfo['status'];
                $queue->updateStatus((int)$item['id'], 'error', [
                    'meta' => json_encode($meta, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
                ]);

                $logger->log('warning', 'publish', (int)$item['source_id'], $meta['message']);
            }

            $statusMessageParts = [];
            if (!empty($publishInfo['message'])) {
                $statusMessageParts[] = $publishInfo['message'];
            }
            if ($mediaSummary['attempted'] > 0) {
                $statusMessageParts[] = 'фото сохранено: ' . $mediaSummary['downloaded'];
                if (!empty($mediaSummary['errors'])) {
                    $statusMessageParts[] = 'ошибки фото: ' . count($mediaSummary['errors']);
                }
            }
            if ($usedPreparedPayload) {
                $statusMessageParts[] = 'использован текст после очистки (рерайт пропущен)';
            }
            $statusMessage = $statusMessageParts ? implode(' · ', $statusMessageParts) : ($publishInfo['status'] === 'published' ? 'Новость опубликована' : '');

            $reports[] = [
                'source_id' => (int)$item['source_id'],
                'status' => $publishInfo['status'],
                'message' => $statusMessage,
                'url' => $publishInfo['url'] ?? '',
                'lengths' => $lengths,
                'checks' => $checks,
                'duration_ms' => $publishInfo['duration_ms'] ?? $durationMs,
                'media' => [
                    'attempted' => $mediaSummary['attempted'],
                    'downloaded' => $mediaSummary['downloaded'],
                    'errors' => $mediaSummary['errors'],
                    'messages' => $mediaSummary['messages'],
                    'main_target' => $mediaSummary['main_target'],
                    'gallery_target' => $mediaSummary['gallery_target'],
                    'saved' => $mediaSummary['saved'],
                ],
            ];
        } catch (\Throwable $ex) {
            $queue->updateStatus((int)$item['id'], 'error', [
                'meta' => json_encode(['message' => $ex->getMessage()], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES),
            ]);
            $logger->log('error', 'publish', (int)$item['source_id'], $ex->getMessage());

            $reports[] = [
                'source_id' => (int)$item['source_id'],
                'status' => 'error',
                'message' => $ex->getMessage(),
                'url' => '',
                'lengths' => [],
                'checks' => [],
                'duration_ms' => (int)round((microtime(true) - $startedAt) * 1000),
                'media' => [
                    'attempted' => count($mediaAssets),
                    'downloaded' => 0,
                    'errors' => [$ex->getMessage()],
                    'messages' => [],
                    'main_target' => gov_parser_normalize_main_image_target($settings['main_image_target'] ?? 'xfield:picture'),
                    'gallery_target' => gov_parser_normalize_gallery_target($settings['gallery_target'] ?? 'full_story_append'),
                    'saved' => [],
                ],
            ];
        }
    }

    if (!empty($items) && $logger instanceof GovParser_Logger) {
        $logger->log('info', 'publish', null, 'Published batch', ['count' => count($items)]);
    }
} catch (\Throwable $e) {
    $globalErrors[] = 'Ошибка публикации: ' . $e->getMessage();
    if ($logger instanceof GovParser_Logger) {
        $logger->log('error', 'publish', null, $e->getMessage());
    }
}

$govParserShutdownRendered = true;
gov_parser_render_publish_page($globalErrors, $reports);

function gov_parser_render_publish_page(array $globalErrors, array $reports): void
{
    echo '<!DOCTYPE html><html lang="ru"><head><meta charset="utf-8"><title>gov_parser — публикация</title>';
    echo '<style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f6f8; color:#1f2d3d; }
    h1 { font-size: 22px; margin-bottom: 15px; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.04); }
    th, td { border:1px solid #dbe2ea; padding:12px; text-align:left; font-size:13px; vertical-align:top; }
    th { background:#eef3fb; text-transform:uppercase; letter-spacing:0.03em; font-weight:600; }
    .status-ok { color:#1c7c54; font-weight:600; }
    .status-error { color:#c62828; font-weight:600; }
    .status-warning { color:#f57c00; font-weight:600; }
    .status-empty { color:#5f6b7d; font-weight:600; }
    .gov-error { background:#ffecec; border:1px solid #ffcdd2; color:#b71c1c; padding:12px 15px; border-radius:10px; margin-bottom:15px; }
    .gov-empty { background:#fff; border-radius:12px; padding:40px; text-align:center; color:#5f6b7d; box-shadow:0 4px 12px rgba(0,0,0,0.04); }
    .gov-summary { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin-bottom:20px; }
    .gov-card { background:#fff; border-radius:12px; padding:16px 18px; box-shadow:0 4px 12px rgba(0,0,0,0.04); border-left:4px solid #e0e6ef; }
    .gov-card.success { border-left-color:#1c7c54; }
    .gov-card.warning { border-left-color:#f57c00; }
    .gov-card.danger { border-left-color:#c62828; }
    .gov-card.muted { border-left-color:#5f6b7d; }
    .gov-card-title { font-size:12px; text-transform:uppercase; letter-spacing:0.04em; color:#5f6b7d; margin-bottom:6px; }
    .gov-card-value { font-size:24px; font-weight:700; color:#1f2d3d; }
    .gov-card-meta { margin-top:8px; font-size:12px; color:#5f6b7d; line-height:1.5; }
</style></head><body>';

    echo '<h1>Этап публикации (gov_parser)</h1>';

    foreach ($globalErrors as $error) {
        echo '<div class="gov-error">' . htmlspecialchars($error, ENT_QUOTES, 'UTF-8') . '</div>';
    }

    $summary = gov_parser_build_publish_summary($reports);
    if (!empty($summary['has_data'])) {
        gov_parser_render_publish_summary($summary);
    }

    if (!$reports) {
        echo '<div class="gov-empty">Данных для отображения нет.</div>';
        echo '</body></html>';
        return;
    }

    $hasTable = false;
    foreach ($reports as $report) {
        if ($report['status'] === 'empty') {
            echo '<div class="gov-empty">' . htmlspecialchars($report['message'], ENT_QUOTES, 'UTF-8') . '</div>';
        } else {
            $hasTable = true;
        }
    }

    if ($hasTable) {
        echo '<table><thead><tr><th>Источник</th><th>URL публикации</th><th>Использованные поля (длины)</th><th>Фото</th><th>Проверки</th><th>Время</th><th>Статус</th></tr></thead><tbody>';
        foreach ($reports as $report) {
            if ($report['status'] === 'empty') {
                continue;
            }

            $status = $report['status'];
            $statusClass = 'status-ok';
            if ($status === 'error') {
                $statusClass = 'status-error';
            } elseif ($status !== 'published') {
                $statusClass = 'status-warning';
            }

            $lengthParts = [];
            foreach ($report['lengths'] as $key => $value) {
                $lengthParts[] = htmlspecialchars((string)$key, ENT_QUOTES, 'UTF-8') . ': ' . (int)$value;
            }
            $lengthsText = $lengthParts ? implode('<br>', $lengthParts) : '—';

            $checkParts = [];
            foreach ($report['checks'] as $key => $value) {
                $checkParts[] = htmlspecialchars((string)$key, ENT_QUOTES, 'UTF-8') . ': ' . ($value ? 'ok' : 'fail');
            }
            $checksText = $checkParts ? implode('<br>', $checkParts) : '—';

            $mediaHtml = '—';
            if (!empty($report['media']) && is_array($report['media'])) {
                $media = $report['media'];
                $mediaParts = [];
                if (!empty($media['attempted'])) {
                    $mediaParts[] = 'источников: ' . (int)$media['attempted'];
                }
                if (isset($media['downloaded'])) {
                    $mediaParts[] = 'сохранено: ' . (int)$media['downloaded'];
                }
                if (!empty($media['main_target'])) {
                    $mediaParts[] = 'главное: ' . htmlspecialchars(gov_parser_humanize_image_target($media['main_target']), ENT_QUOTES, 'UTF-8');
                }
                if (!empty($media['gallery_target'])) {
                    $mediaParts[] = 'галерея: ' . htmlspecialchars(gov_parser_humanize_image_target($media['gallery_target']), ENT_QUOTES, 'UTF-8');
                }
                if (!empty($media['saved']['main'])) {
                    $mediaParts[] = 'обложка → ' . htmlspecialchars($media['saved']['main'], ENT_QUOTES, 'UTF-8');
                }
                if (!empty($media['saved']['gallery']) && is_array($media['saved']['gallery'])) {
                    $mediaParts[] = 'галерея файлов: ' . count($media['saved']['gallery']);
                }
                if (!empty($media['errors'])) {
                    $errorLines = array_map(static function ($msg) {
                        return htmlspecialchars((string)$msg, ENT_QUOTES, 'UTF-8');
                    }, $media['errors']);
                    $mediaParts[] = '<span class="status-warning">Ошибки:</span><br>' . implode('<br>', $errorLines);
                }
                if (!empty($media['messages'])) {
                    $messageLines = array_map(static function ($msg) {
                        return htmlspecialchars((string)$msg, ENT_QUOTES, 'UTF-8');
                    }, $media['messages']);
                    $mediaParts[] = implode('<br>', $messageLines);
                }

                if ($mediaParts) {
                    $mediaHtml = implode('<br>', $mediaParts);
                }
            }

            $url = $report['url']
                ? '<a href="' . htmlspecialchars($report['url'], ENT_QUOTES, 'UTF-8') . '" target="_blank" rel="noopener">' . htmlspecialchars($report['url'], ENT_QUOTES, 'UTF-8') . '</a>'
                : '—';

            echo '<tr>';
            echo '<td>' . htmlspecialchars('Источник #' . $report['source_id'], ENT_QUOTES, 'UTF-8') . '</td>';
            echo '<td>' . $url . '</td>';
            echo '<td>' . $lengthsText . '</td>';
            echo '<td>' . $mediaHtml . '</td>';
            echo '<td>' . $checksText . '</td>';
            echo '<td>' . ((int)$report['duration_ms']) . ' мс</td>';
            echo '<td class="' . $statusClass . '">' . htmlspecialchars($status, ENT_QUOTES, 'UTF-8');
            if (!empty($report['message'])) {
                echo '<br><span style="font-weight:400; color:#51606f;">' . htmlspecialchars($report['message'], ENT_QUOTES, 'UTF-8') . '</span>';
            }
            echo '</td>';
            echo '</tr>';
        }
        echo '</tbody></table>';
    }

    echo '</body></html>';
}

function gov_parser_build_publish_summary(array $reports): array
{
    $attempted = 0;
    $published = 0;
    $errors = 0;
    $skipped = 0;
    $skipDetails = [];
    $durations = [];

    foreach ($reports as $report) {
        $status = isset($report['status']) ? (string)$report['status'] : '';
        if ($status === 'empty') {
            continue;
        }

        $attempted++;

        if (isset($report['duration_ms'])) {
            $duration = (int)$report['duration_ms'];
            if ($duration >= 0) {
                $durations[] = $duration;
            }
        }

        if ($status === 'published') {
            $published++;
        } elseif ($status === 'error') {
            $errors++;
        } else {
            $skipped++;
            if ($status !== '') {
                $skipDetails[$status] = ($skipDetails[$status] ?? 0) + 1;
            }
        }
    }

    $average = null;
    $maximum = null;
    if ($durations) {
        $average = (int)round(array_sum($durations) / count($durations));
        $maximum = max($durations);
    }

    return [
        'attempted' => $attempted,
        'published' => $published,
        'skipped' => $skipped,
        'errors' => $errors,
        'average_duration' => $average,
        'max_duration' => $maximum,
        'skip_details' => $skipDetails,
        'has_data' => $attempted > 0,
    ];
}

function gov_parser_render_publish_summary(array $summary): void
{
    $skipDetailsText = '—';
    if (!empty($summary['skip_details'])) {
        $parts = [];
        foreach ($summary['skip_details'] as $status => $count) {
            $parts[] = htmlspecialchars((string)$status, ENT_QUOTES, 'UTF-8') . ': ' . (int)$count;
        }
        $skipDetailsText = implode(' · ', $parts);
    }

    $averageText = $summary['average_duration'] !== null ? ((int)$summary['average_duration']) . ' мс' : '—';
    $maxText = $summary['max_duration'] !== null ? ((int)$summary['max_duration']) . ' мс' : '—';

    echo '<div class="gov-summary">';
    echo '<div class="gov-card muted"><div class="gov-card-title">К публикации</div><div class="gov-card-value">' . (int)$summary['attempted'] . '</div></div>';
    echo '<div class="gov-card success"><div class="gov-card-title">Опубликовано</div><div class="gov-card-value">' . (int)$summary['published'] . '</div></div>';
    echo '<div class="gov-card warning"><div class="gov-card-title">Пропущено</div><div class="gov-card-value">' . (int)$summary['skipped'] . '</div><div class="gov-card-meta">' . $skipDetailsText . '</div></div>';
    echo '<div class="gov-card danger"><div class="gov-card-title">Ошибки</div><div class="gov-card-value">' . (int)$summary['errors'] . '</div></div>';
    echo '<div class="gov-card muted"><div class="gov-card-title">Среднее / максимум</div><div class="gov-card-value">' . htmlspecialchars($averageText, ENT_QUOTES, 'UTF-8') . '</div><div class="gov-card-meta">Пик: ' . htmlspecialchars($maxText, ENT_QUOTES, 'UTF-8') . '</div></div>';
    echo '</div>';
}

function gov_parser_resolve_publish_payload(array $item, array $meta): array
{
    $rawRewrite = $item['payload_rewrite'] ?? '';
    if (is_string($rawRewrite) && $rawRewrite !== '') {
        $decoded = json_decode($rawRewrite, true);
        if (is_array($decoded)) {
            return ['payload' => $decoded, 'source' => 'rewrite'];
        }
    }

    if (!empty($meta['rewrite_payload']) && is_array($meta['rewrite_payload'])) {
        $prepared = $meta['rewrite_payload'];
        $title = (string)($prepared['title'] ?? '');
        $short = (string)($prepared['short'] ?? '');
        $body = (string)($prepared['body'] ?? '');

        if ($title === '' && $short === '' && $body === '') {
            return ['payload' => null, 'source' => 'missing'];
        }

        $tags = [
            'title' => $title,
            'short-story' => $short,
            'full-story' => $body,
            'title-rerite' => $title,
            'short-story-rerite' => $short,
            'full-story-rerite' => $body,
        ];

        if (!empty($meta['summary'])) {
            $tags['summary'] = (string)$meta['summary'];
        }

        if (!empty($meta['key_facts']) && is_array($meta['key_facts'])) {
            $facts = array_filter(array_map(static function ($fact) {
                return trim((string)$fact);
            }, $meta['key_facts']));
            if ($facts) {
                $tags['facts'] = implode('; ', $facts);
            }
        }

        return [
            'payload' => [
                'title' => [
                    'original' => $title,
                    'rerite' => $title,
                ],
                'short_story' => [
                    'original' => $short,
                    'rerite' => $short,
                ],
                'body' => [
                    'original' => $body,
                    'rerite' => $body,
                ],
                'tags' => $tags,
            ],
            'source' => 'prepared',
        ];
    }

    return ['payload' => null, 'source' => 'missing'];
}

function gov_parser_publish_post(array $data, array $settings): array
{
    global $db, $config, $member_id;

    if (empty($data['title']) || empty($data['full_story'])) {
        throw new RuntimeException('Empty content');
    }

    $startedAt = microtime(true);

    $metaTitle = trim(strip_tags((string)($data['meta_title'] ?? '')));
    $metaDescription = trim(strip_tags((string)($data['meta_description'] ?? '')));
    $metaKeywords = trim(strip_tags((string)($data['meta_keywords'] ?? '')));

    $db_title = $db->safesql($data['title']);
    $existing = $db->super_query("SELECT id FROM " . PREFIX . "_post WHERE title='{$db_title}' LIMIT 1");
    if (!empty($existing)) {
        return [
            'status' => 'duplicate',
            'message' => 'Новость с таким заголовком уже опубликована',
            'checks' => ['unique_title' => false],
            'duration_ms' => (int)round((microtime(true) - $startedAt) * 1000),
        ];
    }

    $db_short = $db->safesql($data['short_story']);
    $db_full = $db->safesql($data['full_story']);
    $slugSource = $metaTitle !== '' ? $metaTitle : $data['title'];
    $altName = gov_parser_generate_unique_slug($slugSource);
    $db_alt_name = $db->safesql($altName);
    $db_metatitle = $db->safesql($metaTitle);
    $db_metadescr = $db->safesql($metaDescription);
    $db_metakeywords = $db->safesql($metaKeywords);
    $categoryValue = isset($data['category']) ? (string)$data['category'] : '';
    $categoryValue = preg_replace('/[^0-9,]+/', '', $categoryValue);
    if ($categoryValue === '') {
        $categoryValue = '1';
    }
    $categoryIdsForExtras = array_filter(array_unique(array_map('intval', explode(',', $categoryValue))));
    if (empty($categoryIdsForExtras)) {
        $categoryIdsForExtras = [1];
    }
    $categoryValue = implode(',', $categoryIdsForExtras);
    $db_category = $db->safesql($categoryValue);
    $now = time();

    $db->query("INSERT INTO " . PREFIX . "_post (date, title, category, short_story, full_story, alt_name, descr, keywords, metatitle, autor, approve, allow_comm, allow_main, fixed) VALUES (FROM_UNIXTIME($now), '$db_title', '$db_category', '$db_short', '$db_full', '$db_alt_name', '$db_metadescr', '$db_metakeywords', '$db_metatitle', 'gov_parser', 1, 1, 1, 0)");
    $postId = $db->insert_id();

    $db->query("INSERT INTO " . PREFIX . "_post_extras (news_id, allow_rate) VALUES ($postId, 1)");

    if (!empty($categoryIdsForExtras)) {
        $values = [];
        foreach ($categoryIdsForExtras as $catId) {
            $catId = (int)$catId;
            if ($catId <= 0) {
                continue;
            }
            $values[] = '(' . $postId . ', ' . $catId . ')';
        }

        if ($values) {
            $db->query("INSERT INTO " . PREFIX . "_post_extras_cats (news_id, cat_id) VALUES " . implode(', ', $values));
        }
    }

    if (!empty($data['xfields']) && is_array($data['xfields'])) {
        $xfieldsValue = gov_parser_format_xfields($data['xfields']);
        if ($xfieldsValue !== '') {
            $db->query("UPDATE " . PREFIX . "_post SET xfields='" . $db->safesql($xfieldsValue) . "' WHERE id=$postId");
        }
    }

    if (function_exists('clear_cache')) {
        $cachePrefixes = [
            'news_',
            'full_',
            'cat_',
            'archives_',
            'calendar_',
            'topnews_',
            'related_',
            'rss',
            'tagscloud_',
            'dletags',
        ];

        foreach ($cachePrefixes as $prefix) {
            clear_cache($prefix);
        }
    }

    $durationMs = (int)round((microtime(true) - $startedAt) * 1000);
    $baseUrl = rtrim($config['http_home_url'] ?? '', '/');
    $url = $baseUrl ? $baseUrl . '/index.php?newsid=' . $postId : '';

    return [
        'status' => 'published',
        'message' => 'Новость опубликована',
        'post_id' => $postId,
        'url' => $url,
        'slug' => $altName,
        'checks' => ['unique_title' => true],
        'duration_ms' => $durationMs,
    ];
}

function gov_parser_apply_media(array $assets, array $settings, array &$data, array &$meta): array
{
    $result = [
        'attempted' => count($assets),
        'downloaded' => 0,
        'errors' => [],
        'messages' => [],
        'main_target' => gov_parser_normalize_main_image_target($settings['main_image_target'] ?? 'xfield:picture'),
        'gallery_target' => gov_parser_normalize_gallery_target($settings['gallery_target'] ?? 'full_story_append'),
        'saved' => [],
    ];

    if (!$assets) {
        return $result;
    }

    $slugSource = '';
    if (!empty($data['meta_title'])) {
        $slugSource = (string)$data['meta_title'];
    } elseif (!empty($data['title'])) {
        $slugSource = (string)$data['title'];
    }
    $download = gov_parser_download_media_assets($assets, $slugSource);
    $files = $download['files'];
    $result['errors'] = $download['errors'];
    $result['downloaded'] = count($files);

    if (!$files) {
        if ($download['errors']) {
            $result['messages'][] = 'Не удалось сохранить изображения.';
        }
        return $result;
    }

    $result['saved']['files'] = array_map(static function ($file) {
        return $file['relative'];
    }, $files);

    foreach ($files as $file) {
        $data['full_story'] = gov_parser_replace_media_urls($data['full_story'], $file);
        $data['short_story'] = gov_parser_replace_media_urls($data['short_story'], $file);
    }

    $xfields = [];
    if (!empty($data['xfields']) && is_array($data['xfields'])) {
        $xfields = $data['xfields'];
    }

    $mainFile = null;
    $galleryFiles = $files;

    if ($result['main_target'] !== 'none' && $galleryFiles) {
        $mainFile = array_shift($galleryFiles);
    } else {
        $mainFile = null;
        $galleryFiles = $files;
    }

    if ($mainFile) {
        if (strpos($result['main_target'], 'xfield:') === 0) {
            $field = substr($result['main_target'], 7);
            if ($field !== '') {
                $xfields[$field] = $mainFile['relative'];
                $result['saved']['main'] = $mainFile['relative'];
            }
        } elseif ($result['main_target'] === 'full_story_prepend') {
            $data['full_story'] = gov_parser_render_image_html($mainFile, 'gov-parser-cover') . $data['full_story'];
            $result['saved']['main'] = $mainFile['relative'];
        } elseif ($result['main_target'] === 'full_story_append') {
            $data['full_story'] .= gov_parser_render_image_html($mainFile, 'gov-parser-cover');
            $result['saved']['main'] = $mainFile['relative'];
        } elseif ($result['main_target'] === 'short_story_prepend') {
            $data['short_story'] = gov_parser_render_image_html($mainFile, 'gov-parser-cover') . $data['short_story'];
            $result['saved']['main'] = $mainFile['relative'];
        } else {
            $galleryFiles = array_merge([$mainFile], $galleryFiles);
        }
    }

    if ($result['gallery_target'] !== 'none' && $galleryFiles) {
        if (strpos($result['gallery_target'], 'xfield:') === 0) {
            $field = substr($result['gallery_target'], 7);
            if ($field !== '') {
                $xfields[$field] = implode("\n", array_map(static function ($file) {
                    return $file['relative'];
                }, $galleryFiles));
                $result['saved']['gallery'] = array_map(static function ($file) {
                    return $file['relative'];
                }, $galleryFiles);
            }
        } elseif ($result['gallery_target'] === 'full_story_append') {
            $htmlParts = [];
            foreach ($galleryFiles as $file) {
                $htmlParts[] = gov_parser_render_image_html($file, 'gov-parser-gallery-photo');
            }
            $data['full_story'] .= '<div class="gov-parser-gallery">' . implode('', $htmlParts) . '</div>';
            $result['saved']['gallery'] = array_map(static function ($file) {
                return $file['relative'];
            }, $galleryFiles);
        }
    }

    if ($xfields) {
        $data['xfields'] = $xfields;
    }

    return $result;
}

function gov_parser_download_media_assets(array $assets, string $slugBase = ''): array
{
    $errors = [];
    $files = [];
    $limit = 10;
    $subset = array_slice($assets, 0, $limit);

    if (!$subset) {
        return ['files' => [], 'errors' => []];
    }

    $http = new GovParser_HttpClient();
    $folder = date('Y-m');
    $baseDir = ROOT_DIR . '/uploads/posts/' . $folder;
    $directories = [
        $baseDir,
        $baseDir . '/thumbs',
        $baseDir . '/medium',
    ];

    foreach ($directories as $dir) {
        if (!is_dir($dir)) {
            @mkdir($dir, 0775, true);
        }
        @chmod($dir, 0775);
    }

    $normalizedSlugBase = gov_parser_slugify_filename($slugBase);
    if ($normalizedSlugBase === '') {
        $normalizedSlugBase = 'image';
    }

    $counter = 0;

    foreach ($subset as $asset) {
        $originalUrl = isset($asset['ref']) ? trim((string)$asset['ref']) : '';
        if ($originalUrl === '') {
            $errors[] = 'Пустой адрес изображения';
            continue;
        }

        $url = gov_parser_normalize_media_url($originalUrl);
        if ($url === null) {
            $errors[] = 'Некорректный адрес изображения: ' . $originalUrl;
            continue;
        }

        [$status, $body, $err] = $http->get($url, 20);
        if ($status < 200 || $status >= 300 || !$body) {
            $errorMessage = 'HTTP ' . $status;
            if ($err !== '') {
                $errorMessage .= ' — ' . $err;
            }
            $errors[] = $errorMessage . ' — ' . $originalUrl;
            continue;
        }

        if (strlen($body) > 8 * 1024 * 1024) {
            $errors[] = 'Файл слишком большой: ' . $url;
            continue;
        }

        $info = @getimagesizefromstring($body);
        if (!$info || empty($info['mime'])) {
            $errors[] = 'Неизвестный формат изображения: ' . $url;
            continue;
        }

        $mime = strtolower($info['mime']);
        $map = [
            'image/jpeg' => 'jpg',
            'image/png' => 'png',
            'image/gif' => 'gif',
            'image/webp' => 'webp',
        ];
        $ext = $map[$mime] ?? null;
        if ($ext === null) {
            $errors[] = 'Неподдерживаемый MIME-тип: ' . $mime;
            continue;
        }

        $counter++;
        $baseName = $asset['filename'] !== '' ? $asset['filename'] : $normalizedSlugBase . '-' . $counter;
        $slug = gov_parser_slugify_filename($baseName);
        if ($slug === '') {
            $slug = $normalizedSlugBase . '-' . $counter;
        }
        $name = $slug . '.webp';
        $path = $baseDir . '/' . $name;

        $saveResult = gov_parser_save_webp_from_string($body, $path, 1000, 70);
        if (empty($saveResult['success'])) {
            $errorText = !empty($saveResult['error']) ? (string)$saveResult['error'] : 'Неизвестная ошибка';
            $errors[] = 'Не удалось обработать изображение: ' . $errorText . ' — ' . $originalUrl;
            if (is_file($path)) {
                @unlink($path);
            }
            continue;
        }

        @chmod($path, 0664);

        $relative = $folder . '/' . $name;
        $thumbRelative = null;

        if (class_exists('thumbnail')) {
            try {
                $thumb = new thumbnail($path);
                $thumb->format = 'webp';
                $thumb->quality = 70;
                $thumb->size_auto('326x200');
                $thumbPath = 'posts/' . $folder . '/thumbs/' . $name;
                $thumb->save($thumbPath);
                if (is_file(ROOT_DIR . '/uploads/' . $thumbPath)) {
                    $thumbRelative = $folder . '/thumbs/' . $name;
                }
            } catch (\Throwable $thumbError) {
                $errors[] = 'Не удалось создать превью: ' . $thumbError->getMessage();
            }
        }

        $fileEntry = [
            'relative' => $relative,
            'url' => gov_parser_build_media_url('uploads/posts/' . $relative),
            'alt' => $asset['alt'] !== '' ? $asset['alt'] : $slug,
            'original' => $originalUrl,
            'resolved' => $url,
        ];

        if ($thumbRelative !== null) {
            $fileEntry['thumb_relative'] = $thumbRelative;
            $fileEntry['thumb_url'] = gov_parser_build_media_url('uploads/posts/' . $thumbRelative);
        }

        $files[] = $fileEntry;
    }

    return ['files' => $files, 'errors' => $errors];
}

function gov_parser_save_webp_from_string(string $body, string $path, int $maxSize, int $quality): array
{
    if (!function_exists('imagecreatefromstring') || !function_exists('imagewebp')) {
        return ['success' => false, 'error' => 'Поддержка WebP в GD недоступна'];
    }

    $image = @imagecreatefromstring($body);
    if (!$image) {
        return ['success' => false, 'error' => 'Не удалось прочитать изображение'];
    }

    $width = imagesx($image);
    $height = imagesy($image);
    if ($width <= 0 || $height <= 0) {
        imagedestroy($image);
        return ['success' => false, 'error' => 'Некорректные размеры изображения'];
    }

    if (function_exists('imagepalettetotruecolor')) {
        if (!function_exists('imageistruecolor') || !imageistruecolor($image)) {
            @imagepalettetotruecolor($image);
        }
    }

    if (function_exists('imagealphablending')) {
        @imagealphablending($image, false);
    }
    if (function_exists('imagesavealpha')) {
        @imagesavealpha($image, true);
    }

    if ($maxSize > 0 && ($width > $maxSize || $height > $maxSize)) {
        $ratio = min($maxSize / $width, $maxSize / $height);
        $newWidth = max(1, (int)round($width * $ratio));
        $newHeight = max(1, (int)round($height * $ratio));

        $resized = imagecreatetruecolor($newWidth, $newHeight);
        if (!$resized) {
            imagedestroy($image);
            return ['success' => false, 'error' => 'Не удалось подготовить холст для ресайза'];
        }

        if (function_exists('imagealphablending')) {
            @imagealphablending($resized, false);
        }
        if (function_exists('imagesavealpha')) {
            @imagesavealpha($resized, true);
        }
        $transparent = imagecolorallocatealpha($resized, 0, 0, 0, 127);
        if ($transparent !== false) {
            imagefill($resized, 0, 0, $transparent);
        }

        if (!imagecopyresampled($resized, $image, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height)) {
            imagedestroy($resized);
            imagedestroy($image);
            return ['success' => false, 'error' => 'Не удалось изменить размер изображения'];
        }

        imagedestroy($image);
        $image = $resized;
        $width = $newWidth;
        $height = $newHeight;
    }

    $quality = max(0, min(100, (int)$quality));
    $saved = imagewebp($image, $path, $quality);
    imagedestroy($image);

    if (!$saved) {
        return ['success' => false, 'error' => 'Не удалось сохранить файл WebP'];
    }

    return ['success' => true, 'width' => $width, 'height' => $height];
}

function gov_parser_replace_media_urls(string $html, array $file): string
{
    if ($html === '') {
        return $html;
    }

    $localPath = '/uploads/posts/' . ltrim($file['relative'], '/');
    $candidates = [];

    $collect = static function (string $value) use (&$candidates) {
        if ($value === '') {
            return;
        }

        $candidates[] = $value;
        $decoded = html_entity_decode($value, ENT_QUOTES | (defined('ENT_HTML5') ? ENT_HTML5 : ENT_COMPAT), 'UTF-8');
        if ($decoded !== $value) {
            $candidates[] = $decoded;
        }
        $candidates[] = htmlspecialchars($value, ENT_QUOTES, 'UTF-8');

        $strippedScheme = preg_replace('~^https?://~i', '', $value);
        if (is_string($strippedScheme) && $strippedScheme !== '' && $strippedScheme !== $value) {
            $candidates[] = $strippedScheme;
            $candidates[] = htmlspecialchars($strippedScheme, ENT_QUOTES, 'UTF-8');
        }

        $parsed = @parse_url($value);
        if (is_array($parsed) && !empty($parsed['path'])) {
            $path = $parsed['path'];
            if (!empty($parsed['query'])) {
                $path .= '?' . $parsed['query'];
            }
            $candidates[] = $path;
            $candidates[] = htmlspecialchars($path, ENT_QUOTES, 'UTF-8');
        }
    };

    if (!empty($file['original'])) {
        $collect((string)$file['original']);
    }

    if (!empty($file['resolved'])) {
        $collect((string)$file['resolved']);
    }

    $candidates = array_values(array_unique(array_filter($candidates, static function ($value) {
        return is_string($value) && $value !== '';
    })));

    foreach ($candidates as $search) {
        $html = str_replace($search, $localPath, $html);
    }

    return str_replace('//uploads', '/uploads', $html);
}

function gov_parser_normalize_main_image_target(string $target): string
{
    $target = trim($target);
    if ($target === '') {
        return 'xfield:picture';
    }

    $allowed = ['none', 'full_story_prepend', 'full_story_append', 'short_story_prepend'];
    if (in_array($target, $allowed, true)) {
        return $target;
    }

    if (strpos($target, 'xfield:') === 0) {
        $name = substr($target, 7);
        $name = preg_replace('/[^a-z0-9_-]+/i', '', $name);
        return $name !== '' ? 'xfield:' . $name : 'xfield:picture';
    }

    return 'xfield:picture';
}

function gov_parser_normalize_gallery_target(string $target): string
{
    $target = trim($target);
    if ($target === '') {
        return 'full_story_append';
    }

    $allowed = ['none', 'full_story_append'];
    if (in_array($target, $allowed, true)) {
        return $target;
    }

    if (strpos($target, 'xfield:') === 0) {
        $name = substr($target, 7);
        $name = preg_replace('/[^a-z0-9_-]+/i', '', $name);
        return $name !== '' ? 'xfield:' . $name : 'full_story_append';
    }

    return 'full_story_append';
}

function gov_parser_render_image_html(array $file, string $class): string
{
    $url = htmlspecialchars($file['url'], ENT_QUOTES, 'UTF-8');
    $alt = htmlspecialchars($file['alt'], ENT_QUOTES, 'UTF-8');

    return '<figure class="' . htmlspecialchars($class, ENT_QUOTES, 'UTF-8') . '"><img src="' . $url . '" alt="' . $alt . '" loading="lazy" /></figure>';
}

function gov_parser_normalize_media_url(string $url): ?string
{
    $decoded = html_entity_decode($url, ENT_QUOTES | (defined('ENT_HTML5') ? ENT_HTML5 : ENT_COMPAT), 'UTF-8');
    $decoded = trim($decoded);

    if ($decoded === '') {
        return null;
    }

    if (preg_match('~^https?://~i', $decoded)) {
        return $decoded;
    }

    if (strpos($decoded, '//') === 0) {
        return 'https:' . $decoded;
    }

    if (preg_match('~^[a-z0-9+.-]+:~i', $decoded)) {
        return null;
    }

    if ($decoded[0] !== '/') {
        $decoded = '/' . $decoded;
    }

    return 'https://www.gov.kz' . $decoded;
}

function gov_parser_build_media_url(string $relative): string
{
    global $config;

    $relative = ltrim($relative, '/');
    $base = rtrim($config['http_home_url'] ?? '', '/');

    if ($base === '') {
        return '/' . $relative;
    }

    return $base . '/' . $relative;
}

function gov_parser_slugify_filename(string $name): string
{
    $name = preg_replace('/\.[^.]+$/', '', $name);
    $name = trim($name);
    if ($name === '') {
        $name = 'image';
    }

    if (function_exists('totranslit')) {
        $slug = totranslit($name, true, false);
    } else {
        $slug = $name;
    }

    $slug = preg_replace('/[^a-z0-9_-]+/i', '-', (string)$slug);
    $slug = trim($slug, '-');

    return $slug !== '' ? strtolower($slug) : 'image';
}

function gov_parser_slugify_post(string $value, string $fallback = 'news'): string
{
    $value = strip_tags($value);
    $value = preg_replace('/\s+/u', ' ', $value);
    $value = trim($value);

    if ($value === '') {
        $value = $fallback;
    }

    if (function_exists('totranslit')) {
        $slug = totranslit($value, true, false);
    } else {
        $slug = $value;
    }

    $slug = preg_replace('/[^a-z0-9_-]+/i', '-', (string)$slug);
    $slug = trim($slug, '-');

    if ($slug === '') {
        $slug = $fallback;
    }

    if (function_exists('mb_substr')) {
        $slug = mb_substr($slug, 0, 190);
    } else {
        $slug = substr($slug, 0, 190);
    }

    return strtolower(trim($slug, '-')) ?: $fallback;
}

function gov_parser_generate_unique_slug(string $value, string $fallback = 'news'): string
{
    $base = gov_parser_slugify_post($value, $fallback);
    $slug = $base;
    $counter = 1;
    $maxLength = 190;

    while ($slug !== '' && gov_parser_post_slug_exists($slug)) {
        $counter++;
        if ($counter > 50) {
            $slug = $base . '-' . substr(md5($value . microtime(true)), 0, 6);
            break;
        }
        $suffix = '-' . $counter;
        $baseTrimmed = $base;
        if (strlen($baseTrimmed . $suffix) > $maxLength) {
            $baseTrimmed = substr($baseTrimmed, 0, $maxLength - strlen($suffix));
            $baseTrimmed = rtrim($baseTrimmed, '-');
            if ($baseTrimmed === '') {
                $baseTrimmed = $fallback;
            }
        }
        $slug = $baseTrimmed . $suffix;
    }

    if ($slug === '' || gov_parser_post_slug_exists($slug)) {
        $slug = $fallback . '-' . substr(md5($value . microtime(true)), 0, 6);
    }

    if (strlen($slug) > $maxLength) {
        $slug = substr($slug, 0, $maxLength);
    }

    $slug = strtolower(trim($slug, '-'));

    if ($slug === '') {
        $slug = $fallback . '-' . substr(md5($value . microtime(true)), 0, 6);
    }

    return $slug;
}

function gov_parser_post_slug_exists(string $slug): bool
{
    global $db;

    $slug = trim($slug);
    if ($slug === '') {
        return false;
    }

    $safe = $db->safesql($slug);
    $row = $db->super_query("SELECT id FROM " . PREFIX . "_post WHERE alt_name='{$safe}' LIMIT 1");

    return !empty($row);
}

function gov_parser_format_xfields(array $xfields): string
{
    $parts = [];
    foreach ($xfields as $name => $value) {
        $name = trim((string)$name);
        if ($name === '') {
            continue;
        }
        $parts[] = $name . '|' . gov_parser_escape_xfield_value((string)$value);
    }

    return implode('||', $parts);
}

function gov_parser_escape_xfield_value(string $value): string
{
    $value = str_replace('||', '&#124;&#124;', $value);
    $value = str_replace('|', '&#124;', $value);
    return $value;
}

function gov_parser_humanize_image_target(string $target): string
{
    switch ($target) {
        case 'none':
            return 'не используется';
        case 'full_story_prepend':
            return 'начало текста';
        case 'full_story_append':
            return 'конец текста';
        case 'short_story_prepend':
            return 'начало анонса';
    }

    if (strpos($target, 'xfield:') === 0) {
        return 'доп. поле ' . substr($target, 7);
    }

    return $target;
}
?>
]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
	<file name="engine/modules/gov_parser_run.php">
		<operation action="create">
			<replacecode><![CDATA[<?php
@error_reporting(E_ALL ^ E_NOTICE);
@ini_set('display_errors', false);

if (!defined('DATALIFEENGINE')) {
    define('DATALIFEENGINE', true);
}

if (!defined('ROOT_DIR')) {
    define('ROOT_DIR', dirname(__FILE__, 2));
}

if (!defined('ENGINE_DIR')) {
    define('ENGINE_DIR', ROOT_DIR . '/engine');
}

require_once ENGINE_DIR . '/data/config.php';
require_once ENGINE_DIR . '/classes/mysql.php';
require_once ENGINE_DIR . '/data/dbconfig.php';
require_once ENGINE_DIR . '/classes/plugins.class.php';
include_once DLEPlugins::Check(ENGINE_DIR . '/modules/gov_parser_bootstrap.php');

gov_parser_require_password();

if (function_exists('header_remove')) {
    header_remove();
}
header('Content-Type: application/json; charset=utf-8');

$chains = [
    'full' => [
        'gov_parser_ids',
        'gov_parser_fetch',
        'gov_parser_prepare',
        'gov_parser_rewrite',
        'gov_parser_publish',
    ],
    'prepare_only' => [
        'gov_parser_ids',
        'gov_parser_fetch',
        'gov_parser_prepare',
    ],
    'publish_only' => [
        'gov_parser_rewrite',
        'gov_parser_publish',
    ],
];

$requestedChain = isset($_REQUEST['chain']) ? (string)$_REQUEST['chain'] : 'full';
if (!isset($chains[$requestedChain])) {
    $requestedChain = 'full';
}

$response = [
    'chain' => $requestedChain,
    'status' => 'ok',
    'stages' => [],
];

$httpStatus = 200;
$queue = null;
$logger = null;
$initialStats = [];
$previousStats = [];

try {
    $queue = new GovParser_QueueRepository($db, PREFIX);
    $logger = new GovParser_Logger($db, PREFIX);
    $initialStats = $queue->getStats();
    $previousStats = $initialStats;
    $response['queue'] = [
        'before' => $initialStats,
        'after' => $initialStats,
    ];
} catch (\Throwable $e) {
    $response['status'] = 'error';
    $response['error'] = 'Failed to initialize gov_parser queue or logger.';
    $response['details'] = [
        'exception' => $e->getMessage(),
    ];
    $httpStatus = 500;
}

if (!($queue instanceof GovParser_QueueRepository)) {
    http_response_code($httpStatus);
    if (function_exists('header_remove')) {
        header_remove();
    }
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode($response, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);
    return;
}

if (!isset($response['queue'])) {
    $response['queue'] = [
        'before' => $initialStats,
        'after' => $initialStats,
    ];
}

$originalGetDo = $_GET['do'] ?? null;
$originalRequestDo = $_REQUEST['do'] ?? null;

$stages = $chains[$requestedChain];
foreach ($stages as $stage) {
    $stageStart = microtime(true);
    $stageResult = [
        'stage' => $stage,
        'status' => 'ok',
    ];

    if (function_exists('header_remove')) {
        header_remove();
    }

    $_GET['do'] = $stage;
    $_REQUEST['do'] = $stage;

    $stageOutput = '';
    $stageException = null;

    ob_start();
    try {
        include DLEPlugins::Check(ENGINE_DIR . '/modules/' . $stage . '.php');
        $stageOutput = (string)ob_get_clean();
    } catch (\Throwable $stageError) {
        ob_end_clean();
        $stageException = $stageError;
    }

    $stageResult['duration_ms'] = (int)round((microtime(true) - $stageStart) * 1000);

    if ($stageException !== null) {
        $stageResult['status'] = 'error';
        $stageResult['error'] = $stageException->getMessage();
        $httpStatus = 500;
        $response['status'] = 'error';

        if ($logger instanceof GovParser_Logger) {
            $logger->log('error', 'run', null, $stageException->getMessage(), [
                'stage' => $stage,
            ]);
        }

        $response['stages'][] = $stageResult;
        break;
    }

    try {
        $currentStats = $queue->getStats();
        $stageResult['queue_delta'] = gov_parser_run_calculate_delta($previousStats, $currentStats);
        $previousStats = $currentStats;
        $response['queue']['after'] = $currentStats;
    } catch (\Throwable $statsError) {
        $stageResult['status'] = 'warning';
        $stageResult['error'] = 'Failed to fetch queue stats: ' . $statsError->getMessage();
        if ($response['status'] === 'ok') {
            $response['status'] = 'warning';
        }
    }

    $stageResult['output_excerpt'] = gov_parser_run_truncate_output($stageOutput);

    if ($logger instanceof GovParser_Logger) {
        $context = [
            'stage' => $stage,
            'duration_ms' => $stageResult['duration_ms'],
            'queue_delta' => isset($stageResult['queue_delta']) ? json_encode($stageResult['queue_delta']) : null,
        ];

        if ($stageResult['status'] === 'warning') {
            $logger->log('warning', 'run', null, $stageResult['error'], $context);
        } else {
            $logger->log('info', 'run', null, 'Stage completed', $context);
        }
    }

    $response['stages'][] = $stageResult;
}

if ($originalGetDo !== null) {
    $_GET['do'] = $originalGetDo;
} else {
    unset($_GET['do']);
}

if ($originalRequestDo !== null) {
    $_REQUEST['do'] = $originalRequestDo;
} else {
    unset($_REQUEST['do']);
}

http_response_code($httpStatus);
if (function_exists('header_remove')) {
    header_remove();
}
header('Content-Type: application/json; charset=utf-8');

echo json_encode($response, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);

function gov_parser_run_truncate_output(string $output, int $limit = 400): string
{
    $output = trim($output);
    if ($output === '') {
        return '';
    }

    $stripped = strip_tags($output);
    if ($stripped !== '') {
        $output = $stripped;
    }

    $normalized = preg_replace('/\s+/u', ' ', $output);
    if (is_string($normalized) && $normalized !== '') {
        $output = trim($normalized);
    }

    if (function_exists('mb_strlen')) {
        if (mb_strlen($output, 'UTF-8') > $limit) {
            return rtrim(mb_substr($output, 0, $limit, 'UTF-8')) . '…';
        }
        return $output;
    }

    if (strlen($output) > $limit) {
        return rtrim(substr($output, 0, $limit)) . '…';
    }

    return $output;
}

function gov_parser_run_calculate_delta(array $before, array $after): array
{
    $delta = [];

    foreach ($after as $key => $value) {
        if (is_int($value) || is_float($value)) {
            $previous = isset($before[$key]) ? (int)$before[$key] : 0;
            $delta[$key] = (int)$value - $previous;
        }
    }

    foreach ($before as $key => $value) {
        if (!array_key_exists($key, $delta) && (is_int($value) || is_float($value))) {
            $delta[$key] = 0 - (int)$value;
        }
    }

    return $delta;
}
?>

		]]></replacecode>
			<enabled>1</enabled>
		</operation>
	</file>
</dleplugin>